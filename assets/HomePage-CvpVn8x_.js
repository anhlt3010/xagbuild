import{r as Z,c as he,w as Re,a as R,o as U,b as d,d as X,F as be,e as xe,n as te,t as M,f as se,v as Yt,g as ma,h as le,i as He,j as va,k as Ve,l as re,m as Ee,p as ln,q as ce,s as ir,u as un,_ as ya,x as bt}from"./index-BdbE0K4b.js";const ba={class:"space-y-6"},xa={class:"space-y-4"},wa={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ka=["onClick"],Sa={class:"flex items-start justify-between"},Ta={class:"flex-1"},Fa={class:"font-medium text-gray-900"},Ca={class:"mt-2 text-sm text-gray-600 space-y-1"},_a={key:0,class:"flex-shrink-0 ml-3"},Ea={class:"space-y-4"},Ua={class:"flex items-center justify-between mb-4"},La={key:0,class:"w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},Oa={key:0,class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Ba={key:0,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},Ra={class:"text-sm text-blue-800 space-y-1"},Aa={class:"flex justify-end"},Ia=["disabled"],Da={__name:"ChipConfig",props:{modelValue:{type:Object,default:()=>({model:"",display:{width:320,height:240,color:"RGB565"},preset:""})}},emits:["update:modelValue","next"],setup(t,{emit:e}){const r=t,n=e,a=[{id:"lichuang-dev",name:"Lichuang · Phiên bản thực chiến ESP32-S3",chip:"esp32s3",display:{width:320,height:240,color:"RGB565"}},{id:"xingzhi-cube-1.54tft-wifi",name:"Vô Danh Tech · Xingzhi 1.54 TFT",chip:"esp32s3",display:{width:240,height:240,color:"RGB565"}},{id:"atoms3r-echo-base",name:"AtomS3R Echo Base",chip:"esp32s3",display:{width:128,height:128,color:"RGB565"}},{id:"surfer-c3-1.14tft",name:"Surfer C3 1.14 TFT",chip:"esp32c3",display:{width:240,height:135,color:"RGB565"}}],s=Z(!1),i=Z({model:"",display:{width:320,height:240,color:"RGB565"}}),o=he(()=>r.modelValue.preset?!0:i.value.model&&i.value.display.width&&i.value.display.height),l=he(()=>{if(r.modelValue.preset){const p=a.find(y=>y.id===r.modelValue.preset);return(p==null?void 0:p.chip.toUpperCase())||""}return i.value.model.toUpperCase()}),c=he(()=>{if(r.modelValue.preset){const p=a.find(y=>y.id===r.modelValue.preset);return(p==null?void 0:p.display)||{}}return i.value.display}),u=p=>{s.value=!1,n("update:modelValue",{model:p.chip,display:{...p.display},preset:p.id})},f=()=>{s.value=!0,n("update:modelValue",{model:i.value.model,display:{...i.value.display},preset:""})},h=()=>{o.value&&n("next")};return Re(()=>i.value,p=>{s.value&&n("update:modelValue",{model:p.model,display:{...p.display},preset:""})},{deep:!0}),(p,y)=>(U(),R("div",ba,[y[13]||(y[13]=d("div",null,[d("h2",{class:"text-xl font-semibold text-gray-900 mb-4"},"Bước 1: Chọn model chip và cấu hình màn hình"),d("p",{class:"text-gray-600 mb-6"},"Vui lòng chọn cấu hình phần cứng của bạn, hoặc chọn nhanh từ các cấu hình có sẵn.")],-1)),d("div",xa,[y[4]||(y[4]=d("h3",{class:"text-lg font-medium text-gray-900"},"Cấu hình có sẵn（Khuyến nghị）",-1)),d("div",wa,[(U(),R(be,null,xe(a,b=>d("div",{key:b.id,onClick:m=>u(b),class:te(["border-2 rounded-lg p-4 cursor-pointer transition-all",t.modelValue.preset===b.id?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"])},[d("div",Sa,[d("div",Ta,[d("h4",Fa,M(b.name),1),d("div",Ca,[d("div",null,"Chip: "+M(b.chip),1),d("div",null,"Độ phân giải: "+M(b.display.width)+"×"+M(b.display.height),1),d("div",null,"Màu sắc: "+M(b.display.color),1)])]),t.modelValue.preset===b.id?(U(),R("div",_a,[...y[3]||(y[3]=[d("div",{class:"w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},[d("svg",{class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})])],-1)])])):X("",!0)])],10,ka)),64))])]),d("div",Ea,[y[11]||(y[11]=d("h3",{class:"text-lg font-medium text-gray-900"},"Cấu hình tùy chỉnh",-1)),d("div",{onClick:f,class:te(["border-2 rounded-lg p-4 cursor-pointer transition-all",s.value?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"])},[d("div",Ua,[y[6]||(y[6]=d("h4",{class:"font-medium text-gray-900"},"Cấu hình phần cứng tùy chỉnh",-1)),s.value?(U(),R("div",La,[...y[5]||(y[5]=[d("svg",{class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})],-1)])])):X("",!0)]),s.value?(U(),R("div",Oa,[d("div",null,[y[8]||(y[8]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Model chip",-1)),se(d("select",{"onUpdate:modelValue":y[0]||(y[0]=b=>i.value.model=b),class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},[...y[7]||(y[7]=[ma('<option value="">Vui lòng chọn chip</option><option value="esp32s3">ESP32-S3</option><option value="esp32c3">ESP32-C3</option><option value="esp32p4">ESP32-P4</option><option value="esp32c6">ESP32-C6</option>',5)])],512),[[Yt,i.value.model]])]),d("div",null,[y[9]||(y[9]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Chiều rộng màn hình",-1)),se(d("input",{type:"number","onUpdate:modelValue":y[1]||(y[1]=b=>i.value.display.width=b),min:"128",max:"800",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"320"},null,512),[[le,i.value.display.width,void 0,{number:!0}]])]),d("div",null,[y[10]||(y[10]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Chiều cao màn hình",-1)),se(d("input",{type:"number","onUpdate:modelValue":y[2]||(y[2]=b=>i.value.display.height=b),min:"128",max:"600",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"240"},null,512),[[le,i.value.display.height,void 0,{number:!0}]])])])):X("",!0)],2)]),o.value?(U(),R("div",Ba,[y[12]||(y[12]=d("h4",{class:"font-medium text-blue-900 mb-2"},"Xem trước cấu hình hiện tại",-1)),d("div",Ra,[d("div",null,"Model chip: "+M(l.value),1),d("div",null,"Độ phân giải màn hình: "+M(c.value.width)+"×"+M(c.value.height),1),d("div",null,"Định dạng màu: "+M(c.value.color),1)])])):X("",!0),d("div",Aa,[d("button",{onClick:h,disabled:!o.value,class:"bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-lg font-medium transition-colors"}," Tiếp theo ",8,Ia)])]))}},Ma={class:"space-y-6"},Pa={class:"text-gray-600"},Na={key:0,class:"text-blue-600"},Ga={key:1,class:"text-blue-600"},za={class:"space-y-4"},Va={class:"relative"},$a=["value"],Ha=["value"],ja={key:0,class:"bg-green-50 border border-green-200 rounded-lg p-4"},Wa={class:"flex"},Xa={class:"ml-3"},qa={class:"text-sm font-medium text-green-800"},Ya={class:"mt-1 text-sm text-green-700"},Ka={class:"mt-1 text-sm text-green-700"},Za={class:"bg-blue-50 border border-blue-200 rounded-lg p-3"},Ja={class:"text-sm text-blue-800"},Qa={class:"mt-1 list-disc list-inside space-y-1"},es={__name:"WakewordConfig",props:{modelValue:{type:String,default:""},chipModel:{type:String,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){const r=t,n=e,a=[{id:"wn9s_hilexin",name:"Hi,乐鑫",model:"WakeNet9s"},{id:"wn9s_hiesp",name:"Hi,ESP",model:"WakeNet9s"},{id:"wn9s_nihaoxiaozhi",name:"你好小智",model:"WakeNet9s"},{id:"wn9s_hijason_tts2",name:"Hi,Jason",model:"WakeNet9s"},{id:"wn9_hilexin",name:"Hi,乐鑫",model:"WakeNet9"},{id:"wn9_hiesp",name:"Hi,ESP",model:"WakeNet9"},{id:"wn9_nihaoxiaozhi_tts",name:"你好小智",model:"WakeNet9"},{id:"wn9_hijason_tts2",name:"Hi,Jason",model:"WakeNet9"},{id:"wn9_nihaomiaoban_tts2",name:"你好喵伴",model:"WakeNet9"},{id:"wn9_xiaoaitongxue",name:"小爱同学",model:"WakeNet9"},{id:"wn9_himfive",name:"Hi,M Five",model:"WakeNet9"},{id:"wn9_alexa",name:"Alexa",model:"WakeNet9"},{id:"wn9_jarvis_tts",name:"Jarvis",model:"WakeNet9"},{id:"wn9_computer_tts",name:"Computer",model:"WakeNet9"},{id:"wn9_heywillow_tts",name:"Hey,Willow",model:"WakeNet9"},{id:"wn9_sophia_tts",name:"Sophia",model:"WakeNet9"},{id:"wn9_mycroft_tts",name:"Mycroft",model:"WakeNet9"},{id:"wn9_heyprinter_tts",name:"Hey,Printer",model:"WakeNet9"},{id:"wn9_hijoy_tts",name:"Hi,Joy",model:"WakeNet9"},{id:"wn9_heywanda_tts",name:"Hey,Wand",model:"WakeNet9"},{id:"wn9_astrolabe_tts",name:"Astrolabe",model:"WakeNet9"},{id:"wn9_heyily_tts2",name:"Hey,Ily",model:"WakeNet9"},{id:"wn9_hijolly_tts2",name:"Hi,Jolly",model:"WakeNet9"},{id:"wn9_hifairy_tts2",name:"Hi,Fairy",model:"WakeNet9"},{id:"wn9_bluechip_tts2",name:"Blue Chip",model:"WakeNet9"},{id:"wn9_hiandy_tts2",name:"Hi,Andy",model:"WakeNet9"},{id:"wn9_hiwalle_tts2",name:"Hi,Wall E",model:"WakeNet9"},{id:"wn9_nihaoxiaoxin_tts",name:"你好小鑫",model:"WakeNet9"},{id:"wn9_xiaomeitongxue_tts",name:"小美同学",model:"WakeNet9"},{id:"wn9_hixiaoxing_tts",name:"Hi,小星",model:"WakeNet9"},{id:"wn9_xiaolongxiaolong_tts",name:"小龙小龙",model:"WakeNet9"},{id:"wn9_miaomiaotongxue_tts",name:"喵喵同学",model:"WakeNet9"},{id:"wn9_himiaomiao_tts",name:"Hi,喵喵",model:"WakeNet9"},{id:"wn9_hilili_tts",name:"Hi,Lily",model:"WakeNet9"},{id:"wn9_hitelly_tts",name:"Hi,Telly",model:"WakeNet9"},{id:"wn9_xiaobinxiaobin_tts",name:"小滨小滨",model:"WakeNet9"},{id:"wn9_haixiaowu_tts",name:"Hi,小巫",model:"WakeNet9"},{id:"wn9_xiaoyaxiaoya_tts2",name:"小鸭小鸭",model:"WakeNet9"},{id:"wn9_linaiban_tts2",name:"璃奈板",model:"WakeNet9"},{id:"wn9_xiaosurou_tts2",name:"小酥肉",model:"WakeNet9"},{id:"wn9_xiaoyutongxue_tts2",name:"小宇同学",model:"WakeNet9"},{id:"wn9_xiaomingtongxue_tts2",name:"小明同学",model:"WakeNet9"},{id:"wn9_xiaokangtongxue_tts2",name:"小康同学",model:"WakeNet9"},{id:"wn9_xiaojianxiaojian_tts2",name:"小箭小箭",model:"WakeNet9"},{id:"wn9_xiaotexiaote_tts2",name:"小特小特",model:"WakeNet9"},{id:"wn9_nihaoxiaoyi_tts2",name:"你好小益",model:"WakeNet9"},{id:"wn9_nihaobaiying_tts2",name:"你好百应",model:"WakeNet9"},{id:"wn9_xiaoluxiaolu_tts2",name:"小鹿小鹿",model:"WakeNet9"},{id:"wn9_nihaodongdong_tts2",name:"你好东东",model:"WakeNet9"},{id:"wn9_nihaoxiaoan_tts2",name:"你好小安",model:"WakeNet9"},{id:"wn9_ni3hao3xiao3mai4_tts2",name:"你好小脉",model:"WakeNet9"}],s=he(()=>r.chipModel.includes("c3")||r.chipModel.includes("c6")?a.filter(c=>c.model==="WakeNet9s"):a.filter(c=>c.model==="WakeNet9")),i=c=>{if(c===""){n("update:modelValue","");return}r.modelValue===c?n("update:modelValue",""):n("update:modelValue",c)},o=()=>{const c=a.find(u=>u.id===r.modelValue);return(c==null?void 0:c.name)||""},l=()=>{const c=a.find(u=>u.id===r.modelValue);return(c==null?void 0:c.model)||""};return(c,u)=>(U(),R("div",Ma,[d("div",null,[u[2]||(u[2]=d("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Cấu hình từ đánh thức",-1)),d("p",Pa,[u[1]||(u[1]=He(" Chọn mô hình từ đánh thức phù hợp theo loại chip của bạn. ",-1)),t.chipModel.includes("c3")||t.chipModel.includes("c6")?(U(),R("span",Na," Chip của bạn hỗ trợ mô hình WakeNet9s. ")):(U(),R("span",Ga," Chip của bạn hỗ trợ mô hình WakeNet9. "))])]),d("div",za,[u[8]||(u[8]=d("label",{class:"block text-sm font-medium text-gray-700"},"Chọn từ đánh thức",-1)),d("div",Va,[d("select",{value:t.modelValue,onChange:u[0]||(u[0]=f=>i(f.target.value)),class:"w-full border border-gray-300 rounded-md px-3 py-2 pr-10 bg-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},[u[3]||(u[3]=d("option",{value:""},"Vui lòng chọn từ đánh thức (tùy chọn)",-1)),(U(!0),R(be,null,xe(s.value,f=>(U(),R("option",{key:f.id,value:f.id},M(f.name)+" ("+M(f.model)+") ",9,Ha))),128))],40,$a)]),t.modelValue?(U(),R("div",ja,[d("div",Wa,[u[4]||(u[4]=d("div",{class:"flex-shrink-0"},[d("svg",{class:"h-5 w-5 text-green-400",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])],-1)),d("div",Xa,[d("h4",qa," Đã chọn từ đánh thức: "+M(o()),1),d("div",Ya," Loại mô hình: "+M(l()),1),d("div",Ka," Tên tệp: "+M(t.modelValue)+".bin ",1)])])])):X("",!0),d("div",Za,[d("div",Ja,[u[7]||(u[7]=d("strong",null,"Lưu ý:",-1)),d("ul",Qa,[u[5]||(u[5]=d("li",null,"Từ đánh thức là tùy chọn, nếu không cấu hình thì thiết bị sẽ không thể đánh thức bằng giọng nói",-1)),d("li",null,M(t.chipModel.includes("c3")||t.chipModel.includes("c6")?"Chip C3/C6 chỉ hỗ trợ mô hình nhẹ WakeNet9s":"Chip S3/P4 hỗ trợ mô hình đầy đủ WakeNet9, nhiều lựa chọn hơn"),1),u[6]||(u[6]=d("li",null,"Có thể thay đổi hoặc hủy lựa chọn bất cứ lúc nào",-1))])])])])]))}};class ts{constructor(){this.dbName="XiaozhiConfigDB",this.version=1,this.db=null,this.initialized=!1}async initialize(){if(!(this.initialized&&this.db))return new Promise((e,r)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>{console.error("Khởi tạo IndexedDB thất bại:",n.error),r(n.error)},n.onsuccess=()=>{this.db=n.result,this.initialized=!0,console.log("Khởi tạo IndexedDB thành công"),e()},n.onupgradeneeded=a=>{const s=a.target.result;if(s.objectStoreNames.contains("configs")||s.createObjectStore("configs",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1}),!s.objectStoreNames.contains("files")){const i=s.createObjectStore("files",{keyPath:"id"});i.createIndex("type","type",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1})}if(!s.objectStoreNames.contains("temp_data")){const i=s.createObjectStore("temp_data",{keyPath:"key"});i.createIndex("type","type",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1})}console.log("Hoàn thành tạo cấu trúc bảng IndexedDB")}})}async saveConfig(e,r=0,n="wakeword"){this.initialized||await this.initialize();const s={key:"current_config",config:this.sanitizeConfigForStorage(e),currentStep:r,activeThemeTab:n,timestamp:Date.now()};return new Promise((i,o)=>{const u=this.db.transaction(["configs"],"readwrite").objectStore("configs").put(s);u.onerror=()=>{console.error("Lưu cấu hình thất bại:",u.error),o(u.error)},u.onsuccess=()=>{console.log("Đã lưu cấu hình vào IndexedDB"),i()}})}sanitizeConfigForStorage(e){var n,a,s,i,o,l,c,u,f,h;const r=JSON.parse(JSON.stringify(e||{}));try{if(((a=(n=r==null?void 0:r.theme)==null?void 0:n.font)==null?void 0:a.type)==="custom"&&(r.theme.font.custom||(r.theme.font.custom={}),r.theme.font.custom.file=null),((i=(s=r==null?void 0:r.theme)==null?void 0:s.emoji)==null?void 0:i.type)==="custom"){const p=((l=(o=r.theme.emoji)==null?void 0:o.custom)==null?void 0:l.images)||{},y={};Object.keys(p).forEach(b=>{y[b]=null}),r.theme.emoji.custom||(r.theme.emoji.custom={}),r.theme.emoji.custom.images=y}(u=(c=r==null?void 0:r.theme)==null?void 0:c.skin)!=null&&u.light&&(r.theme.skin.light.backgroundImage=null),(h=(f=r==null?void 0:r.theme)==null?void 0:f.skin)!=null&&h.dark&&(r.theme.skin.dark.backgroundImage=null)}catch{}return r}async loadConfig(){return this.initialized||await this.initialize(),new Promise((e,r)=>{const s=this.db.transaction(["configs"],"readonly").objectStore("configs").get("current_config");s.onerror=()=>{console.error("Tải cấu hình thất bại:",s.error),r(s.error)},s.onsuccess=()=>{const i=s.result;i?(console.log("Khôi phục cấu hình từ IndexedDB thành công"),e({config:i.config,currentStep:i.currentStep||0,activeThemeTab:i.activeThemeTab||"wakeword",timestamp:i.timestamp})):e(null)}})}async saveFile(e,r,n,a={}){this.initialized||await this.initialize();const s=await this.fileToArrayBuffer(r);let i={};try{i=a?JSON.parse(JSON.stringify(a)):{}}catch{i={...a}}const o={id:e,type:n,name:r.name,size:r.size,mimeType:r.type,lastModified:r.lastModified,data:s,metadata:i,timestamp:Date.now()};return new Promise((l,c)=>{const h=this.db.transaction(["files"],"readwrite").objectStore("files").put(o);h.onerror=()=>{console.error("Lưu tệp thất bại:",h.error),c(h.error)},h.onsuccess=()=>{console.log(`Tệp ${r.name} đã được lưu vào IndexedDB`),l()}})}async loadFile(e){return this.initialized||await this.initialize(),new Promise((r,n)=>{const i=this.db.transaction(["files"],"readonly").objectStore("files").get(e);i.onerror=()=>{console.error("Tải tệp thất bại:",i.error),n(i.error)},i.onsuccess=()=>{const o=i.result;if(o){const l=new Blob([o.data],{type:o.mimeType}),c=new File([l],o.name,{type:o.mimeType,lastModified:o.lastModified});c.storedId=o.id,c.storedType=o.type,c.storedMetadata=o.metadata,c.storedTimestamp=o.timestamp,console.log(`Tệp ${o.name} đã khôi phục từ IndexedDB thành công`),r(c)}else r(null)}})}async getFilesByType(e){return this.initialized||await this.initialize(),new Promise((r,n)=>{const o=this.db.transaction(["files"],"readonly").objectStore("files").index("type").getAll(e);o.onerror=()=>{console.error("Lấy danh sách tệp thất bại:",o.error),n(o.error)},o.onsuccess=()=>{const c=(o.result||[]).map(u=>{const f=new Blob([u.data],{type:u.mimeType}),h=new File([f],u.name,{type:u.mimeType,lastModified:u.lastModified});return h.storedId=u.id,h.storedType=u.type,h.storedMetadata=u.metadata,h.storedTimestamp=u.timestamp,h});r(c)}})}async saveTempData(e,r,n,a={}){this.initialized||await this.initialize();const s={key:e,type:n,data:r,metadata:a,timestamp:Date.now()};return new Promise((i,o)=>{const u=this.db.transaction(["temp_data"],"readwrite").objectStore("temp_data").put(s);u.onerror=()=>{console.error("Lưu dữ liệu tạm thời thất bại:",u.error),o(u.error)},u.onsuccess=()=>{console.log(`Dữ liệu tạm thời ${e} đã được lưu`),i()}})}async loadTempData(e){return this.initialized||await this.initialize(),new Promise((r,n)=>{const i=this.db.transaction(["temp_data"],"readonly").objectStore("temp_data").get(e);i.onerror=()=>{console.error("Tải dữ liệu tạm thời thất bại:",i.error),n(i.error)},i.onsuccess=()=>{const o=i.result;r(o||null)}})}async clearAll(){this.initialized||await this.initialize();const e=["configs","files","temp_data"];return new Promise((r,n)=>{const a=this.db.transaction(e,"readwrite");let s=0,i=!1;const o=()=>{s++,s===e.length&&(i?n(new Error("Có lỗi xảy ra khi xóa một phần dữ liệu")):(console.log("Đã xóa tất cả dữ liệu lưu trữ"),r()))};e.forEach(l=>{const u=a.objectStore(l).clear();u.onerror=()=>{console.error(`Xóa ${l} thất bại:`,u.error),i=!0,o()},u.onsuccess=()=>{console.log(`Đã xóa ${l}`),o()}})})}async deleteFile(e){return this.initialized||await this.initialize(),new Promise((r,n)=>{const i=this.db.transaction(["files"],"readwrite").objectStore("files").delete(e);i.onerror=()=>{console.error("Xóa tệp thất bại:",i.error),n(i.error)},i.onsuccess=()=>{console.log(`Đã xóa tệp ${e}`),r()}})}async getStorageInfo(){this.initialized||await this.initialize();const e=["configs","files","temp_data"],r={};for(const a of e){const s=await new Promise((i,o)=>{const u=this.db.transaction([a],"readonly").objectStore(a).count();u.onerror=()=>o(u.error),u.onsuccess=()=>i(u.result)});r[a]={count:s}}const n=await this.loadConfig();return r.lastSaved=n?new Date(n.timestamp):null,r}async hasStoredConfig(){try{return await this.loadConfig()!==null}catch(e){return console.error("Lỗi khi kiểm tra cấu hình đã lưu:",e),!1}}fileToArrayBuffer(e){return new Promise((r,n)=>{const a=new FileReader;a.onload=()=>r(a.result),a.onerror=()=>n(new Error("Đọc tệp thất bại")),a.readAsArrayBuffer(e)})}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1,console.log("Đã đóng kết nối IndexedDB"))}}const de=new ts;class et{static async saveFontFile(e,r={}){if(e){const n="custom_font";try{await de.saveFile(n,e,"font",{size:r.size||20,bpp:r.bpp||4,charset:r.charset||"deepseek"}),console.log(`Đã lưu tệp font: ${e.name}`)}catch(a){console.warn(`Không lưu được tệp font: ${e.name}`,a)}}}static async saveEmojiFile(e,r,n={}){var a,s;if(r&&e){const i=`emoji_${e}`;try{const o=((a=n==null?void 0:n.size)==null?void 0:a.width)??64,l=((s=n==null?void 0:n.size)==null?void 0:s.height)??64,c=(n==null?void 0:n.format)??"png";await de.saveFile(i,r,"emoji",{name:e,size:{width:o,height:l},format:c}),console.log(`Đã lưu tệp emoji: ${e} - ${r.name}`)}catch(o){console.warn(`Không lưu được tệp emoji: ${e}`,o)}}}static async saveBackgroundFile(e,r,n={}){if(r&&e){const a=`background_${e}`;try{let s={};try{s=n?JSON.parse(JSON.stringify(n)):{}}catch{s={...n}}await de.saveFile(a,r,"background",{mode:e,...s}),console.log(`Đã lưu tệp nền: ${e} - ${r.name}`)}catch(s){console.warn(`Không lưu được tệp nền: ${e}`,s)}}}static async restoreFontFile(){try{return await de.loadFile("custom_font")}catch(e){return console.warn("Khôi phục tệp font thất bại:",e),null}}static async restoreEmojiFile(e){if(!e)return null;try{const r=`emoji_${e}`;return await de.loadFile(r)}catch(r){return console.warn(`Khôi phục tệp emoji thất bại: ${e}`,r),null}}static async restoreBackgroundFile(e){if(!e)return null;try{const r=`background_${e}`;return await de.loadFile(r)}catch(r){return console.warn(`Khôi phục tệp nền thất bại: ${e}`,r),null}}static async deleteFontFile(){try{await de.deleteFile("custom_font"),console.log("Đã xóa tệp font")}catch(e){console.warn("Xóa tệp font thất bại:",e)}}static async deleteEmojiFile(e){if(e)try{const r=`emoji_${e}`;await de.deleteFile(r),console.log(`Đã xóa tệp emoji: ${e}`)}catch(r){console.warn(`Xóa tệp emoji thất bại: ${e}`,r)}}static async deleteBackgroundFile(e){if(e)try{const r=`background_${e}`;await de.deleteFile(r),console.log(`Đã xóa tệp nền: ${e}`)}catch(r){console.warn(`Xóa tệp nền thất bại: ${e}`,r)}}static async getStorageInfo(){try{return await de.getStorageInfo()}catch(e){return console.warn("Lấy thông tin lưu trữ thất bại:",e),{configs:{count:0},files:{count:0},temp_data:{count:0},lastSaved:null}}}static async clearAllFiles(){try{await de.clearAll(),console.log("Đã xóa tất cả tệp lưu trữ")}catch(e){throw console.warn("Xóa tệp lưu trữ thất bại:",e),e}}}const rs={class:"space-y-6"},ns={class:"space-y-4"},as={class:"flex space-x-4"},ss={key:0,class:"space-y-4"},is={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},os=["onClick"],ls={class:"flex items-start justify-between"},us={class:"flex-1"},cs={class:"font-medium text-gray-900 mb-1"},hs={class:"text-sm text-gray-600 space-y-1"},ds={key:0,class:"flex-shrink-0 ml-3"},fs={key:1,class:"space-y-6"},ps={class:"space-y-2"},gs={key:0},ms={class:"mt-2"},vs={key:1,class:"text-green-600"},ys={class:"mt-1 font-medium"},bs={key:0,class:"grid grid-cols-1 md:grid-cols-3 gap-4"},xs={key:1,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},ws={class:"text-sm text-blue-800 space-y-1"},ks={class:"text-xs text-blue-600 mt-2"},Ss={key:2,class:"bg-green-50 border border-green-200 rounded-lg p-4"},Ts={class:"flex"},Fs={class:"ml-3"},Cs={class:"mt-1 text-sm text-green-700"},_s={__name:"FontConfig",props:{modelValue:{type:Object,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){const r=t,n=e,a=Z(null),s=[{id:"font_puhui_deepseek_14_1",name:"Alibaba PuHuiTi 14px",size:14,bpp:1,charset:"7000 chữ thường dùng",fileSize:"~180KB"},{id:"font_puhui_deepseek_16_4",name:"Alibaba PuHuiTi 16px",size:16,bpp:4,charset:"7000 chữ thường dùng",fileSize:"~720KB"},{id:"font_puhui_deepseek_20_4",name:"Alibaba PuHuiTi 20px",size:20,bpp:4,charset:"7000 chữ thường dùng",fileSize:"~1.1MB"},{id:"font_puhui_deepseek_30_4",name:"Alibaba PuHuiTi 30px",size:30,bpp:4,charset:"7000 chữ thường dùng",fileSize:"~2.5MB"}],i=Z({size:20,bpp:4,charset:"deepseek"}),o=he(()=>r.modelValue.preset||r.modelValue.custom.file),l=m=>{n("update:modelValue",{...r.modelValue,type:m,preset:m==="preset"?r.modelValue.preset:"",custom:{...r.modelValue.custom,file:m==="custom"?r.modelValue.custom.file:null}})},c=m=>{n("update:modelValue",{...r.modelValue,preset:m,custom:{...r.modelValue.custom,file:null}})},u=m=>{const g=m.target.files[0];g&&h(g)},f=m=>{m.preventDefault();const g=m.dataTransfer.files;g.length>0&&h(g[0])},h=async m=>{m&&(m.type.includes("font")||m.name.toLowerCase().match(/\.(ttf|woff|woff2)$/))?(n("update:modelValue",{...r.modelValue,custom:{...r.modelValue.custom,file:m,...i.value}}),await et.saveFontFile(m,i.value)):alert("Vui lòng chọn tệp phông chữ hợp lệ (TTF, WOFF, WOFF2)")},p=async()=>{n("update:modelValue",{...r.modelValue,custom:{...r.modelValue.custom,file:null}}),a.value&&(a.value.value=""),await et.deleteFontFile()},y=()=>{if(r.modelValue.type==="preset"){const m=s.find(g=>g.id===r.modelValue.preset);return m?`Sử dụng phông chữ có sẵn: ${m.name}`:""}else{const m=r.modelValue.custom.file;return m?`Phông chữ tùy chỉnh: ${m.name} (${i.value.size}px, ${i.value.bpp}bpp)`:""}},b=Z(!1);return Re(()=>i.value,m=>{b.value||r.modelValue.type==="custom"&&r.modelValue.custom.file&&n("update:modelValue",{...r.modelValue,custom:{...r.modelValue.custom,...m}})},{deep:!0}),Re(()=>r.modelValue.custom,m=>{m.size&&m.bpp&&m.charset&&(b.value=!0,i.value={size:m.size,bpp:m.bpp,charset:m.charset},va(()=>{b.value=!1}))},{deep:!0,immediate:!0}),(m,g)=>{var w;return U(),R("div",rs,[g[26]||(g[26]=d("div",null,[d("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Cấu hình phông chữ"),d("p",{class:"text-gray-600"},"Chọn phông chữ có sẵn hoặc tải lên tệp phông chữ tùy chỉnh.")],-1)),d("div",ns,[d("div",as,[d("button",{onClick:g[0]||(g[0]=v=>l("preset")),class:te(["px-4 py-2 border rounded-lg transition-colors",t.modelValue.type==="preset"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Phông chữ có sẵn ",2),d("button",{onClick:g[1]||(g[1]=v=>l("custom")),class:te(["px-4 py-2 border rounded-lg transition-colors",t.modelValue.type==="custom"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Phông chữ tùy chỉnh ",2)])]),t.modelValue.type==="preset"?(U(),R("div",ss,[g[9]||(g[9]=d("h4",{class:"font-medium text-gray-900"},"Chọn phông chữ có sẵn",-1)),d("div",is,[(U(),R(be,null,xe(s,v=>d("div",{key:v.id,onClick:S=>c(v.id),class:te(["border-2 rounded-lg p-4 cursor-pointer transition-all",t.modelValue.preset===v.id?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"])},[d("div",ls,[d("div",us,[d("h5",cs,M(v.name),1),d("div",hs,[d("div",null,"Cỡ chữ: "+M(v.size)+"px",1),d("div",null,"Độ sâu bit: "+M(v.bpp)+"bpp",1),d("div",null,"Bộ ký tự: "+M(v.charset),1),d("div",null,"Kích thước tệp: "+M(v.fileSize),1)])]),t.modelValue.preset===v.id?(U(),R("div",ds,[...g[8]||(g[8]=[d("div",{class:"w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},[d("svg",{class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})])],-1)])])):X("",!0)])],10,os)),64))])])):X("",!0),t.modelValue.type==="custom"?(U(),R("div",fs,[g[23]||(g[23]=d("h4",{class:"font-medium text-gray-900"},"Cấu hình phông chữ tùy chỉnh",-1)),d("div",ps,[g[14]||(g[14]=d("label",{class:"block text-sm font-medium text-gray-700"},"Tệp phông chữ",-1)),d("div",{onDrop:f,onDragover:g[3]||(g[3]=Ve(()=>{},["prevent"])),onDragenter:g[4]||(g[4]=Ve(()=>{},["prevent"])),class:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors"},[d("input",{ref_key:"fileInput",ref:a,type:"file",accept:".ttf,.woff,.woff2",onChange:u,class:"hidden"},null,544),t.modelValue.custom.file?(U(),R("div",vs,[g[13]||(g[13]=d("svg",{class:"mx-auto h-8 w-8",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),d("p",ys,M((w=t.modelValue.custom.file)==null?void 0:w.name),1),d("button",{onClick:p,class:"text-red-600 hover:text-red-500 text-sm mt-1"}," Xóa tệp ")])):(U(),R("div",gs,[g[11]||(g[11]=d("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1)),d("div",ms,[d("button",{onClick:g[2]||(g[2]=v=>m.$refs.fileInput.click()),class:"text-primary-600 hover:text-primary-500 font-medium"}," Nhấp để chọn tệp phông chữ "),g[10]||(g[10]=d("p",{class:"text-gray-500"},"hoặc kéo thả tệp vào đây",-1))]),g[12]||(g[12]=d("p",{class:"text-xs text-gray-400 mt-1"},"Hỗ trợ định dạng TTF, WOFF, WOFF2",-1))]))],32)]),t.modelValue.custom.file?(U(),R("div",bs,[d("div",null,[g[15]||(g[15]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Cỡ chữ (px)",-1)),se(d("input",{type:"number","onUpdate:modelValue":g[5]||(g[5]=v=>i.value.size=v),min:"8",max:"80",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},null,512),[[le,i.value.size,void 0,{number:!0}]]),g[16]||(g[16]=d("p",{class:"text-xs text-gray-500 mt-1"},"Phạm vi: 8-80px",-1))]),d("div",null,[g[18]||(g[18]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Độ sâu bit (BPP)",-1)),se(d("select",{"onUpdate:modelValue":g[6]||(g[6]=v=>i.value.bpp=v),class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},[...g[17]||(g[17]=[d("option",{value:1},"1 bpp (đơn sắc)",-1),d("option",{value:2},"2 bpp (4 màu)",-1),d("option",{value:4},"4 bpp (16 màu)",-1)])],512),[[Yt,i.value.bpp]])]),d("div",null,[g[20]||(g[20]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Bộ ký tự",-1)),se(d("select",{"onUpdate:modelValue":g[7]||(g[7]=v=>i.value.charset=v),class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},[...g[19]||(g[19]=[d("option",{value:"deepseek"},"DeepSeek R1 (7405 ký tự)",-1),d("option",{value:"gb2312"},"GB2312 (7445 ký tự)",-1),d("option",{value:"latin"},"Latin1 (190 ký tự)",-1)])],512),[[Yt,i.value.charset]]),g[21]||(g[21]=d("p",{class:"text-xs text-gray-500 mt-1"},"Khuyến nghị sử dụng DeepSeek R1",-1))])])):X("",!0),t.modelValue.custom.file?(U(),R("div",xs,[g[22]||(g[22]=d("h5",{class:"font-medium text-blue-900 mb-2"},"Xem trước cấu hình phông chữ",-1)),d("div",ws,[d("div",null,"Tệp phông chữ: "+M(t.modelValue.custom.file.name),1),d("div",null,"Cỡ chữ: "+M(i.value.size)+"px",1),d("div",null,"Độ sâu bit: "+M(i.value.bpp)+"bpp",1),d("div",null,"Bộ ký tự: "+M(i.value.charset==="deepseek"?"DeepSeek R1":i.value.charset==="gb2312"?"GB2312":i.value.charset==="latin"?"Latin1":i.value.charset),1),d("div",ks," Tên tệp đầu ra: font_custom_"+M(i.value.size)+"_"+M(i.value.bpp)+".bin ",1)])])):X("",!0)])):X("",!0),o.value?(U(),R("div",Ss,[d("div",Ts,[g[25]||(g[25]=d("div",{class:"flex-shrink-0"},[d("svg",{class:"h-5 w-5 text-green-400",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])],-1)),d("div",Fs,[g[24]||(g[24]=d("h4",{class:"text-sm font-medium text-green-800"}," Cấu hình phông chữ hoàn tất ",-1)),d("div",Cs,M(y()),1)])])])):X("",!0)])}}},Es={class:"space-y-6"},Us={class:"space-y-4"},Ls={class:"flex space-x-4"},Os={key:0,class:"space-y-4"},Bs={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Rs=["onClick"],As={class:"flex items-start justify-between mb-3"},Is={class:"font-medium text-gray-900"},Ds={class:"text-sm text-gray-600"},Ms={class:"text-xs text-gray-500 mt-1"},Ps={key:0,class:"flex-shrink-0 ml-3"},Ns={class:"grid grid-cols-7 gap-1 justify-items-center"},Gs=["src","alt"],zs={key:1,class:"space-y-6"},Vs={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},$s={class:"space-y-4"},Hs={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4"},js={class:"text-center"},Ws={class:"text-lg mb-1"},Xs={class:"text-xs text-gray-600"},qs={key:0,class:"text-xs text-red-500"},Ys=["onDrop"],Ks=["onChange"],Zs=["onClick"],Js={key:1,class:"w-full h-full relative"},Qs=["src","alt"],ei=["onClick"],ti={key:2,class:"bg-green-50 border border-green-200 rounded-lg p-4"},ri={class:"flex"},ni={class:"ml-3"},ai={class:"mt-1 text-sm text-green-700"},si={__name:"EmojiConfig",props:{modelValue:{type:Object,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){const r=t,n=e,a=[{id:"twemoji32",name:"Twemoji 32x32",description:"Bộ biểu tượng Twitter, 32×32 pixel",size:32,preview:["neutral","happy","laughing","funny","sad","angry","crying"]},{id:"twemoji64",name:"Twemoji 64x64",description:"Bộ biểu tượng Twitter, 64×64 pixel",size:64,preview:["neutral","happy","laughing","funny","sad","angry","crying"]}],s=[{key:"neutral",name:"Mặc định",emoji:"😶"},{key:"happy",name:"Vui vẻ",emoji:"🙂"},{key:"laughing",name:"Cười lớn",emoji:"😆"},{key:"funny",name:"Hài hước",emoji:"😂"},{key:"sad",name:"Buồn",emoji:"😔"},{key:"angry",name:"Tức giận",emoji:"😠"},{key:"crying",name:"Khóc",emoji:"😭"},{key:"loving",name:"Yêu thích",emoji:"😍"},{key:"embarrassed",name:"Ngượng ngùng",emoji:"😳"},{key:"surprised",name:"Ngạc nhiên",emoji:"😯"},{key:"shocked",name:"Choáng váng",emoji:"😱"},{key:"thinking",name:"Suy nghĩ",emoji:"🤔"},{key:"winking",name:"Nháy mắt",emoji:"😉"},{key:"cool",name:"Ngầu",emoji:"😎"},{key:"relaxed",name:"Thư giãn",emoji:"😌"},{key:"delicious",name:"Ngon",emoji:"🤤"},{key:"kissy",name:"Hôn gió",emoji:"😘"},{key:"confident",name:"Tự tin",emoji:"😏"},{key:"sleepy",name:"Buồn ngủ",emoji:"😴"},{key:"silly",name:"Nghịch ngợm",emoji:"😜"},{key:"confused",name:"Bối rối",emoji:"🙄"}],i=Z({size:{width:32,height:32}}),o=he(()=>r.modelValue.preset||r.modelValue.custom.images.neutral),l=w=>{if(r.modelValue.type===w)return;const v={...r.modelValue,type:w};w==="preset"?(v.preset=r.modelValue.preset||"twemoji32",v.custom={...r.modelValue.custom,images:{}}):w==="custom"&&(v.preset="",v.custom={...r.modelValue.custom,images:r.modelValue.custom.images||{}}),n("update:modelValue",v)},c=w=>{r.modelValue.preset!==w&&n("update:modelValue",{...r.modelValue,preset:w,custom:{...r.modelValue.custom,images:{}}})},u=(w,v)=>{const S=w.target.files[0];S&&h(v,S)},f=(w,v)=>{w.preventDefault();const S=w.dataTransfer.files;S.length>0&&h(v,S[0])},h=async(w,v)=>{const S=["png","gif"],F=v.name.split(".").pop().toLowerCase();S.includes(F)?(n("update:modelValue",{...r.modelValue,custom:{...r.modelValue.custom,size:i.value.size,images:{...r.modelValue.custom.images,[w]:v}}}),await et.saveEmojiFile(w,v,{size:i.value.size,format:F})):alert("Vui lòng chọn hình ảnh định dạng PNG hoặc GIF hợp lệ")},p=async w=>{const v={...r.modelValue.custom.images};delete v[w],n("update:modelValue",{...r.modelValue,custom:{...r.modelValue.custom,images:v}}),await et.deleteEmojiFile(w)},y=(w,v)=>`./static/twemoji${w==="twemoji64"?"64":"32"}/${v}.png`,b=w=>{if(r.modelValue.type==="preset")return y(r.modelValue.preset,w);{const v=r.modelValue.custom.images[w];return v instanceof File||v instanceof Blob?URL.createObjectURL(v):null}},m=w=>{console.warn("Không thể tải hình ảnh biểu tượng:",w.target.src),w.target.style.display="none"},g=()=>{if(r.modelValue.type==="preset"){const w=a.find(v=>v.id===r.modelValue.preset);return w?`Sử dụng bộ biểu tượng có sẵn: ${w.name}`:""}else{const w=Object.keys(r.modelValue.custom.images).length,v=i.value.size;return`Bộ biểu tượng tùy chỉnh: ${w} hình ảnh (${v.width}×${v.height}px)`}};return Re(()=>i.value.size,w=>{if(r.modelValue.type==="custom"){const v=r.modelValue.custom;JSON.stringify(v.size)!==JSON.stringify(w)&&n("update:modelValue",{...r.modelValue,custom:{...v,size:w}})}},{deep:!0}),r.modelValue.custom.size&&(i.value={size:{...r.modelValue.custom.size}}),(w,v)=>(U(),R("div",Es,[v[16]||(v[16]=d("div",null,[d("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Cấu hình bộ biểu tượng cảm xúc"),d("p",{class:"text-gray-600"},"Chọn bộ biểu tượng có sẵn hoặc tùy chỉnh hình ảnh biểu tượng. Mỗi bộ biểu tượng bao gồm 21 biểu cảm khác nhau.")],-1)),d("div",Us,[d("div",Ls,[d("button",{onClick:v[0]||(v[0]=S=>l("preset")),class:te(["px-4 py-2 border rounded-lg transition-colors",t.modelValue.type==="preset"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Bộ biểu tượng có sẵn ",2),d("button",{onClick:v[1]||(v[1]=S=>l("custom")),class:te(["px-4 py-2 border rounded-lg transition-colors",t.modelValue.type==="custom"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Bộ biểu tượng tùy chỉnh ",2)])]),t.modelValue.type==="preset"?(U(),R("div",Os,[v[7]||(v[7]=d("h4",{class:"font-medium text-gray-900"},"Chọn bộ biểu tượng có sẵn",-1)),d("div",Bs,[(U(),R(be,null,xe(a,S=>d("div",{key:S.id,onClick:F=>c(S.id),class:te(["border-2 rounded-lg p-4 cursor-pointer transition-all",t.modelValue.preset===S.id?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"])},[d("div",As,[d("div",null,[d("h5",Is,M(S.name),1),d("p",Ds,M(S.description),1),d("div",Ms," Kích thước: "+M(S.size)+"px × "+M(S.size)+"px ",1)]),t.modelValue.preset===S.id?(U(),R("div",Ps,[...v[6]||(v[6]=[d("div",{class:"w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},[d("svg",{class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})])],-1)])])):X("",!0)]),d("div",Ns,[(U(!0),R(be,null,xe(S.preview,F=>(U(),R("div",{key:F,style:re({width:S.size+"px",height:S.size+"px"}),class:"bg-gray-100 rounded flex items-center justify-center"},[d("img",{src:y(S.id,F),alt:F,style:re({width:S.size+"px",height:S.size+"px"}),class:"object-contain rounded",onError:m},null,44,Gs)],4))),128))])],10,Rs)),64))])])):X("",!0),t.modelValue.type==="custom"?(U(),R("div",zs,[v[13]||(v[13]=d("h4",{class:"font-medium text-gray-900"},"Cấu hình bộ biểu tượng tùy chỉnh",-1)),d("div",Vs,[d("div",null,[v[8]||(v[8]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Chiều rộng hình ảnh (px)",-1)),se(d("input",{type:"number","onUpdate:modelValue":v[2]||(v[2]=S=>i.value.size.width=S),min:"16",max:"200",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},null,512),[[le,i.value.size.width,void 0,{number:!0}]])]),d("div",null,[v[9]||(v[9]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Chiều cao hình ảnh (px)",-1)),se(d("input",{type:"number","onUpdate:modelValue":v[3]||(v[3]=S=>i.value.size.height=S),min:"16",max:"200",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"},null,512),[[le,i.value.size.height,void 0,{number:!0}]])])]),d("div",$s,[v[11]||(v[11]=d("h5",{class:"font-medium text-gray-900"},"Tải lên hình ảnh biểu tượng",-1)),d("div",Hs,[(U(),R(be,null,xe(s,S=>d("div",{key:S.key,class:"space-y-2"},[d("div",js,[d("div",Ws,M(S.emoji),1),d("div",Xs,M(S.name),1),S.key==="neutral"?(U(),R("div",qs,"Bắt buộc")):X("",!0)]),d("div",{onDrop:F=>f(F,S.key),onDragover:v[4]||(v[4]=Ve(()=>{},["prevent"])),onDragenter:v[5]||(v[5]=Ve(()=>{},["prevent"])),class:te(["border-2 border-dashed rounded-lg p-2 text-center cursor-pointer transition-colors aspect-square flex flex-col items-center justify-center",t.modelValue.custom.images[S.key]?"border-green-300 bg-green-50":S.key==="neutral"?"border-red-300 bg-red-50":"border-gray-300 hover:border-gray-400"])},[d("input",{ref_for:!0,ref:S.key+"Input",type:"file",accept:".png,.gif",onChange:F=>u(F,S.key),class:"hidden"},null,40,Ks),t.modelValue.custom.images[S.key]?(U(),R("div",Js,[b(S.key)?(U(),R("img",{key:0,src:b(S.key),alt:S.name,class:"w-full h-full object-cover rounded",onError:m},null,40,Qs)):X("",!0),d("button",{onClick:F=>p(S.key),class:"absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"}," × ",8,ei)])):(U(),R("div",{key:0,onClick:F=>{var B;return(B=w.$refs[S.key+"Input"][0])==null?void 0:B.click()}},[...v[10]||(v[10]=[d("svg",{class:"w-6 h-6 text-gray-400 mx-auto mb-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),d("div",{class:"text-xs text-gray-500"},"Nhấp để tải lên",-1)])],8,Zs))],42,Ys)])),64))]),v[12]||(v[12]=d("div",{class:"text-xs text-gray-500 mt-2"}," * Bắt buộc phải tải lên biểu tượng mặc định (neutral), các biểu tượng khác là tùy chọn. Nếu không tải lên biểu tượng khác, hệ thống sẽ sử dụng biểu tượng mặc định thay thế. ",-1))])])):X("",!0),o.value?(U(),R("div",ti,[d("div",ri,[v[15]||(v[15]=d("div",{class:"flex-shrink-0"},[d("svg",{class:"h-5 w-5 text-green-400",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])],-1)),d("div",ni,[v[14]||(v[14]=d("h4",{class:"text-sm font-medium text-green-800"},"Cấu hình biểu tượng hoàn tất",-1)),d("div",ai,M(g()),1)])])])):X("",!0)]))}},ii={class:"space-y-6"},oi={class:"space-y-4"},li={class:"border border-gray-200 rounded-lg p-4 space-y-4"},ui={class:"flex space-x-4"},ci={key:0,class:"space-y-3"},hi={class:"flex items-center space-x-3"},di={class:"flex items-center space-x-2"},fi={class:"flex items-center space-x-3"},pi={class:"flex items-center space-x-2"},gi={key:1,class:"space-y-3"},mi={key:1,class:"space-y-2"},vi=["src"],yi={class:"text-sm text-green-700 font-medium"},bi={class:"flex items-center space-x-3"},xi={class:"flex items-center space-x-2"},wi={class:"space-y-4"},ki={class:"border border-gray-200 rounded-lg p-4 space-y-4"},Si={class:"flex space-x-4"},Ti={key:0,class:"space-y-3"},Fi={class:"flex items-center space-x-3"},Ci={class:"flex items-center space-x-2"},_i={class:"flex items-center space-x-3"},Ei={class:"flex items-center space-x-2"},Ui={key:1,class:"space-y-3"},Li={key:1,class:"space-y-2"},Oi=["src"],Bi={class:"text-sm text-green-700 font-medium"},Ri={class:"flex items-center space-x-3"},Ai={class:"flex items-center space-x-2"},Ii={class:"space-y-4"},Di={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Mi={class:"space-y-2"},Pi={class:"absolute inset-0 bg-white bg-opacity-10 flex items-center justify-center rounded-lg"},Ni={class:"space-y-2"},Gi={class:"absolute inset-0 bg-black bg-opacity-10 flex items-center justify-center rounded-lg"},zi={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},Vi={class:"flex flex-wrap gap-2"},$i={__name:"BackgroundConfig",props:{modelValue:{type:Object,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){const r=t,n=e,a=Z(null),s=Z(null),i=he({get:()=>r.modelValue.light.backgroundColor,set:T=>h(T)}),o=he({get:()=>r.modelValue.dark.backgroundColor,set:T=>p(T)}),l=he({get:()=>r.modelValue.light.textColor,set:T=>y(T)}),c=he({get:()=>r.modelValue.dark.textColor,set:T=>b(T)}),u=T=>{n("update:modelValue",{...r.modelValue,light:{...r.modelValue.light,backgroundType:T,backgroundImage:T==="image"?r.modelValue.light.backgroundImage:null}})},f=T=>{n("update:modelValue",{...r.modelValue,dark:{...r.modelValue.dark,backgroundType:T,backgroundImage:T==="image"?r.modelValue.dark.backgroundImage:null}})},h=T=>{n("update:modelValue",{...r.modelValue,light:{...r.modelValue.light,backgroundColor:T}})},p=T=>{n("update:modelValue",{...r.modelValue,dark:{...r.modelValue.dark,backgroundColor:T}})},y=T=>{n("update:modelValue",{...r.modelValue,light:{...r.modelValue.light,textColor:T}})},b=T=>{n("update:modelValue",{...r.modelValue,dark:{...r.modelValue.dark,textColor:T}})},m=(T,x)=>{const C=T.target.files[0];C&&w(x,C)},g=(T,x)=>{T.preventDefault();const C=T.dataTransfer.files;C.length>0&&w(x,C[0])},w=async(T,x)=>{x&&x.type.startsWith("image/")?(n("update:modelValue",{...r.modelValue,[T]:{...r.modelValue[T],backgroundImage:x}}),await et.saveBackgroundFile(T,x)):alert("Vui lòng chọn tệp hình ảnh hợp lệ")},v=async T=>{n("update:modelValue",{...r.modelValue,[T]:{...r.modelValue[T],backgroundImage:null}}),T==="light"&&a.value&&(a.value.value=""),T==="dark"&&s.value&&(s.value.value=""),await et.deleteBackgroundFile(T)},S=T=>{const x=r.modelValue[T].backgroundImage;return x?URL.createObjectURL(x):null},F=()=>r.modelValue.light.backgroundType==="image"&&r.modelValue.light.backgroundImage?{backgroundImage:`url(${S("light")})`,backgroundSize:"cover",backgroundPosition:"center"}:{backgroundColor:r.modelValue.light.backgroundColor},B=()=>r.modelValue.dark.backgroundType==="image"&&r.modelValue.dark.backgroundImage?{backgroundImage:`url(${S("dark")})`,backgroundSize:"cover",backgroundPosition:"center"}:{backgroundColor:r.modelValue.dark.backgroundColor},L=(T,x)=>{const C=O(T)?"#000000":"#ffffff",V=O(x)?"#000000":"#ffffff";n("update:modelValue",{...r.modelValue,light:{...r.modelValue.light,backgroundType:"color",backgroundColor:T,textColor:C,backgroundImage:null},dark:{...r.modelValue.dark,backgroundType:"color",backgroundColor:x,textColor:V,backgroundImage:null}})},O=T=>{const x=T.replace("#",""),C=parseInt(x.substr(0,2),16),V=parseInt(x.substr(2,2),16),j=parseInt(x.substr(4,2),16);return(C*299+V*587+j*114)/1e3>128};return(T,x)=>(U(),R("div",ii,[x[49]||(x[49]=d("div",null,[d("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"Cấu hình nền trò chuyện"),d("p",{class:"text-gray-600"},"Cấu hình nền cho chế độ sáng và chế độ tối, hỗ trợ màu trơn hoặc ảnh tùy chỉnh.")],-1)),d("div",oi,[x[38]||(x[38]=d("h4",{class:"font-medium text-gray-900 flex items-center"},[d("svg",{class:"w-5 h-5 mr-2 text-yellow-500",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z","clip-rule":"evenodd"})]),He(" Nền chế độ sáng ")],-1)),d("div",li,[d("div",ui,[d("button",{onClick:x[0]||(x[0]=C=>u("color")),class:te(["px-3 py-2 text-sm border rounded transition-colors",t.modelValue.light.backgroundType==="color"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Màu trơn ",2),d("button",{onClick:x[1]||(x[1]=C=>u("image")),class:te(["px-3 py-2 text-sm border rounded transition-colors",t.modelValue.light.backgroundType==="image"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Hình nền ảnh ",2)]),t.modelValue.light.backgroundType==="color"?(U(),R("div",ci,[d("div",hi,[x[33]||(x[33]=d("label",{class:"text-sm font-medium text-gray-700"},"Màu nền:",-1)),d("div",di,[se(d("input",{type:"color","onUpdate:modelValue":x[2]||(x[2]=C=>i.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,i.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[3]||(x[3]=C=>i.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,i.value]])]),d("div",{style:re({backgroundColor:i.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)]),d("div",fi,[x[34]||(x[34]=d("label",{class:"text-sm font-medium text-gray-700"},"Màu chữ:",-1)),d("div",pi,[se(d("input",{type:"color","onUpdate:modelValue":x[4]||(x[4]=C=>l.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,l.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[5]||(x[5]=C=>l.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,l.value]])]),d("div",{style:re({backgroundColor:l.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)])])):X("",!0),t.modelValue.light.backgroundType==="image"?(U(),R("div",gi,[x[37]||(x[37]=d("label",{class:"text-sm font-medium text-gray-700"},"Ảnh nền:",-1)),d("div",{onDrop:x[9]||(x[9]=C=>g(C,"light")),onDragover:x[10]||(x[10]=Ve(()=>{},["prevent"])),onDragenter:x[11]||(x[11]=Ve(()=>{},["prevent"])),class:te(["border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-colors",t.modelValue.light.backgroundImage?"border-green-300 bg-green-50":"border-gray-300 hover:border-gray-400"])},[d("input",{ref_key:"lightImageInput",ref:a,type:"file",accept:"image/*",onChange:x[6]||(x[6]=C=>m(C,"light")),class:"hidden"},null,544),t.modelValue.light.backgroundImage?(U(),R("div",mi,[d("img",{src:S("light"),alt:"Nền chế độ sáng",class:"max-w-32 max-h-32 mx-auto rounded shadow"},null,8,vi),d("p",yi,M(t.modelValue.light.backgroundImage.name),1),d("button",{onClick:x[8]||(x[8]=C=>v("light")),class:"text-red-600 hover:text-red-500 text-sm"}," Xóa ảnh ")])):(U(),R("div",{key:0,onClick:x[7]||(x[7]=C=>T.$refs.lightImageInput.click())},[...x[35]||(x[35]=[d("svg",{class:"mx-auto h-8 w-8 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1),d("p",{class:"mt-1 text-sm text-gray-600"},"Nhấp hoặc kéo thả để tải ảnh nền",-1)])]))],34),d("div",bi,[x[36]||(x[36]=d("label",{class:"text-sm font-medium text-gray-700"},"文字颜色:",-1)),d("div",xi,[se(d("input",{type:"color","onUpdate:modelValue":x[12]||(x[12]=C=>l.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,l.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[13]||(x[13]=C=>l.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,l.value]])]),d("div",{style:re({backgroundColor:l.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)])])):X("",!0)])]),d("div",wi,[x[44]||(x[44]=d("h4",{class:"font-medium text-gray-900 flex items-center"},[d("svg",{class:"w-5 h-5 mr-2 text-gray-600",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{d:"M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"})]),He(" Nền chế độ tối ")],-1)),d("div",ki,[d("div",Si,[d("button",{onClick:x[14]||(x[14]=C=>f("color")),class:te(["px-3 py-2 text-sm border rounded transition-colors",t.modelValue.dark.backgroundType==="color"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Màu trơn ",2),d("button",{onClick:x[15]||(x[15]=C=>f("image")),class:te(["px-3 py-2 text-sm border rounded transition-colors",t.modelValue.dark.backgroundType==="image"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," Hình nền ảnh ",2)]),t.modelValue.dark.backgroundType==="color"?(U(),R("div",Ti,[d("div",Fi,[x[39]||(x[39]=d("label",{class:"text-sm font-medium text-gray-700"},"Màu nền:",-1)),d("div",Ci,[se(d("input",{type:"color","onUpdate:modelValue":x[16]||(x[16]=C=>o.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,o.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[17]||(x[17]=C=>o.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,o.value]])]),d("div",{style:re({backgroundColor:o.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)]),d("div",_i,[x[40]||(x[40]=d("label",{class:"text-sm font-medium text-gray-700"},"Màu chữ:",-1)),d("div",Ei,[se(d("input",{type:"color","onUpdate:modelValue":x[18]||(x[18]=C=>c.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,c.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[19]||(x[19]=C=>c.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,c.value]])]),d("div",{style:re({backgroundColor:c.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)])])):X("",!0),t.modelValue.dark.backgroundType==="image"?(U(),R("div",Ui,[x[43]||(x[43]=d("label",{class:"text-sm font-medium text-gray-700"},"Ảnh nền:",-1)),d("div",{onDrop:x[23]||(x[23]=C=>g(C,"dark")),onDragover:x[24]||(x[24]=Ve(()=>{},["prevent"])),onDragenter:x[25]||(x[25]=Ve(()=>{},["prevent"])),class:te(["border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-colors",t.modelValue.dark.backgroundImage?"border-green-300 bg-green-50":"border-gray-300 hover:border-gray-400"])},[d("input",{ref_key:"darkImageInput",ref:s,type:"file",accept:"image/*",onChange:x[20]||(x[20]=C=>m(C,"dark")),class:"hidden"},null,544),t.modelValue.dark.backgroundImage?(U(),R("div",Li,[d("img",{src:S("dark"),alt:"Nền chế độ tối",class:"max-w-32 max-h-32 mx-auto rounded shadow"},null,8,Oi),d("p",Bi,M(t.modelValue.dark.backgroundImage.name),1),d("button",{onClick:x[22]||(x[22]=C=>v("dark")),class:"text-red-600 hover:text-red-500 text-sm"}," Xóa ảnh ")])):(U(),R("div",{key:0,onClick:x[21]||(x[21]=C=>T.$refs.darkImageInput.click())},[...x[41]||(x[41]=[d("svg",{class:"mx-auto h-8 w-8 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1),d("p",{class:"mt-1 text-sm text-gray-600"},"Nhấp hoặc kéo thả để tải ảnh nền",-1)])]))],34),d("div",Ri,[x[42]||(x[42]=d("label",{class:"text-sm font-medium text-gray-700"},"Màu chữ:",-1)),d("div",Ai,[se(d("input",{type:"color","onUpdate:modelValue":x[26]||(x[26]=C=>c.value=C),class:"w-10 h-10 border border-gray-300 rounded cursor-pointer"},null,512),[[le,c.value]]),se(d("input",{type:"text","onUpdate:modelValue":x[27]||(x[27]=C=>c.value=C),class:"border border-gray-300 rounded px-3 py-2 text-sm font-mono w-24"},null,512),[[le,c.value]])]),d("div",{style:re({backgroundColor:c.value}),class:"w-16 h-10 border border-gray-300 rounded shadow-inner"},null,4)])])):X("",!0)])]),d("div",Ii,[x[47]||(x[47]=d("h4",{class:"font-medium text-gray-900"},"Khu vực xem trước",-1)),d("div",Di,[d("div",Mi,[x[45]||(x[45]=d("div",{class:"text-sm font-medium text-gray-700"},"Chế độ sáng",-1)),d("div",{style:re(F()),class:"h-32 border border-gray-300 rounded-lg flex items-center justify-center text-sm relative overflow-hidden"},[d("div",Pi,[d("span",{style:re({color:t.modelValue.light.textColor})}," Khu vực nội dung trò chuyện ",4)])],4)]),d("div",Ni,[x[46]||(x[46]=d("div",{class:"text-sm font-medium text-gray-700"},"Chế độ tối",-1)),d("div",{style:re(B()),class:"h-32 border border-gray-300 rounded-lg flex items-center justify-center text-sm relative overflow-hidden"},[d("div",Gi,[d("span",{style:re({color:t.modelValue.dark.textColor})}," Khu vực nội dung trò chuyện ",4)])],4)])])]),d("div",zi,[x[48]||(x[48]=d("h5",{class:"font-medium text-blue-900 mb-2"},"Cấu hình nhanh",-1)),d("div",Vi,[d("button",{onClick:x[28]||(x[28]=C=>L("#ffffff","#1f2937")),class:"px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50"}," Bộ màu mặc định "),d("button",{onClick:x[29]||(x[29]=C=>L("#f5f5f4","#374151")),class:"px-3 py-1 text-sm bg-stone-100 border border-gray-300 rounded hover:bg-stone-200"}," Màu graphite "),d("button",{onClick:x[30]||(x[30]=C=>L("#fef7cd","#7c2d12")),class:"px-3 py-1 text-sm bg-yellow-100 border border-gray-300 rounded hover:bg-yellow-200"}," Bộ màu ấm "),d("button",{onClick:x[31]||(x[31]=C=>L("#e0f2fe","#1e40af")),class:"px-3 py-1 text-sm bg-sky-100 border border-gray-300 rounded hover:bg-sky-200"}," Xanh trời "),d("button",{onClick:x[32]||(x[32]=C=>L("#fdf2f8","#be185d")),class:"px-3 py-1 text-sm bg-pink-100 border border-gray-300 rounded hover:bg-pink-200"}," Hồng lãng mạn ")])])]))}},Hi={class:"space-y-6"},ji={class:"border-b border-gray-200"},Wi={class:"-mb-px flex space-x-8"},Xi=["onClick"],qi={class:"flex items-center"},Yi={key:0,class:"ml-2 w-2 h-2 bg-green-500 rounded-full"},Ki={class:"min-h-96"},Zi={class:"flex justify-between"},Ji=["disabled"],Qi={__name:"ThemeDesign",props:{modelValue:{type:Object,required:!0},chipModel:{type:String,required:!0},activeTab:{type:String,default:"wakeword"}},emits:["update:modelValue","next","prev","tabChange"],setup(t,{emit:e}){const r={render(){return ce("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[ce("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})])}},n={render(){return ce("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 640 640"},[ce("path",{d:"M320 96C329.5 96 338 101.5 341.9 110.2L515.1 496L536 496C549.3 496 560 506.7 560 520C560 533.3 549.3 544 536 544L440 544C426.7 544 416 533.3 416 520C416 506.7 426.7 496 440 496L462.5 496L426.6 416L213.4 416L177.5 496L200 496C213.3 496 224 506.7 224 520C224 533.3 213.3 544 200 544L104 544C90.7 544 80 533.3 80 520C80 506.7 90.7 496 104 496L124.9 496L298.1 110.2C302 101.5 310.5 96 320 96zM320 178.6L235 368L405 368L320 178.6z"})])}},a={render(){return ce("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[ce("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})])}},s={render(){return ce("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 640 640"},[ce("path",{d:"M160 144C151.2 144 144 151.2 144 160L144 480C144 488.8 151.2 496 160 496L480 496C488.8 496 496 488.8 496 480L496 160C496 151.2 488.8 144 480 144L160 144zM96 160C96 124.7 124.7 96 160 96L480 96C515.3 96 544 124.7 544 160L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 160zM224 192C241.7 192 256 206.3 256 224C256 241.7 241.7 256 224 256C206.3 256 192 241.7 192 224C192 206.3 206.3 192 224 192zM360 264C368.5 264 376.4 268.5 380.7 275.8L460.7 411.8C465.1 419.2 465.1 428.4 460.8 435.9C456.5 443.4 448.6 448 440 448L200 448C191.1 448 182.8 443 178.7 435.1C174.6 427.2 175.2 417.6 180.3 410.3L236.3 330.3C240.8 323.9 248.1 320.1 256 320.1C263.9 320.1 271.2 323.9 275.7 330.3L292.9 354.9L339.4 275.9C343.7 268.6 351.6 264.1 360.1 264.1z"})])}},i=t,o=e,l=Z(i.activeTab),c=[{id:"wakeword",name:"Cấu hình từ đánh thức",icon:r},{id:"font",name:"Cấu hình font chữ",icon:n},{id:"emoji",name:"Bộ biểu tượng",icon:a},{id:"background",name:"Nền trò chuyện",icon:s}],u=he({get:()=>i.modelValue,set:b=>o("update:modelValue",b)}),f=b=>{switch(b){case"wakeword":return!!u.value.wakeword;case"font":return u.value.font.preset||u.value.font.custom.file;case"emoji":return u.value.emoji.preset||Object.keys(u.value.emoji.custom.images).length>0;case"background":return!0;default:return!1}},h=he(()=>{const b=u.value.font.preset||u.value.font.custom.file,m=u.value.emoji.preset||Object.keys(u.value.emoji.custom.images).length>0;return b&&m}),p=()=>{h.value&&o("next")},y=b=>{l.value=b,o("tabChange",b)};return Re(()=>i.activeTab,b=>{l.value=b}),(b,m)=>(U(),R("div",Hi,[m[5]||(m[5]=d("div",null,[d("h2",{class:"text-xl font-semibold text-gray-900 mb-4"},"Bước 2: Thiết kế giao diện"),d("p",{class:"text-gray-600 mb-6"},"Cấu hình từ đánh thức, font chữ, biểu tượng cảm xúc và nền để tùy chỉnh giao diện AI Tiểu Trí của bạn.")],-1)),d("div",ji,[d("nav",Wi,[(U(),R(be,null,xe(c,g=>d("button",{key:g.id,onClick:w=>y(g.id),class:te(["py-2 px-1 border-b-2 font-medium text-sm",l.value===g.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])},[d("span",qi,[(U(),Ee(ln(g.icon),{class:"w-5 h-5 mr-2"})),He(" "+M(g.name)+" ",1),f(g.id)?(U(),R("span",Yi)):X("",!0)])],10,Xi)),64))])]),d("div",Ki,[l.value==="wakeword"?(U(),Ee(es,{key:0,modelValue:u.value.wakeword,"onUpdate:modelValue":m[0]||(m[0]=g=>u.value.wakeword=g),chipModel:t.chipModel},null,8,["modelValue","chipModel"])):X("",!0),l.value==="font"?(U(),Ee(_s,{key:1,modelValue:u.value.font,"onUpdate:modelValue":m[1]||(m[1]=g=>u.value.font=g)},null,8,["modelValue"])):X("",!0),l.value==="emoji"?(U(),Ee(si,{key:2,modelValue:u.value.emoji,"onUpdate:modelValue":m[2]||(m[2]=g=>u.value.emoji=g)},null,8,["modelValue"])):X("",!0),l.value==="background"?(U(),Ee($i,{key:3,modelValue:u.value.skin,"onUpdate:modelValue":m[3]||(m[3]=g=>u.value.skin=g)},null,8,["modelValue"])):X("",!0)]),d("div",Zi,[d("button",{onClick:m[4]||(m[4]=g=>b.$emit("prev")),class:"bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors"}," Bước trước "),d("button",{onClick:p,disabled:!h.value,class:"bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-lg font-medium transition-colors"}," Bước tiếp theo ",8,Ji)])]))}},eo=(t,e)=>{const r=t.__vccOpts||t;for(const[n,a]of e)r[n]=a;return r},to={class:"space-y-6"},ro={class:"flex flex-col lg:flex-row gap-8"},no={class:"flex-1"},ao={class:"bg-gray-100 p-4 rounded-lg"},so={class:"max-w-full overflow-auto flex justify-center"},io={class:"bg-gray-800 p-6 rounded-2xl shadow-2xl inline-block"},oo={class:"bg-gray-900 p-2 rounded-xl"},lo={class:"relative z-10 flex flex-col items-center justify-center p-4 text-center"},uo={class:"mb-4"},co={key:0,class:"emoji-container"},ho=["src","alt"],fo={key:1,class:"emoji-container"},po={key:0,class:"absolute inset-0 flex items-center justify-center"},go={class:"mt-3 text-center text-xs text-gray-400"},mo={class:"w-full lg:w-80"},vo={class:"space-y-6 bg-white border border-gray-200 rounded-lg p-4"},yo={key:0,class:"flex flex-wrap gap-2 max-h-32 overflow-y-auto justify-center"},bo=["onClick","title"],xo={key:0},wo=["src","alt"],ko={key:1,class:"text-lg"},So={key:1,class:"text-center py-4 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed"},To={class:"flex space-x-2"},Fo={class:"border-t pt-4"},Co={class:"text-xs text-gray-600 space-y-1"},_o={key:0},Eo={class:"flex items-center"},Uo={key:0,class:"ml-2 animate-pulse text-blue-500"},Lo={key:1,class:"ml-2 text-green-500"},Oo={class:"flex justify-between"},Bo={__name:"GenerateSummary",props:{config:{type:Object,required:!0}},emits:["prev","generate"],setup(t){const e=t,r=Z("Xin chào, tôi là người bạn tốt của bạn Tiểu Trí!"),n=Z("happy"),a=Z("light"),s=Z(!1),i=Z(""),o=[{key:"neutral",name:"Mặc định",emoji:"😶"},{key:"happy",name:"Vui vẻ",emoji:"🙂"},{key:"laughing",name:"Cười lớn",emoji:"😆"},{key:"funny",name:"Hài hước",emoji:"😂"},{key:"sad",name:"Buồn bã",emoji:"😔"},{key:"angry",name:"Tức giận",emoji:"😠"},{key:"crying",name:"Khóc",emoji:"😭"},{key:"loving",name:"Yêu thích",emoji:"😍"},{key:"surprised",name:"Ngạc nhiên",emoji:"😯"},{key:"thinking",name:"Suy nghĩ",emoji:"🤔"},{key:"cool",name:"Ngầu",emoji:"😎"},{key:"sleepy",name:"Buồn ngủ",emoji:"😴"}],l=he(()=>{if(e.config.theme.emoji.type==="preset"&&e.config.theme.emoji.preset)return o;if(e.config.theme.emoji.type==="custom"){const T=e.config.theme.emoji.custom.images;return o.filter(x=>T[x.key])}else return[]}),c=he(()=>m(n.value)),u=()=>{const{width:T,height:x}=e.config.chip.display;return{width:`${T}px`,height:`${x}px`}},f=()=>{const T=e.config.theme.skin[a.value];if(T.backgroundType==="image"&&T.backgroundImage)try{if(T.backgroundImage&&typeof T.backgroundImage=="object"&&T.backgroundImage.size)return{backgroundImage:`url(${URL.createObjectURL(T.backgroundImage)})`,backgroundSize:"cover",backgroundPosition:"center"}}catch(x){console.warn("Tải xem trước hình nền thất bại:",x)}return{backgroundColor:T.backgroundColor||"#ffffff"}},h=()=>{let T=48;return e.config.theme.emoji.type==="preset"?T=e.config.theme.emoji.preset==="twemoji64"?64:32:e.config.theme.emoji.custom.size&&(T=Math.min(e.config.theme.emoji.custom.size.width,e.config.theme.emoji.custom.size.height)),{width:`${T}px`,height:`${T}px`}},p=()=>{let T=14;if(e.config.theme.font.type==="preset"){const C=e.config.theme.font.preset;C.includes("_14_")?T=14:C.includes("_16_")?T=16:C.includes("_20_")?T=20:C.includes("_30_")&&(T=30)}else e.config.theme.font.custom.size&&(T=e.config.theme.font.custom.size);const x=a.value==="dark"?e.config.theme.skin.dark.textColor:e.config.theme.skin.light.textColor;return{fontSize:`${T}px`,color:x,fontFamily:b(),textShadow:a.value==="dark"?"1px 1px 2px rgba(0,0,0,0.5)":"1px 1px 2px rgba(255,255,255,0.5)"}},y=async()=>{document.querySelectorAll("style[data-font-preview]").forEach(x=>x.remove()),s.value=!1,i.value="";try{if(e.config.theme.font.type==="preset"){const x="PuHuiPreview",C="./static/fonts/puhui_deepseek.ttf",V=document.createElement("style");V.setAttribute("data-font-preview","true"),V.textContent=`
        @font-face {
          font-family: '${x}';
          src: url('${C}') format('truetype');
          font-display: swap;
        }
      `,document.head.appendChild(V),await document.fonts.load(`16px "${x}"`),i.value=x,s.value=!0}else if(e.config.theme.font.custom.file)try{const x=e.config.theme.font.custom.file;if(!x||typeof x!="object"||!x.size)throw new Error("Đối tượng tệp font không hợp lệ");const C="CustomFontPreview",V=URL.createObjectURL(x),j=document.createElement("style");j.setAttribute("data-font-preview","true"),j.textContent=`
          @font-face {
            font-family: '${C}';
            src: url('${V}');
            font-display: swap;
          }
        `,document.head.appendChild(j),await document.fonts.load(`16px "${C}"`),i.value=C,s.value=!0}catch(x){console.warn("Tải xem trước font tùy chỉnh thất bại:",x),i.value="Arial, sans-serif",s.value=!0}else i.value="system-ui",s.value=!0}catch(x){console.warn("Tải font thất bại:",x),i.value="system-ui",s.value=!0}},b=()=>s.value&&i.value?`"${i.value}", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif`:'"PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif',m=T=>{if(e.config.theme.emoji.type==="preset")return`./static/twemoji${e.config.theme.emoji.preset==="twemoji64"?"64":"32"}/${T}.png`;if(e.config.theme.emoji.type==="custom"&&e.config.theme.emoji.custom.images[T])try{const x=e.config.theme.emoji.custom.images[T];if(x&&typeof x=="object"&&x.size)return URL.createObjectURL(x)}catch(x){console.warn(`Tải xem trước hình biểu tượng thất bại (${T}):`,x)}return null},g=T=>{const x=o.find(C=>C.key===T);return x?x.emoji:"😶"},w=()=>{if(e.config.theme.emoji.type==="preset")return(e.config.theme.emoji.preset==="twemoji64"?64:32)+16;if(e.config.theme.emoji.custom.size){const T=Math.min(e.config.theme.emoji.custom.size.width,e.config.theme.emoji.custom.size.height);return Math.min(T+16,64)}return 48},v=()=>e.config.theme.emoji.type==="preset"?e.config.theme.emoji.preset==="twemoji64"?64:32:e.config.theme.emoji.custom.size?Math.min(e.config.theme.emoji.custom.size.width,e.config.theme.emoji.custom.size.height,48):32,S=T=>{n.value=T},F=()=>({wn9s_hilexin:"Hi,Lexin",wn9s_hiesp:"Hi,ESP",wn9s_nihaoxiaozhi:"Xin chào Tiểu Trí",wn9_nihaoxiaozhi_tts:"Xin chào Tiểu Trí",wn9_alexa:"Alexa",wn9_jarvis_tts:"Jarvis"})[e.config.theme.wakeword]||e.config.theme.wakeword,B=()=>e.config.theme.font.type==="preset"?{font_puhui_deepseek_14_1:"PuHui 14px",font_puhui_deepseek_16_4:"PuHui 16px",font_puhui_deepseek_20_4:"PuHui 20px",font_puhui_deepseek_30_4:"PuHui 30px"}[e.config.theme.font.preset]||e.config.theme.font.preset:`Font tùy chỉnh ${e.config.theme.font.custom.size}px`,L=()=>e.config.theme.emoji.type==="preset"&&e.config.theme.emoji.preset?e.config.theme.emoji.preset==="twemoji64"?"Twemoji 64×64":"Twemoji 32×32":e.config.theme.emoji.type==="custom"?`Biểu tượng tùy chỉnh ${Object.keys(e.config.theme.emoji.custom.images).length} ảnh`:"Chưa cấu hình",O=()=>{const T=e.config.theme.skin.light.backgroundType==="image"?"Hình ảnh":"Màu",x=e.config.theme.skin.dark.backgroundType==="image"?"Hình ảnh":"Màu";return`Sáng ${T}/Tối ${x}`};return Re(()=>e.config.theme.font,()=>{y()},{deep:!0}),ir(async()=>{l.value.length>0?n.value=l.value[0].key:n.value="",await y()}),un(()=>{document.querySelectorAll("style[data-font-preview]").forEach(x=>x.remove())}),(T,x)=>(U(),R("div",to,[x[15]||(x[15]=d("div",null,[d("h2",{class:"text-xl font-semibold text-gray-900 mb-4"},"Bước 3: Xem trước hiệu ứng"),d("p",{class:"text-gray-600 mb-6"},"Xem trước cấu hình tùy chỉnh của bạn trên thiết bị thực tế.")],-1)),d("div",ro,[d("div",no,[x[7]||(x[7]=d("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Xem trước thiết bị (Tỷ lệ pixel 1:1)",-1)),d("div",ao,[d("div",so,[d("div",io,[d("div",oo,[d("div",{style:re(u()),class:"relative rounded-lg overflow-hidden border-2 border-gray-700 flex flex-col items-center justify-center"},[d("div",{style:re(f()),class:"absolute inset-0"},null,4),d("div",lo,[d("div",uo,[n.value&&l.value.length>0?(U(),R("div",co,[c.value?(U(),R("img",{key:0,src:c.value,alt:n.value,style:re(h()),class:"emoji-image"},null,12,ho)):(U(),R("div",{key:1,style:re(h()),class:"emoji-fallback bg-gray-200 rounded-full flex items-center justify-center text-2xl"},M(g(n.value)),5))])):(U(),R("div",fo,[d("div",{style:re(h()),class:"emoji-placeholder flex items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded bg-gray-50"},[...x[5]||(x[5]=[d("div",{class:"text-center"},[d("div",{class:"text-sm"},"😕"),d("div",{class:"text-xs"},"Chưa cấu hình biểu tượng")],-1)])],4)]))]),d("div",{style:re(p()),class:"text-message max-w-full break-words relative"},[s.value?X("",!0):(U(),R("div",po,[...x[6]||(x[6]=[d("div",{class:"animate-pulse text-gray-400 text-xs"},"Đang tải font chữ...",-1)])])),d("div",{class:te({"opacity-0":!s.value})},M(r.value),3)],4)])],4)]),d("div",go,M(t.config.chip.display.width)+" × "+M(t.config.chip.display.height)+" "+M(t.config.chip.model.toUpperCase()),1)])])])]),d("div",mo,[x[13]||(x[13]=d("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Cài đặt xem trước",-1)),d("div",vo,[d("div",null,[x[8]||(x[8]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Văn bản xem trước",-1)),se(d("textarea",{"onUpdate:modelValue":x[0]||(x[0]=C=>r.value=C),class:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",rows:"3",placeholder:"Xin chào, tôi là người bạn tốt của bạn Tiểu Trí!"},null,512),[[le,r.value]])]),d("div",null,[x[10]||(x[10]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Biểu tượng cảm xúc hiện tại",-1)),l.value.length>0?(U(),R("div",yo,[(U(!0),R(be,null,xe(l.value,C=>(U(),R("button",{key:C.key,onClick:V=>S(C.key),class:te(["p-2 border rounded transition-colors flex items-center justify-center",n.value===C.key?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"]),title:C.name,style:re({width:w()+"px",height:w()+"px"})},[m(C.key)?(U(),R("div",xo,[d("img",{src:m(C.key),alt:C.name,style:re({width:v()+"px",height:v()+"px"}),class:"object-contain rounded"},null,12,wo)])):(U(),R("div",ko,M(C.emoji),1))],14,bo))),128))])):(U(),R("div",So,[...x[9]||(x[9]=[d("div",{class:"text-2xl mb-2"},"😕",-1),d("div",{class:"text-sm"},"Vui lòng cấu hình gói biểu tượng trong thiết kế giao diện trước",-1)])]))]),d("div",null,[x[11]||(x[11]=d("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Chế độ giao diện",-1)),d("div",To,[d("button",{onClick:x[1]||(x[1]=C=>a.value="light"),class:te(["flex-1 py-2 px-3 text-sm border rounded transition-colors",a.value==="light"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," 🌞 Sáng ",2),d("button",{onClick:x[2]||(x[2]=C=>a.value="dark"),class:te(["flex-1 py-2 px-3 text-sm border rounded transition-colors",a.value==="dark"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-300 hover:border-gray-400"])}," 🌙 Tối ",2)])]),d("div",Fo,[x[12]||(x[12]=d("h4",{class:"font-medium text-gray-900 mb-2"},"Tóm tắt cấu hình",-1)),d("div",Co,[t.config.theme.wakeword?(U(),R("div",_o,"Từ đánh thức: "+M(F()),1)):X("",!0),d("div",Eo,[d("span",null,"Font chữ: "+M(B()),1),s.value?(U(),R("span",Lo,"✓")):(U(),R("span",Uo,"Đang tải..."))]),d("div",null,"Biểu tượng: "+M(L()),1),d("div",null,"Giao diện: "+M(O()),1)])])])])]),d("div",Oo,[d("button",{onClick:x[3]||(x[3]=C=>T.$emit("prev")),class:"bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors"}," Bước trước "),d("button",{onClick:x[4]||(x[4]=C=>T.$emit("generate")),class:"bg-green-500 hover:bg-green-600 text-white px-8 py-2 rounded-lg font-medium transition-colors flex items-center"},[...x[14]||(x[14]=[d("svg",{class:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1),He(" Tạo assets.bin ",-1)])])])]))}},Ro=eo(Bo,[["__scopeId","data-v-cfd25286"]]);/*! https://mths.be/codepointat v0.2.0 by @mathias */String.prototype.codePointAt||function(){var t=function(){try{var r={},n=Object.defineProperty,a=n(r,r,r)&&n}catch{}return a}(),e=function(r){if(this==null)throw TypeError();var n=String(this),a=n.length,s=r?Number(r):0;if(s!=s&&(s=0),!(s<0||s>=a)){var i=n.charCodeAt(s),o;return i>=55296&&i<=56319&&a>s+1&&(o=n.charCodeAt(s+1),o>=56320&&o<=57343)?(i-55296)*1024+o-56320+65536:i}};t?t(String.prototype,"codePointAt",{value:e,configurable:!0,writable:!0}):String.prototype.codePointAt=e}();var or=0,cn=-3;function ot(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)}function Ao(t,e){this.source=t,this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=e,this.destLen=0,this.ltree=new ot,this.dtree=new ot}var hn=new ot,dn=new ot,lr=new Uint8Array(30),ur=new Uint16Array(30),fn=new Uint8Array(30),pn=new Uint16Array(30),Io=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),xr=new ot,Ce=new Uint8Array(320);function gn(t,e,r,n){var a,s;for(a=0;a<r;++a)t[a]=0;for(a=0;a<30-r;++a)t[a+r]=a/r|0;for(s=n,a=0;a<30;++a)e[a]=s,s+=1<<t[a]}function Do(t,e){var r;for(r=0;r<7;++r)t.table[r]=0;for(t.table[7]=24,t.table[8]=152,t.table[9]=112,r=0;r<24;++r)t.trans[r]=256+r;for(r=0;r<144;++r)t.trans[24+r]=r;for(r=0;r<8;++r)t.trans[168+r]=280+r;for(r=0;r<112;++r)t.trans[176+r]=144+r;for(r=0;r<5;++r)e.table[r]=0;for(e.table[5]=32,r=0;r<32;++r)e.trans[r]=r}var wr=new Uint16Array(16);function Nt(t,e,r,n){var a,s;for(a=0;a<16;++a)t.table[a]=0;for(a=0;a<n;++a)t.table[e[r+a]]++;for(t.table[0]=0,s=0,a=0;a<16;++a)wr[a]=s,s+=t.table[a];for(a=0;a<n;++a)e[r+a]&&(t.trans[wr[e[r+a]]++]=a)}function Mo(t){t.bitcount--||(t.tag=t.source[t.sourceIndex++],t.bitcount=7);var e=t.tag&1;return t.tag>>>=1,e}function _e(t,e,r){if(!e)return r;for(;t.bitcount<24;)t.tag|=t.source[t.sourceIndex++]<<t.bitcount,t.bitcount+=8;var n=t.tag&65535>>>16-e;return t.tag>>>=e,t.bitcount-=e,n+r}function Kt(t,e){for(;t.bitcount<24;)t.tag|=t.source[t.sourceIndex++]<<t.bitcount,t.bitcount+=8;var r=0,n=0,a=0,s=t.tag;do n=2*n+(s&1),s>>>=1,++a,r+=e.table[a],n-=e.table[a];while(n>=0);return t.tag=s,t.bitcount-=a,e.trans[r+n]}function Po(t,e,r){var n,a,s,i,o,l;for(n=_e(t,5,257),a=_e(t,5,1),s=_e(t,4,4),i=0;i<19;++i)Ce[i]=0;for(i=0;i<s;++i){var c=_e(t,3,0);Ce[Io[i]]=c}for(Nt(xr,Ce,0,19),o=0;o<n+a;){var u=Kt(t,xr);switch(u){case 16:var f=Ce[o-1];for(l=_e(t,2,3);l;--l)Ce[o++]=f;break;case 17:for(l=_e(t,3,3);l;--l)Ce[o++]=0;break;case 18:for(l=_e(t,7,11);l;--l)Ce[o++]=0;break;default:Ce[o++]=u;break}}Nt(e,Ce,0,n),Nt(r,Ce,n,a)}function kr(t,e,r){for(;;){var n=Kt(t,e);if(n===256)return or;if(n<256)t.dest[t.destLen++]=n;else{var a,s,i,o;for(n-=257,a=_e(t,lr[n],ur[n]),s=Kt(t,r),i=t.destLen-_e(t,fn[s],pn[s]),o=i;o<i+a;++o)t.dest[t.destLen++]=t.dest[o]}}}function No(t){for(var e,r,n;t.bitcount>8;)t.sourceIndex--,t.bitcount-=8;if(e=t.source[t.sourceIndex+1],e=256*e+t.source[t.sourceIndex],r=t.source[t.sourceIndex+3],r=256*r+t.source[t.sourceIndex+2],e!==(~r&65535))return cn;for(t.sourceIndex+=4,n=e;n;--n)t.dest[t.destLen++]=t.source[t.sourceIndex++];return t.bitcount=0,or}function Go(t,e){var r=new Ao(t,e),n,a,s;do{switch(n=Mo(r),a=_e(r,2,0),a){case 0:s=No(r);break;case 1:s=kr(r,hn,dn);break;case 2:Po(r,r.ltree,r.dtree),s=kr(r,r.ltree,r.dtree);break;default:s=cn}if(s!==or)throw new Error("Data error")}while(!n);return r.destLen<r.dest.length?typeof r.dest.slice=="function"?r.dest.slice(0,r.destLen):r.dest.subarray(0,r.destLen):r.dest}Do(hn,dn);gn(lr,ur,4,3);gn(fn,pn,2,1);lr[28]=0;ur[28]=258;var zo=Go;function Je(t,e,r,n,a){return Math.pow(1-a,3)*t+3*Math.pow(1-a,2)*a*e+3*(1-a)*Math.pow(a,2)*r+Math.pow(a,3)*n}function Me(){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN}Me.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)};Me.prototype.addPoint=function(t,e){typeof t=="number"&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=t,this.x2=t),t<this.x1&&(this.x1=t),t>this.x2&&(this.x2=t)),typeof e=="number"&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=e,this.y2=e),e<this.y1&&(this.y1=e),e>this.y2&&(this.y2=e))};Me.prototype.addX=function(t){this.addPoint(t,null)};Me.prototype.addY=function(t){this.addPoint(null,t)};Me.prototype.addBezier=function(t,e,r,n,a,s,i,o){var l=[t,e],c=[r,n],u=[a,s],f=[i,o];this.addPoint(t,e),this.addPoint(i,o);for(var h=0;h<=1;h++){var p=6*l[h]-12*c[h]+6*u[h],y=-3*l[h]+9*c[h]-9*u[h]+3*f[h],b=3*c[h]-3*l[h];if(y===0){if(p===0)continue;var m=-b/p;0<m&&m<1&&(h===0&&this.addX(Je(l[h],c[h],u[h],f[h],m)),h===1&&this.addY(Je(l[h],c[h],u[h],f[h],m)));continue}var g=Math.pow(p,2)-4*b*y;if(!(g<0)){var w=(-p+Math.sqrt(g))/(2*y);0<w&&w<1&&(h===0&&this.addX(Je(l[h],c[h],u[h],f[h],w)),h===1&&this.addY(Je(l[h],c[h],u[h],f[h],w)));var v=(-p-Math.sqrt(g))/(2*y);0<v&&v<1&&(h===0&&this.addX(Je(l[h],c[h],u[h],f[h],v)),h===1&&this.addY(Je(l[h],c[h],u[h],f[h],v)))}}};Me.prototype.addQuad=function(t,e,r,n,a,s){var i=t+.6666666666666666*(r-t),o=e+2/3*(n-e),l=i+1/3*(a-t),c=o+1/3*(s-e);this.addBezier(t,e,i,o,l,c,a,s)};function oe(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1}oe.prototype.moveTo=function(t,e){this.commands.push({type:"M",x:t,y:e})};oe.prototype.lineTo=function(t,e){this.commands.push({type:"L",x:t,y:e})};oe.prototype.curveTo=oe.prototype.bezierCurveTo=function(t,e,r,n,a,s){this.commands.push({type:"C",x1:t,y1:e,x2:r,y2:n,x:a,y:s})};oe.prototype.quadTo=oe.prototype.quadraticCurveTo=function(t,e,r,n){this.commands.push({type:"Q",x1:t,y1:e,x:r,y:n})};oe.prototype.close=oe.prototype.closePath=function(){this.commands.push({type:"Z"})};oe.prototype.extend=function(t){if(t.commands)t=t.commands;else if(t instanceof Me){var e=t;this.moveTo(e.x1,e.y1),this.lineTo(e.x2,e.y1),this.lineTo(e.x2,e.y2),this.lineTo(e.x1,e.y2),this.close();return}Array.prototype.push.apply(this.commands,t)};oe.prototype.getBoundingBox=function(){for(var t=new Me,e=0,r=0,n=0,a=0,s=0;s<this.commands.length;s++){var i=this.commands[s];switch(i.type){case"M":t.addPoint(i.x,i.y),e=n=i.x,r=a=i.y;break;case"L":t.addPoint(i.x,i.y),n=i.x,a=i.y;break;case"Q":t.addQuad(n,a,i.x1,i.y1,i.x,i.y),n=i.x,a=i.y;break;case"C":t.addBezier(n,a,i.x1,i.y1,i.x2,i.y2,i.x,i.y),n=i.x,a=i.y;break;case"Z":n=e,a=r;break;default:throw new Error("Unexpected path command "+i.type)}}return t.isEmpty()&&t.addPoint(0,0),t};oe.prototype.draw=function(t){t.beginPath();for(var e=0;e<this.commands.length;e+=1){var r=this.commands[e];r.type==="M"?t.moveTo(r.x,r.y):r.type==="L"?t.lineTo(r.x,r.y):r.type==="C"?t.bezierCurveTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y):r.type==="Q"?t.quadraticCurveTo(r.x1,r.y1,r.x,r.y):r.type==="Z"&&t.closePath()}this.fill&&(t.fillStyle=this.fill,t.fill()),this.stroke&&(t.strokeStyle=this.stroke,t.lineWidth=this.strokeWidth,t.stroke())};oe.prototype.toPathData=function(t){t=t!==void 0?t:2;function e(i){return Math.round(i)===i?""+Math.round(i):i.toFixed(t)}function r(){for(var i=arguments,o="",l=0;l<arguments.length;l+=1){var c=i[l];c>=0&&l>0&&(o+=" "),o+=e(c)}return o}for(var n="",a=0;a<this.commands.length;a+=1){var s=this.commands[a];s.type==="M"?n+="M"+r(s.x,s.y):s.type==="L"?n+="L"+r(s.x,s.y):s.type==="C"?n+="C"+r(s.x1,s.y1,s.x2,s.y2,s.x,s.y):s.type==="Q"?n+="Q"+r(s.x1,s.y1,s.x,s.y):s.type==="Z"&&(n+="Z")}return n};oe.prototype.toSVG=function(t){var e='<path d="';return e+=this.toPathData(t),e+='"',this.fill&&this.fill!=="black"&&(this.fill===null?e+=' fill="none"':e+=' fill="'+this.fill+'"'),this.stroke&&(e+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),e+="/>",e};oe.prototype.toDOMElement=function(t){var e=this.toPathData(t),r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttribute("d",e),r};function mn(t){throw new Error(t)}function Sr(t,e){t||mn(e)}var $={fail:mn,argument:Sr,assert:Sr},Tr=32768,Fr=2147483648,tt={},A={},H={};function Te(t){return function(){return t}}A.BYTE=function(t){return $.argument(t>=0&&t<=255,"Byte value should be between 0 and 255."),[t]};H.BYTE=Te(1);A.CHAR=function(t){return[t.charCodeAt(0)]};H.CHAR=Te(1);A.CHARARRAY=function(t){typeof t>"u"&&(t="",console.warn("Undefined CHARARRAY encountered and treated as an empty string. This is probably caused by a missing glyph name."));for(var e=[],r=0;r<t.length;r+=1)e[r]=t.charCodeAt(r);return e};H.CHARARRAY=function(t){return typeof t>"u"?0:t.length};A.USHORT=function(t){return[t>>8&255,t&255]};H.USHORT=Te(2);A.SHORT=function(t){return t>=Tr&&(t=-(2*Tr-t)),[t>>8&255,t&255]};H.SHORT=Te(2);A.UINT24=function(t){return[t>>16&255,t>>8&255,t&255]};H.UINT24=Te(3);A.ULONG=function(t){return[t>>24&255,t>>16&255,t>>8&255,t&255]};H.ULONG=Te(4);A.LONG=function(t){return t>=Fr&&(t=-(2*Fr-t)),[t>>24&255,t>>16&255,t>>8&255,t&255]};H.LONG=Te(4);A.FIXED=A.ULONG;H.FIXED=H.ULONG;A.FWORD=A.SHORT;H.FWORD=H.SHORT;A.UFWORD=A.USHORT;H.UFWORD=H.USHORT;A.LONGDATETIME=function(t){return[0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255]};H.LONGDATETIME=Te(8);A.TAG=function(t){return $.argument(t.length===4,"Tag should be exactly 4 ASCII characters."),[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]};H.TAG=Te(4);A.Card8=A.BYTE;H.Card8=H.BYTE;A.Card16=A.USHORT;H.Card16=H.USHORT;A.OffSize=A.BYTE;H.OffSize=H.BYTE;A.SID=A.USHORT;H.SID=H.USHORT;A.NUMBER=function(t){return t>=-107&&t<=107?[t+139]:t>=108&&t<=1131?(t=t-108,[(t>>8)+247,t&255]):t>=-1131&&t<=-108?(t=-t-108,[(t>>8)+251,t&255]):t>=-32768&&t<=32767?A.NUMBER16(t):A.NUMBER32(t)};H.NUMBER=function(t){return A.NUMBER(t).length};A.NUMBER16=function(t){return[28,t>>8&255,t&255]};H.NUMBER16=Te(3);A.NUMBER32=function(t){return[29,t>>24&255,t>>16&255,t>>8&255,t&255]};H.NUMBER32=Te(5);A.REAL=function(t){var e=t.toString(),r=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(e);if(r){var n=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));e=(Math.round(t*n)/n).toString()}for(var a="",s=0,i=e.length;s<i;s+=1){var o=e[s];o==="e"?a+=e[++s]==="-"?"c":"b":o==="."?a+="a":o==="-"?a+="e":a+=o}a+=a.length&1?"f":"ff";for(var l=[30],c=0,u=a.length;c<u;c+=2)l.push(parseInt(a.substr(c,2),16));return l};H.REAL=function(t){return A.REAL(t).length};A.NAME=A.CHARARRAY;H.NAME=H.CHARARRAY;A.STRING=A.CHARARRAY;H.STRING=H.CHARARRAY;tt.UTF8=function(t,e,r){for(var n=[],a=r,s=0;s<a;s++,e+=1)n[s]=t.getUint8(e);return String.fromCharCode.apply(null,n)};tt.UTF16=function(t,e,r){for(var n=[],a=r/2,s=0;s<a;s++,e+=2)n[s]=t.getUint16(e);return String.fromCharCode.apply(null,n)};A.UTF16=function(t){for(var e=[],r=0;r<t.length;r+=1){var n=t.charCodeAt(r);e[e.length]=n>>8&255,e[e.length]=n&255}return e};H.UTF16=function(t){return t.length*2};var Zt={"x-mac-croatian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®Š™´¨≠ŽØ∞±≤≥∆µ∂∑∏š∫ªºΩžø¿¡¬√ƒ≈Ć«Č… ÀÃÕŒœĐ—“”‘’÷◊©⁄€‹›Æ»–·‚„‰ÂćÁčÈÍÎÏÌÓÔđÒÚÛÙıˆ˜¯πË˚¸Êæˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†°Ґ£§•¶І®©™Ђђ≠Ѓѓ∞±≤≥іµґЈЄєЇїЉљЊњјЅ¬√ƒ≈∆«»… ЋћЌќѕ–—“”‘’÷„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØḂ±≤≥ḃĊċḊḋḞḟĠġṀæøṁṖṗɼƒſṠ«»… ÀÃÕŒœ–—“”‘’ṡẛÿŸṪ€‹›Ŷŷṫ·Ỳỳ⁊ÂÊÁËÈÍÎÏÌÓÔ♣ÒÚÛÙıÝýŴŵẄẅẀẁẂẃ","x-mac-greek":"Ä¹²É³ÖÜ΅àâä΄¨çéèêë£™îï•½‰ôö¦€ùûü†ΓΔΘΛΞΠß®©ΣΪ§≠°·Α±≤≥¥ΒΕΖΗΙΚΜΦΫΨΩάΝ¬ΟΡ≈Τ«»… ΥΧΆΈœ–―“”‘’÷ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ­","x-mac-icelandic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûüÝ°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€ÐðÞþý·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ°ᒡᒥᒦ•¶ᒧ®©™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"ÄĀāÉĄÖÜáąČäčĆćéŹźĎíďĒēĖóėôöõúĚěü†°Ę£§•¶ß®©™ę¨≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅņŃ¬√ńŇ∆«»… ňŐÕőŌ–—“”‘’÷◊ōŔŕŘ‹›řŖŗŠ‚„šŚśÁŤťÍŽžŪÓÔūŮÚůŰűŲųÝýķŻŁżĢˇ",macintosh:"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›ﬁﬂ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-romanian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ĂȘ∞±≤≥¥µ∂∑∏π∫ªºΩăș¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›Țț‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-turkish":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸĞğİıŞş‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙˆ˜¯˘˙˚¸˝˛ˇ"};tt.MACSTRING=function(t,e,r,n){var a=Zt[n];if(a!==void 0){for(var s="",i=0;i<r;i++){var o=t.getUint8(e+i);o<=127?s+=String.fromCharCode(o):s+=a[o&127]}return s}};var xt=typeof WeakMap=="function"&&new WeakMap,wt,Vo=function(t){if(!wt){wt={};for(var e in Zt)wt[e]=new String(e)}var r=wt[t];if(r!==void 0){if(xt){var n=xt.get(r);if(n!==void 0)return n}var a=Zt[t];if(a!==void 0){for(var s={},i=0;i<a.length;i++)s[a.charCodeAt(i)]=i+128;return xt&&xt.set(r,s),s}}};A.MACSTRING=function(t,e){var r=Vo(e);if(r!==void 0){for(var n=[],a=0;a<t.length;a++){var s=t.charCodeAt(a);if(s>=128&&(s=r[s],s===void 0))return;n[a]=s}return n}};H.MACSTRING=function(t,e){var r=A.MACSTRING(t,e);return r!==void 0?r.length:0};function Jt(t){return t>=-128&&t<=127}function $o(t,e,r){for(var n=0,a=t.length;e<a&&n<64&&t[e]===0;)++e,++n;return r.push(128|n-1),e}function Ho(t,e,r){for(var n=0,a=t.length,s=e;s<a&&n<64;){var i=t[s];if(!Jt(i)||i===0&&s+1<a&&t[s+1]===0)break;++s,++n}r.push(n-1);for(var o=e;o<s;++o)r.push(t[o]+256&255);return s}function jo(t,e,r){for(var n=0,a=t.length,s=e;s<a&&n<64;){var i=t[s];if(i===0||Jt(i)&&s+1<a&&Jt(t[s+1]))break;++s,++n}r.push(64|n-1);for(var o=e;o<s;++o){var l=t[o];r.push(l+65536>>8&255,l+256&255)}return s}A.VARDELTAS=function(t){for(var e=0,r=[];e<t.length;){var n=t[e];n===0?e=$o(t,e,r):n>=-128&&n<=127?e=Ho(t,e,r):e=jo(t,e,r)}return r};A.INDEX=function(t){for(var e=1,r=[e],n=[],a=0;a<t.length;a+=1){var s=A.OBJECT(t[a]);Array.prototype.push.apply(n,s),e+=s.length,r.push(e)}if(n.length===0)return[0,0];for(var i=[],o=1+Math.floor(Math.log(e)/Math.log(2))/8|0,l=[void 0,A.BYTE,A.USHORT,A.UINT24,A.ULONG][o],c=0;c<r.length;c+=1){var u=l(r[c]);Array.prototype.push.apply(i,u)}return Array.prototype.concat(A.Card16(t.length),A.OffSize(o),i,n)};H.INDEX=function(t){return A.INDEX(t).length};A.DICT=function(t){for(var e=[],r=Object.keys(t),n=r.length,a=0;a<n;a+=1){var s=parseInt(r[a],0),i=t[s];e=e.concat(A.OPERAND(i.value,i.type)),e=e.concat(A.OPERATOR(s))}return e};H.DICT=function(t){return A.DICT(t).length};A.OPERATOR=function(t){return t<1200?[t]:[12,t-1200]};A.OPERAND=function(t,e){var r=[];if(Array.isArray(e))for(var n=0;n<e.length;n+=1)$.argument(t.length===e.length,"Not enough arguments given for type"+e),r=r.concat(A.OPERAND(t[n],e[n]));else if(e==="SID")r=r.concat(A.NUMBER(t));else if(e==="offset")r=r.concat(A.NUMBER32(t));else if(e==="number")r=r.concat(A.NUMBER(t));else if(e==="real")r=r.concat(A.REAL(t));else throw new Error("Unknown operand type "+e);return r};A.OP=A.BYTE;H.OP=H.BYTE;var kt=typeof WeakMap=="function"&&new WeakMap;A.CHARSTRING=function(t){if(kt){var e=kt.get(t);if(e!==void 0)return e}for(var r=[],n=t.length,a=0;a<n;a+=1){var s=t[a];r=r.concat(A[s.type](s.value))}return kt&&kt.set(t,r),r};H.CHARSTRING=function(t){return A.CHARSTRING(t).length};A.OBJECT=function(t){var e=A[t.type];return $.argument(e!==void 0,"No encoding function for type "+t.type),e(t.value)};H.OBJECT=function(t){var e=H[t.type];return $.argument(e!==void 0,"No sizeOf function for type "+t.type),e(t.value)};A.TABLE=function(t){for(var e=[],r=t.fields.length,n=[],a=[],s=0;s<r;s+=1){var i=t.fields[s],o=A[i.type];$.argument(o!==void 0,"No encoding function for field type "+i.type+" ("+i.name+")");var l=t[i.name];l===void 0&&(l=i.value);var c=o(l);i.type==="TABLE"?(a.push(e.length),e=e.concat([0,0]),n.push(c)):e=e.concat(c)}for(var u=0;u<n.length;u+=1){var f=a[u],h=e.length;$.argument(h<65536,"Table "+t.tableName+" too big."),e[f]=h>>8,e[f+1]=h&255,e=e.concat(n[u])}return e};H.TABLE=function(t){for(var e=0,r=t.fields.length,n=0;n<r;n+=1){var a=t.fields[n],s=H[a.type];$.argument(s!==void 0,"No sizeOf function for field type "+a.type+" ("+a.name+")");var i=t[a.name];i===void 0&&(i=a.value),e+=s(i),a.type==="TABLE"&&(e+=2)}return e};A.RECORD=A.TABLE;H.RECORD=H.TABLE;A.LITERAL=function(t){return t};H.LITERAL=function(t){return t.length};function ue(t,e,r){if(e.length&&(e[0].name!=="coverageFormat"||e[0].value===1))for(var n=0;n<e.length;n+=1){var a=e[n];this[a.name]=a.value}if(this.tableName=t,this.fields=e,r)for(var s=Object.keys(r),i=0;i<s.length;i+=1){var o=s[i],l=r[o];this[o]!==void 0&&(this[o]=l)}}ue.prototype.encode=function(){return A.TABLE(this)};ue.prototype.sizeOf=function(){return H.TABLE(this)};function lt(t,e,r){r===void 0&&(r=e.length);var n=new Array(e.length+1);n[0]={name:t+"Count",type:"USHORT",value:r};for(var a=0;a<e.length;a++)n[a+1]={name:t+a,type:"USHORT",value:e[a]};return n}function Qt(t,e,r){var n=e.length,a=new Array(n+1);a[0]={name:t+"Count",type:"USHORT",value:n};for(var s=0;s<n;s++)a[s+1]={name:t+s,type:"TABLE",value:r(e[s],s)};return a}function ut(t,e,r){var n=e.length,a=[];a[0]={name:t+"Count",type:"USHORT",value:n};for(var s=0;s<n;s++)a=a.concat(r(e[s],s));return a}function Et(t){t.format===1?ue.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(lt("glyph",t.glyphs))):t.format===2?ue.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:2}].concat(ut("rangeRecord",t.ranges,function(e){return[{name:"startGlyphID",type:"USHORT",value:e.start},{name:"endGlyphID",type:"USHORT",value:e.end},{name:"startCoverageIndex",type:"USHORT",value:e.index}]}))):$.assert(!1,"Coverage format must be 1 or 2.")}Et.prototype=Object.create(ue.prototype);Et.prototype.constructor=Et;function Ut(t){ue.call(this,"scriptListTable",ut("scriptRecord",t,function(e,r){var n=e.script,a=n.defaultLangSys;return $.assert(!!a,"Unable to write GSUB: script "+e.tag+" has no default language system."),[{name:"scriptTag"+r,type:"TAG",value:e.tag},{name:"script"+r,type:"TABLE",value:new ue("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new ue("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:a.reqFeatureIndex}].concat(lt("featureIndex",a.featureIndexes)))}].concat(ut("langSys",n.langSysRecords,function(s,i){var o=s.langSys;return[{name:"langSysTag"+i,type:"TAG",value:s.tag},{name:"langSys"+i,type:"TABLE",value:new ue("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:o.reqFeatureIndex}].concat(lt("featureIndex",o.featureIndexes)))}]})))}]}))}Ut.prototype=Object.create(ue.prototype);Ut.prototype.constructor=Ut;function Lt(t){ue.call(this,"featureListTable",ut("featureRecord",t,function(e,r){var n=e.feature;return[{name:"featureTag"+r,type:"TAG",value:e.tag},{name:"feature"+r,type:"TABLE",value:new ue("featureTable",[{name:"featureParams",type:"USHORT",value:n.featureParams}].concat(lt("lookupListIndex",n.lookupListIndexes)))}]}))}Lt.prototype=Object.create(ue.prototype);Lt.prototype.constructor=Lt;function Ot(t,e){ue.call(this,"lookupListTable",Qt("lookup",t,function(r){var n=e[r.lookupType];return $.assert(!!n,"Unable to write GSUB lookup type "+r.lookupType+" tables."),new ue("lookupTable",[{name:"lookupType",type:"USHORT",value:r.lookupType},{name:"lookupFlag",type:"USHORT",value:r.lookupFlag}].concat(Qt("subtable",r.subtables,n)))}))}Ot.prototype=Object.create(ue.prototype);Ot.prototype.constructor=Ot;var D={Table:ue,Record:ue,Coverage:Et,ScriptList:Ut,FeatureList:Lt,LookupList:Ot,ushortList:lt,tableList:Qt,recordList:ut};function Cr(t,e){return t.getUint8(e)}function Bt(t,e){return t.getUint16(e,!1)}function Wo(t,e){return t.getInt16(e,!1)}function cr(t,e){return t.getUint32(e,!1)}function vn(t,e){var r=t.getInt16(e,!1),n=t.getUint16(e+2,!1);return r+n/65535}function Xo(t,e){for(var r="",n=e;n<e+4;n+=1)r+=String.fromCharCode(t.getInt8(n));return r}function qo(t,e,r){for(var n=0,a=0;a<r;a+=1)n<<=8,n+=t.getUint8(e+a);return n}function Yo(t,e,r){for(var n=[],a=e;a<r;a+=1)n.push(t.getUint8(a));return n}function Ko(t){for(var e="",r=0;r<t.length;r+=1)e+=String.fromCharCode(t[r]);return e}var Zo={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function k(t,e){this.data=t,this.offset=e,this.relativeOffset=0}k.prototype.parseByte=function(){var t=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,t};k.prototype.parseChar=function(){var t=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,t};k.prototype.parseCard8=k.prototype.parseByte;k.prototype.parseUShort=function(){var t=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,t};k.prototype.parseCard16=k.prototype.parseUShort;k.prototype.parseSID=k.prototype.parseUShort;k.prototype.parseOffset16=k.prototype.parseUShort;k.prototype.parseShort=function(){var t=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,t};k.prototype.parseF2Dot14=function(){var t=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,t};k.prototype.parseULong=function(){var t=cr(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,t};k.prototype.parseOffset32=k.prototype.parseULong;k.prototype.parseFixed=function(){var t=vn(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,t};k.prototype.parseString=function(t){var e=this.data,r=this.offset+this.relativeOffset,n="";this.relativeOffset+=t;for(var a=0;a<t;a++)n+=String.fromCharCode(e.getUint8(r+a));return n};k.prototype.parseTag=function(){return this.parseString(4)};k.prototype.parseLongDateTime=function(){var t=cr(this.data,this.offset+this.relativeOffset+4);return t-=2082844800,this.relativeOffset+=8,t};k.prototype.parseVersion=function(t){var e=Bt(this.data,this.offset+this.relativeOffset),r=Bt(this.data,this.offset+this.relativeOffset+2);return this.relativeOffset+=4,t===void 0&&(t=4096),e+r/t/10};k.prototype.skip=function(t,e){e===void 0&&(e=1),this.relativeOffset+=Zo[t]*e};k.prototype.parseULongList=function(t){t===void 0&&(t=this.parseULong());for(var e=new Array(t),r=this.data,n=this.offset+this.relativeOffset,a=0;a<t;a++)e[a]=r.getUint32(n),n+=4;return this.relativeOffset+=t*4,e};k.prototype.parseOffset16List=k.prototype.parseUShortList=function(t){t===void 0&&(t=this.parseUShort());for(var e=new Array(t),r=this.data,n=this.offset+this.relativeOffset,a=0;a<t;a++)e[a]=r.getUint16(n),n+=2;return this.relativeOffset+=t*2,e};k.prototype.parseShortList=function(t){for(var e=new Array(t),r=this.data,n=this.offset+this.relativeOffset,a=0;a<t;a++)e[a]=r.getInt16(n),n+=2;return this.relativeOffset+=t*2,e};k.prototype.parseByteList=function(t){for(var e=new Array(t),r=this.data,n=this.offset+this.relativeOffset,a=0;a<t;a++)e[a]=r.getUint8(n++);return this.relativeOffset+=t,e};k.prototype.parseList=function(t,e){e||(e=t,t=this.parseUShort());for(var r=new Array(t),n=0;n<t;n++)r[n]=e.call(this);return r};k.prototype.parseList32=function(t,e){e||(e=t,t=this.parseULong());for(var r=new Array(t),n=0;n<t;n++)r[n]=e.call(this);return r};k.prototype.parseRecordList=function(t,e){e||(e=t,t=this.parseUShort());for(var r=new Array(t),n=Object.keys(e),a=0;a<t;a++){for(var s={},i=0;i<n.length;i++){var o=n[i],l=e[o];s[o]=l.call(this)}r[a]=s}return r};k.prototype.parseRecordList32=function(t,e){e||(e=t,t=this.parseULong());for(var r=new Array(t),n=Object.keys(e),a=0;a<t;a++){for(var s={},i=0;i<n.length;i++){var o=n[i],l=e[o];s[o]=l.call(this)}r[a]=s}return r};k.prototype.parseStruct=function(t){if(typeof t=="function")return t.call(this);for(var e=Object.keys(t),r={},n=0;n<e.length;n++){var a=e[n],s=t[a];r[a]=s.call(this)}return r};k.prototype.parseValueRecord=function(t){if(t===void 0&&(t=this.parseUShort()),t!==0){var e={};return t&1&&(e.xPlacement=this.parseShort()),t&2&&(e.yPlacement=this.parseShort()),t&4&&(e.xAdvance=this.parseShort()),t&8&&(e.yAdvance=this.parseShort()),t&16&&(e.xPlaDevice=void 0,this.parseShort()),t&32&&(e.yPlaDevice=void 0,this.parseShort()),t&64&&(e.xAdvDevice=void 0,this.parseShort()),t&128&&(e.yAdvDevice=void 0,this.parseShort()),e}};k.prototype.parseValueRecordList=function(){for(var t=this.parseUShort(),e=this.parseUShort(),r=new Array(e),n=0;n<e;n++)r[n]=this.parseValueRecord(t);return r};k.prototype.parsePointer=function(t){var e=this.parseOffset16();if(e>0)return new k(this.data,this.offset+e).parseStruct(t)};k.prototype.parsePointer32=function(t){var e=this.parseOffset32();if(e>0)return new k(this.data,this.offset+e).parseStruct(t)};k.prototype.parseListOfLists=function(t){for(var e=this.parseOffset16List(),r=e.length,n=this.relativeOffset,a=new Array(r),s=0;s<r;s++){var i=e[s];if(i===0){a[s]=void 0;continue}if(this.relativeOffset=i,t){for(var o=this.parseOffset16List(),l=new Array(o.length),c=0;c<o.length;c++)this.relativeOffset=i+o[c],l[c]=t.call(this);a[s]=l}else a[s]=this.parseUShortList()}return this.relativeOffset=n,a};k.prototype.parseCoverage=function(){var t=this.offset+this.relativeOffset,e=this.parseUShort(),r=this.parseUShort();if(e===1)return{format:1,glyphs:this.parseUShortList(r)};if(e===2){for(var n=new Array(r),a=0;a<r;a++)n[a]={start:this.parseUShort(),end:this.parseUShort(),index:this.parseUShort()};return{format:2,ranges:n}}throw new Error("0x"+t.toString(16)+": Coverage format must be 1 or 2.")};k.prototype.parseClassDef=function(){var t=this.offset+this.relativeOffset,e=this.parseUShort();if(e===1)return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()};if(e===2)return{format:2,ranges:this.parseRecordList({start:k.uShort,end:k.uShort,classId:k.uShort})};throw new Error("0x"+t.toString(16)+": ClassDef format must be 1 or 2.")};k.list=function(t,e){return function(){return this.parseList(t,e)}};k.list32=function(t,e){return function(){return this.parseList32(t,e)}};k.recordList=function(t,e){return function(){return this.parseRecordList(t,e)}};k.recordList32=function(t,e){return function(){return this.parseRecordList32(t,e)}};k.pointer=function(t){return function(){return this.parsePointer(t)}};k.pointer32=function(t){return function(){return this.parsePointer32(t)}};k.tag=k.prototype.parseTag;k.byte=k.prototype.parseByte;k.uShort=k.offset16=k.prototype.parseUShort;k.uShortList=k.prototype.parseUShortList;k.uLong=k.offset32=k.prototype.parseULong;k.uLongList=k.prototype.parseULongList;k.struct=k.prototype.parseStruct;k.coverage=k.prototype.parseCoverage;k.classDef=k.prototype.parseClassDef;var _r={reserved:k.uShort,reqFeatureIndex:k.uShort,featureIndexes:k.uShortList};k.prototype.parseScriptList=function(){return this.parsePointer(k.recordList({tag:k.tag,script:k.pointer({defaultLangSys:k.pointer(_r),langSysRecords:k.recordList({tag:k.tag,langSys:k.pointer(_r)})})}))||[]};k.prototype.parseFeatureList=function(){return this.parsePointer(k.recordList({tag:k.tag,feature:k.pointer({featureParams:k.offset16,lookupListIndexes:k.uShortList})}))||[]};k.prototype.parseLookupList=function(t){return this.parsePointer(k.list(k.pointer(function(){var e=this.parseUShort();$.argument(1<=e&&e<=9,"GPOS/GSUB lookup type "+e+" unknown.");var r=this.parseUShort(),n=r&16;return{lookupType:e,lookupFlag:r,subtables:this.parseList(k.pointer(t[e])),markFilteringSet:n?this.parseUShort():void 0}})))||[]};k.prototype.parseFeatureVariationsList=function(){return this.parsePointer32(function(){var t=this.parseUShort(),e=this.parseUShort();$.argument(t===1&&e<1,"GPOS/GSUB feature variations table unknown.");var r=this.parseRecordList32({conditionSetOffset:k.offset32,featureTableSubstitutionOffset:k.offset32});return r})||[]};var N={getByte:Cr,getCard8:Cr,getUShort:Bt,getCard16:Bt,getShort:Wo,getULong:cr,getFixed:vn,getTag:Xo,getOffset:qo,getBytes:Yo,bytesToString:Ko,Parser:k};function Jo(t,e){e.parseUShort(),t.length=e.parseULong(),t.language=e.parseULong();var r;t.groupCount=r=e.parseULong(),t.glyphIndexMap={};for(var n=0;n<r;n+=1)for(var a=e.parseULong(),s=e.parseULong(),i=e.parseULong(),o=a;o<=s;o+=1)t.glyphIndexMap[o]=i,i++}function Qo(t,e,r,n,a){t.length=e.parseUShort(),t.language=e.parseUShort();var s;t.segCount=s=e.parseUShort()>>1,e.skip("uShort",3),t.glyphIndexMap={};for(var i=new N.Parser(r,n+a+14),o=new N.Parser(r,n+a+16+s*2),l=new N.Parser(r,n+a+16+s*4),c=new N.Parser(r,n+a+16+s*6),u=n+a+16+s*8,f=0;f<s-1;f+=1)for(var h=void 0,p=i.parseUShort(),y=o.parseUShort(),b=l.parseShort(),m=c.parseUShort(),g=y;g<=p;g+=1)m!==0?(u=c.offset+c.relativeOffset-2,u+=m,u+=(g-y)*2,h=N.getUShort(r,u),h!==0&&(h=h+b&65535)):h=g+b&65535,t.glyphIndexMap[g]=h}function el(t,e){var r={};r.version=N.getUShort(t,e),$.argument(r.version===0,"cmap table version should be 0."),r.numTables=N.getUShort(t,e+2);for(var n=-1,a=r.numTables-1;a>=0;a-=1){var s=N.getUShort(t,e+4+a*8),i=N.getUShort(t,e+4+a*8+2);if(s===3&&(i===0||i===1||i===10)||s===0&&(i===0||i===1||i===2||i===3||i===4)){n=N.getULong(t,e+4+a*8+4);break}}if(n===-1)throw new Error("No valid cmap sub-tables found.");var o=new N.Parser(t,e+n);if(r.format=o.parseUShort(),r.format===12)Jo(r,o);else if(r.format===4)Qo(r,o,t,e,n);else throw new Error("Only format 4 and 12 cmap tables are supported (found format "+r.format+").");return r}function tl(t,e,r){t.segments.push({end:e,start:e,delta:-(e-r),offset:0,glyphIndex:r})}function rl(t){t.segments.push({end:65535,start:65535,delta:1,offset:0})}function nl(t){var e=!0,r;for(r=t.length-1;r>0;r-=1){var n=t.get(r);if(n.unicode>65535){console.log("Adding CMAP format 12 (needed!)"),e=!1;break}}var a=[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:e?1:2},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:e?12:20}];e||(a=a.concat([{name:"cmap12PlatformID",type:"USHORT",value:3},{name:"cmap12EncodingID",type:"USHORT",value:10},{name:"cmap12Offset",type:"ULONG",value:0}])),a=a.concat([{name:"format",type:"USHORT",value:4},{name:"cmap4Length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);var s=new D.Table("cmap",a);for(s.segments=[],r=0;r<t.length;r+=1){for(var i=t.get(r),o=0;o<i.unicodes.length;o+=1)tl(s,i.unicodes[o],r);s.segments=s.segments.sort(function(w,v){return w.start-v.start})}rl(s);var l=s.segments.length,c=0,u=[],f=[],h=[],p=[],y=[],b=[];for(r=0;r<l;r+=1){var m=s.segments[r];m.end<=65535&&m.start<=65535?(u=u.concat({name:"end_"+r,type:"USHORT",value:m.end}),f=f.concat({name:"start_"+r,type:"USHORT",value:m.start}),h=h.concat({name:"idDelta_"+r,type:"SHORT",value:m.delta}),p=p.concat({name:"idRangeOffset_"+r,type:"USHORT",value:m.offset}),m.glyphId!==void 0&&(y=y.concat({name:"glyph_"+r,type:"USHORT",value:m.glyphId}))):c+=1,!e&&m.glyphIndex!==void 0&&(b=b.concat({name:"cmap12Start_"+r,type:"ULONG",value:m.start}),b=b.concat({name:"cmap12End_"+r,type:"ULONG",value:m.end}),b=b.concat({name:"cmap12Glyph_"+r,type:"ULONG",value:m.glyphIndex}))}if(s.segCountX2=(l-c)*2,s.searchRange=Math.pow(2,Math.floor(Math.log(l-c)/Math.log(2)))*2,s.entrySelector=Math.log(s.searchRange/2)/Math.log(2),s.rangeShift=s.segCountX2-s.searchRange,s.fields=s.fields.concat(u),s.fields.push({name:"reservedPad",type:"USHORT",value:0}),s.fields=s.fields.concat(f),s.fields=s.fields.concat(h),s.fields=s.fields.concat(p),s.fields=s.fields.concat(y),s.cmap4Length=14+u.length*2+2+f.length*2+h.length*2+p.length*2+y.length*2,!e){var g=16+b.length*4;s.cmap12Offset=12+2*2+4+s.cmap4Length,s.fields=s.fields.concat([{name:"cmap12Format",type:"USHORT",value:12},{name:"cmap12Reserved",type:"USHORT",value:0},{name:"cmap12Length",type:"ULONG",value:g},{name:"cmap12Language",type:"ULONG",value:0},{name:"cmap12nGroups",type:"ULONG",value:b.length/3}]),s.fields=s.fields.concat(b)}return s}var yn={parse:el,make:nl},Ct=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],al=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],sl=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],qe=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function bn(t){this.font=t}bn.prototype.charToGlyphIndex=function(t){var e=t.codePointAt(0),r=this.font.glyphs;if(r){for(var n=0;n<r.length;n+=1)for(var a=r.get(n),s=0;s<a.unicodes.length;s+=1)if(a.unicodes[s]===e)return n}return null};function xn(t){this.cmap=t}xn.prototype.charToGlyphIndex=function(t){return this.cmap.glyphIndexMap[t.codePointAt(0)]||0};function Rt(t,e){this.encoding=t,this.charset=e}Rt.prototype.charToGlyphIndex=function(t){var e=t.codePointAt(0),r=this.encoding[e];return this.charset.indexOf(r)};function hr(t){switch(t.version){case 1:this.names=qe.slice();break;case 2:this.names=new Array(t.numberOfGlyphs);for(var e=0;e<t.numberOfGlyphs;e++)t.glyphNameIndex[e]<qe.length?this.names[e]=qe[t.glyphNameIndex[e]]:this.names[e]=t.names[t.glyphNameIndex[e]-qe.length];break;case 2.5:this.names=new Array(t.numberOfGlyphs);for(var r=0;r<t.numberOfGlyphs;r++)this.names[r]=qe[r+t.glyphNameIndex[r]];break;case 3:this.names=[];break;default:this.names=[];break}}hr.prototype.nameToGlyphIndex=function(t){return this.names.indexOf(t)};hr.prototype.glyphIndexToName=function(t){return this.names[t]};function il(t){for(var e,r=t.tables.cmap.glyphIndexMap,n=Object.keys(r),a=0;a<n.length;a+=1){var s=n[a],i=r[s];e=t.glyphs.get(i),e.addUnicode(parseInt(s))}for(var o=0;o<t.glyphs.length;o+=1)e=t.glyphs.get(o),t.cffEncoding?t.isCIDFont?e.name="gid"+o:e.name=t.cffEncoding.charset[o]:t.glyphNames.names&&(e.name=t.glyphNames.glyphIndexToName(o))}function ol(t){t._IndexToUnicodeMap={};for(var e=t.tables.cmap.glyphIndexMap,r=Object.keys(e),n=0;n<r.length;n+=1){var a=r[n],s=e[a];t._IndexToUnicodeMap[s]===void 0?t._IndexToUnicodeMap[s]={unicodes:[parseInt(a)]}:t._IndexToUnicodeMap[s].unicodes.push(parseInt(a))}}function ll(t,e){e.lowMemory?ol(t):il(t)}function ul(t,e,r,n,a){t.beginPath(),t.moveTo(e,r),t.lineTo(n,a),t.stroke()}var Xe={line:ul};function cl(t,e){var r=e||new oe;return{configurable:!0,get:function(){return typeof r=="function"&&(r=r()),r},set:function(n){r=n}}}function ge(t){this.bindConstructorValues(t)}ge.prototype.bindConstructorValues=function(t){this.index=t.index||0,this.name=t.name||null,this.unicode=t.unicode||void 0,this.unicodes=t.unicodes||t.unicode!==void 0?[t.unicode]:[],"xMin"in t&&(this.xMin=t.xMin),"yMin"in t&&(this.yMin=t.yMin),"xMax"in t&&(this.xMax=t.xMax),"yMax"in t&&(this.yMax=t.yMax),"advanceWidth"in t&&(this.advanceWidth=t.advanceWidth),Object.defineProperty(this,"path",cl(this,t.path))};ge.prototype.addUnicode=function(t){this.unicodes.length===0&&(this.unicode=t),this.unicodes.push(t)};ge.prototype.getBoundingBox=function(){return this.path.getBoundingBox()};ge.prototype.getPath=function(t,e,r,n,a){t=t!==void 0?t:0,e=e!==void 0?e:0,r=r!==void 0?r:72;var s,i;n||(n={});var o=n.xScale,l=n.yScale;if(n.hinting&&a&&a.hinting&&(i=this.path&&a.hinting.exec(this,r)),i)s=a.hinting.getCommands(i),t=Math.round(t),e=Math.round(e),o=l=1;else{s=this.path.commands;var c=1/(this.path.unitsPerEm||1e3)*r;o===void 0&&(o=c),l===void 0&&(l=c)}for(var u=new oe,f=0;f<s.length;f+=1){var h=s[f];h.type==="M"?u.moveTo(t+h.x*o,e+-h.y*l):h.type==="L"?u.lineTo(t+h.x*o,e+-h.y*l):h.type==="Q"?u.quadraticCurveTo(t+h.x1*o,e+-h.y1*l,t+h.x*o,e+-h.y*l):h.type==="C"?u.curveTo(t+h.x1*o,e+-h.y1*l,t+h.x2*o,e+-h.y2*l,t+h.x*o,e+-h.y*l):h.type==="Z"&&u.closePath()}return u};ge.prototype.getContours=function(){if(this.points===void 0)return[];for(var t=[],e=[],r=0;r<this.points.length;r+=1){var n=this.points[r];e.push(n),n.lastPointOfContour&&(t.push(e),e=[])}return $.argument(e.length===0,"There are still points left in the current contour."),t};ge.prototype.getMetrics=function(){for(var t=this.path.commands,e=[],r=[],n=0;n<t.length;n+=1){var a=t[n];a.type!=="Z"&&(e.push(a.x),r.push(a.y)),(a.type==="Q"||a.type==="C")&&(e.push(a.x1),r.push(a.y1)),a.type==="C"&&(e.push(a.x2),r.push(a.y2))}var s={xMin:Math.min.apply(null,e),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,e),yMax:Math.max.apply(null,r),leftSideBearing:this.leftSideBearing};return isFinite(s.xMin)||(s.xMin=0),isFinite(s.xMax)||(s.xMax=this.advanceWidth),isFinite(s.yMin)||(s.yMin=0),isFinite(s.yMax)||(s.yMax=0),s.rightSideBearing=this.advanceWidth-s.leftSideBearing-(s.xMax-s.xMin),s};ge.prototype.draw=function(t,e,r,n,a){this.getPath(e,r,n,a).draw(t)};ge.prototype.drawPoints=function(t,e,r,n){function a(f,h,p,y){t.beginPath();for(var b=0;b<f.length;b+=1)t.moveTo(h+f[b].x*y,p+f[b].y*y),t.arc(h+f[b].x*y,p+f[b].y*y,2,0,Math.PI*2,!1);t.closePath(),t.fill()}e=e!==void 0?e:0,r=r!==void 0?r:0,n=n!==void 0?n:24;for(var s=1/this.path.unitsPerEm*n,i=[],o=[],l=this.path,c=0;c<l.commands.length;c+=1){var u=l.commands[c];u.x!==void 0&&i.push({x:u.x,y:-u.y}),u.x1!==void 0&&o.push({x:u.x1,y:-u.y1}),u.x2!==void 0&&o.push({x:u.x2,y:-u.y2})}t.fillStyle="blue",a(i,e,r,s),t.fillStyle="red",a(o,e,r,s)};ge.prototype.drawMetrics=function(t,e,r,n){var a;e=e!==void 0?e:0,r=r!==void 0?r:0,n=n!==void 0?n:24,a=1/this.path.unitsPerEm*n,t.lineWidth=1,t.strokeStyle="black",Xe.line(t,e,-1e4,e,1e4),Xe.line(t,-1e4,r,1e4,r);var s=this.xMin||0,i=this.yMin||0,o=this.xMax||0,l=this.yMax||0,c=this.advanceWidth||0;t.strokeStyle="blue",Xe.line(t,e+s*a,-1e4,e+s*a,1e4),Xe.line(t,e+o*a,-1e4,e+o*a,1e4),Xe.line(t,-1e4,r+-i*a,1e4,r+-i*a),Xe.line(t,-1e4,r+-l*a,1e4,r+-l*a),t.strokeStyle="green",Xe.line(t,e+c*a,-1e4,e+c*a,1e4)};function St(t,e,r){Object.defineProperty(t,e,{get:function(){return t.path,t[r]},set:function(n){t[r]=n},enumerable:!0,configurable:!0})}function dr(t,e){if(this.font=t,this.glyphs={},Array.isArray(e))for(var r=0;r<e.length;r++){var n=e[r];n.path.unitsPerEm=t.unitsPerEm,this.glyphs[r]=n}this.length=e&&e.length||0}dr.prototype.get=function(t){if(this.glyphs[t]===void 0){this.font._push(t),typeof this.glyphs[t]=="function"&&(this.glyphs[t]=this.glyphs[t]());var e=this.glyphs[t],r=this.font._IndexToUnicodeMap[t];if(r)for(var n=0;n<r.unicodes.length;n++)e.addUnicode(r.unicodes[n]);this.font.cffEncoding?this.font.isCIDFont?e.name="gid"+t:e.name=this.font.cffEncoding.charset[t]:this.font.glyphNames.names&&(e.name=this.font.glyphNames.glyphIndexToName(t)),this.glyphs[t].advanceWidth=this.font._hmtxTableData[t].advanceWidth,this.glyphs[t].leftSideBearing=this.font._hmtxTableData[t].leftSideBearing}else typeof this.glyphs[t]=="function"&&(this.glyphs[t]=this.glyphs[t]());return this.glyphs[t]};dr.prototype.push=function(t,e){this.glyphs[t]=e,this.length++};function hl(t,e){return new ge({index:e,font:t})}function dl(t,e,r,n,a,s){return function(){var i=new ge({index:e,font:t});return i.path=function(){r(i,n,a);var o=s(t.glyphs,i);return o.unitsPerEm=t.unitsPerEm,o},St(i,"xMin","_xMin"),St(i,"xMax","_xMax"),St(i,"yMin","_yMin"),St(i,"yMax","_yMax"),i}}function fl(t,e,r,n){return function(){var a=new ge({index:e,font:t});return a.path=function(){var s=r(t,a,n);return s.unitsPerEm=t.unitsPerEm,s},a}}var Le={GlyphSet:dr,glyphLoader:hl,ttfGlyphLoader:dl,cffGlyphLoader:fl};function wn(t,e){if(t===e)return!0;if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return!1;for(var r=0;r<t.length;r+=1)if(!wn(t[r],e[r]))return!1;return!0}else return!1}function er(t){var e;return t.length<1240?e=107:t.length<33900?e=1131:e=32768,e}function ze(t,e,r){var n=[],a=[],s=N.getCard16(t,e),i,o;if(s!==0){var l=N.getByte(t,e+2);i=e+(s+1)*l+2;for(var c=e+3,u=0;u<s+1;u+=1)n.push(N.getOffset(t,c,l)),c+=l;o=i+n[s]}else o=e+2;for(var f=0;f<n.length-1;f+=1){var h=N.getBytes(t,i+n[f],i+n[f+1]);r&&(h=r(h)),a.push(h)}return{objects:a,startOffset:e,endOffset:o}}function pl(t,e){var r=[],n=N.getCard16(t,e),a,s;if(n!==0){var i=N.getByte(t,e+2);a=e+(n+1)*i+2;for(var o=e+3,l=0;l<n+1;l+=1)r.push(N.getOffset(t,o,i)),o+=i;s=a+r[n]}else s=e+2;return{offsets:r,startOffset:e,endOffset:s}}function gl(t,e,r,n,a){var s=N.getCard16(r,n),i=0;if(s!==0){var o=N.getByte(r,n+2);i=n+(s+1)*o+2}var l=N.getBytes(r,i+e[t],i+e[t+1]);return l}function ml(t){for(var e="",r=15,n=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var a=t.parseByte(),s=a>>4,i=a&15;if(s===r||(e+=n[s],i===r))break;e+=n[i]}return parseFloat(e)}function vl(t,e){var r,n,a,s;if(e===28)return r=t.parseByte(),n=t.parseByte(),r<<8|n;if(e===29)return r=t.parseByte(),n=t.parseByte(),a=t.parseByte(),s=t.parseByte(),r<<24|n<<16|a<<8|s;if(e===30)return ml(t);if(e>=32&&e<=246)return e-139;if(e>=247&&e<=250)return r=t.parseByte(),(e-247)*256+r+108;if(e>=251&&e<=254)return r=t.parseByte(),-(e-251)*256-r-108;throw new Error("Invalid b0 "+e)}function yl(t){for(var e={},r=0;r<t.length;r+=1){var n=t[r][0],a=t[r][1],s=void 0;if(a.length===1?s=a[0]:s=a,e.hasOwnProperty(n)&&!isNaN(e[n]))throw new Error("Object "+e+" already has key "+n);e[n]=s}return e}function kn(t,e,r){e=e!==void 0?e:0;var n=new N.Parser(t,e),a=[],s=[];for(r=r!==void 0?r:t.length;n.relativeOffset<r;){var i=n.parseByte();i<=21?(i===12&&(i=1200+n.parseByte()),a.push([i,s]),s=[]):s.push(vl(n,i))}return yl(a)}function it(t,e){return e<=390?e=Ct[e]:e=t[e-391],e}function Sn(t,e,r){for(var n={},a,s=0;s<e.length;s+=1){var i=e[s];if(Array.isArray(i.type)){var o=[];o.length=i.type.length;for(var l=0;l<i.type.length;l++)a=t[i.op]!==void 0?t[i.op][l]:void 0,a===void 0&&(a=i.value!==void 0&&i.value[l]!==void 0?i.value[l]:null),i.type[l]==="SID"&&(a=it(r,a)),o[l]=a;n[i.name]=o}else a=t[i.op],a===void 0&&(a=i.value!==void 0?i.value:null),i.type==="SID"&&(a=it(r,a)),n[i.name]=a}return n}function bl(t,e){var r={};return r.formatMajor=N.getCard8(t,e),r.formatMinor=N.getCard8(t,e+1),r.size=N.getCard8(t,e+2),r.offsetSize=N.getCard8(t,e+3),r.startOffset=e,r.endOffset=e+4,r}var Tn=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}],Fn=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function xl(t,e){var r=kn(t,0,t.byteLength);return Sn(r,Tn,e)}function Cn(t,e,r,n){var a=kn(t,e,r);return Sn(a,Fn,n)}function Er(t,e,r,n){for(var a=[],s=0;s<r.length;s+=1){var i=new DataView(new Uint8Array(r[s]).buffer),o=xl(i,n);o._subrs=[],o._subrsBias=0,o._defaultWidthX=0,o._nominalWidthX=0;var l=o.private[0],c=o.private[1];if(l!==0&&c!==0){var u=Cn(t,c+e,l,n);if(o._defaultWidthX=u.defaultWidthX,o._nominalWidthX=u.nominalWidthX,u.subrs!==0){var f=c+u.subrs,h=ze(t,f+e);o._subrs=h.objects,o._subrsBias=er(o._subrs)}o._privateDict=u}a.push(o)}return a}function wl(t,e,r,n){var a,s,i=new N.Parser(t,e);r-=1;var o=[".notdef"],l=i.parseCard8();if(l===0)for(var c=0;c<r;c+=1)a=i.parseSID(),o.push(it(n,a));else if(l===1)for(;o.length<=r;){a=i.parseSID(),s=i.parseCard8();for(var u=0;u<=s;u+=1)o.push(it(n,a)),a+=1}else if(l===2)for(;o.length<=r;){a=i.parseSID(),s=i.parseCard16();for(var f=0;f<=s;f+=1)o.push(it(n,a)),a+=1}else throw new Error("Unknown charset format "+l);return o}function kl(t,e,r){var n,a={},s=new N.Parser(t,e),i=s.parseCard8();if(i===0)for(var o=s.parseCard8(),l=0;l<o;l+=1)n=s.parseCard8(),a[n]=l;else if(i===1){var c=s.parseCard8();n=1;for(var u=0;u<c;u+=1)for(var f=s.parseCard8(),h=s.parseCard8(),p=f;p<=f+h;p+=1)a[p]=n,n+=1}else throw new Error("Unknown encoding format "+i);return new Rt(a,r)}function Ur(t,e,r){var n,a,s,i,o=new oe,l=[],c=0,u=!1,f=!1,h=0,p=0,y,b,m,g;if(t.isCIDFont){var w=t.tables.cff.topDict._fdSelect[e.index],v=t.tables.cff.topDict._fdArray[w];y=v._subrs,b=v._subrsBias,m=v._defaultWidthX,g=v._nominalWidthX}else y=t.tables.cff.topDict._subrs,b=t.tables.cff.topDict._subrsBias,m=t.tables.cff.topDict._defaultWidthX,g=t.tables.cff.topDict._nominalWidthX;var S=m;function F(O,T){f&&o.closePath(),o.moveTo(O,T),f=!0}function B(){var O;O=l.length%2!==0,O&&!u&&(S=l.shift()+g),c+=l.length>>1,l.length=0,u=!0}function L(O){for(var T,x,C,V,j,z,q,Y,W,I,E,G,K=0;K<O.length;){var J=O[K];switch(K+=1,J){case 1:B();break;case 3:B();break;case 4:l.length>1&&!u&&(S=l.shift()+g,u=!0),p+=l.pop(),F(h,p);break;case 5:for(;l.length>0;)h+=l.shift(),p+=l.shift(),o.lineTo(h,p);break;case 6:for(;l.length>0&&(h+=l.shift(),o.lineTo(h,p),l.length!==0);)p+=l.shift(),o.lineTo(h,p);break;case 7:for(;l.length>0&&(p+=l.shift(),o.lineTo(h,p),l.length!==0);)h+=l.shift(),o.lineTo(h,p);break;case 8:for(;l.length>0;)n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i+l.shift(),o.curveTo(n,a,s,i,h,p);break;case 10:j=l.pop()+b,z=y[j],z&&L(z);break;case 11:return;case 12:switch(J=O[K],K+=1,J){case 35:n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),q=s+l.shift(),Y=i+l.shift(),W=q+l.shift(),I=Y+l.shift(),E=W+l.shift(),G=I+l.shift(),h=E+l.shift(),p=G+l.shift(),l.shift(),o.curveTo(n,a,s,i,q,Y),o.curveTo(W,I,E,G,h,p);break;case 34:n=h+l.shift(),a=p,s=n+l.shift(),i=a+l.shift(),q=s+l.shift(),Y=i,W=q+l.shift(),I=i,E=W+l.shift(),G=p,h=E+l.shift(),o.curveTo(n,a,s,i,q,Y),o.curveTo(W,I,E,G,h,p);break;case 36:n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),q=s+l.shift(),Y=i,W=q+l.shift(),I=i,E=W+l.shift(),G=I+l.shift(),h=E+l.shift(),o.curveTo(n,a,s,i,q,Y),o.curveTo(W,I,E,G,h,p);break;case 37:n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),q=s+l.shift(),Y=i+l.shift(),W=q+l.shift(),I=Y+l.shift(),E=W+l.shift(),G=I+l.shift(),Math.abs(E-h)>Math.abs(G-p)?h=E+l.shift():p=G+l.shift(),o.curveTo(n,a,s,i,q,Y),o.curveTo(W,I,E,G,h,p);break;default:console.log("Glyph "+e.index+": unknown operator 1200"+J),l.length=0}break;case 14:l.length>0&&!u&&(S=l.shift()+g,u=!0),f&&(o.closePath(),f=!1);break;case 18:B();break;case 19:case 20:B(),K+=c+7>>3;break;case 21:l.length>2&&!u&&(S=l.shift()+g,u=!0),p+=l.pop(),h+=l.pop(),F(h,p);break;case 22:l.length>1&&!u&&(S=l.shift()+g,u=!0),h+=l.pop(),F(h,p);break;case 23:B();break;case 24:for(;l.length>2;)n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i+l.shift(),o.curveTo(n,a,s,i,h,p);h+=l.shift(),p+=l.shift(),o.lineTo(h,p);break;case 25:for(;l.length>6;)h+=l.shift(),p+=l.shift(),o.lineTo(h,p);n=h+l.shift(),a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i+l.shift(),o.curveTo(n,a,s,i,h,p);break;case 26:for(l.length%2&&(h+=l.shift());l.length>0;)n=h,a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s,p=i+l.shift(),o.curveTo(n,a,s,i,h,p);break;case 27:for(l.length%2&&(p+=l.shift());l.length>0;)n=h+l.shift(),a=p,s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i,o.curveTo(n,a,s,i,h,p);break;case 28:T=O[K],x=O[K+1],l.push((T<<24|x<<16)>>16),K+=2;break;case 29:j=l.pop()+t.gsubrsBias,z=t.gsubrs[j],z&&L(z);break;case 30:for(;l.length>0&&(n=h,a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i+(l.length===1?l.shift():0),o.curveTo(n,a,s,i,h,p),l.length!==0);)n=h+l.shift(),a=p,s=n+l.shift(),i=a+l.shift(),p=i+l.shift(),h=s+(l.length===1?l.shift():0),o.curveTo(n,a,s,i,h,p);break;case 31:for(;l.length>0&&(n=h+l.shift(),a=p,s=n+l.shift(),i=a+l.shift(),p=i+l.shift(),h=s+(l.length===1?l.shift():0),o.curveTo(n,a,s,i,h,p),l.length!==0);)n=h,a=p+l.shift(),s=n+l.shift(),i=a+l.shift(),h=s+l.shift(),p=i+(l.length===1?l.shift():0),o.curveTo(n,a,s,i,h,p);break;default:J<32?console.log("Glyph "+e.index+": unknown operator "+J):J<247?l.push(J-139):J<251?(T=O[K],K+=1,l.push((J-247)*256+T+108)):J<255?(T=O[K],K+=1,l.push(-(J-251)*256-T-108)):(T=O[K],x=O[K+1],C=O[K+2],V=O[K+3],K+=4,l.push((T<<24|x<<16|C<<8|V)/65536))}}}return L(r),e.advanceWidth=S,o}function Sl(t,e,r,n){var a=[],s,i=new N.Parser(t,e),o=i.parseCard8();if(o===0)for(var l=0;l<r;l++){if(s=i.parseCard8(),s>=n)throw new Error("CFF table CID Font FDSelect has bad FD index value "+s+" (FD count "+n+")");a.push(s)}else if(o===3){var c=i.parseCard16(),u=i.parseCard16();if(u!==0)throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+u);for(var f,h=0;h<c;h++){if(s=i.parseCard8(),f=i.parseCard16(),s>=n)throw new Error("CFF table CID Font FDSelect has bad FD index value "+s+" (FD count "+n+")");if(f>r)throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+f);for(;u<f;u++)a.push(s);u=f}if(f!==r)throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+f)}else throw new Error("CFF Table CID Font FDSelect table has unsupported format "+o);return a}function Tl(t,e,r,n){r.tables.cff={};var a=bl(t,e),s=ze(t,a.endOffset,N.bytesToString),i=ze(t,s.endOffset),o=ze(t,i.endOffset,N.bytesToString),l=ze(t,o.endOffset);r.gsubrs=l.objects,r.gsubrsBias=er(r.gsubrs);var c=Er(t,e,i.objects,o.objects);if(c.length!==1)throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+c.length);var u=c[0];if(r.tables.cff.topDict=u,u._privateDict&&(r.defaultWidthX=u._privateDict.defaultWidthX,r.nominalWidthX=u._privateDict.nominalWidthX),u.ros[0]!==void 0&&u.ros[1]!==void 0&&(r.isCIDFont=!0),r.isCIDFont){var f=u.fdArray,h=u.fdSelect;if(f===0||h===0)throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing");f+=e;var p=ze(t,f),y=Er(t,e,p.objects,o.objects);u._fdArray=y,h+=e,u._fdSelect=Sl(t,h,r.numGlyphs,y.length)}var b=e+u.private[1],m=Cn(t,b,u.private[0],o.objects);if(r.defaultWidthX=m.defaultWidthX,r.nominalWidthX=m.nominalWidthX,m.subrs!==0){var g=b+m.subrs,w=ze(t,g);r.subrs=w.objects,r.subrsBias=er(r.subrs)}else r.subrs=[],r.subrsBias=0;var v;n.lowMemory?(v=pl(t,e+u.charStrings),r.nGlyphs=v.offsets.length):(v=ze(t,e+u.charStrings),r.nGlyphs=v.objects.length);var S=wl(t,e+u.charset,r.nGlyphs,o.objects);if(u.encoding===0?r.cffEncoding=new Rt(al,S):u.encoding===1?r.cffEncoding=new Rt(sl,S):r.cffEncoding=kl(t,e+u.encoding,S),r.encoding=r.encoding||r.cffEncoding,r.glyphs=new Le.GlyphSet(r),n.lowMemory)r._push=function(L){var O=gl(L,v.offsets,t,e+u.charStrings);r.glyphs.push(L,Le.cffGlyphLoader(r,L,Ur,O))};else for(var F=0;F<r.nGlyphs;F+=1){var B=v.objects[F];r.glyphs.push(F,Le.cffGlyphLoader(r,F,Ur,B))}}function _n(t,e){var r,n=Ct.indexOf(t);return n>=0&&(r=n),n=e.indexOf(t),n>=0?r=n+Ct.length:(r=Ct.length+e.length,e.push(t)),r}function Fl(){return new D.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function Cl(t){var e=new D.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);e.names=[];for(var r=0;r<t.length;r+=1)e.names.push({name:"name_"+r,type:"NAME",value:t[r]});return e}function En(t,e,r){for(var n={},a=0;a<t.length;a+=1){var s=t[a],i=e[s.name];i!==void 0&&!wn(i,s.value)&&(s.type==="SID"&&(i=_n(i,r)),n[s.op]={name:s.name,type:s.type,value:i})}return n}function Lr(t,e){var r=new D.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);return r.dict=En(Tn,t,e),r}function Or(t){var e=new D.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);return e.topDicts=[{name:"topDict_0",type:"TABLE",value:t}],e}function _l(t){var e=new D.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);e.strings=[];for(var r=0;r<t.length;r+=1)e.strings.push({name:"string_"+r,type:"STRING",value:t[r]});return e}function El(){return new D.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function Ul(t,e){for(var r=new D.Record("Charsets",[{name:"format",type:"Card8",value:0}]),n=0;n<t.length;n+=1){var a=t[n],s=_n(a,e);r.fields.push({name:"glyph_"+n,type:"SID",value:s})}return r}function Ll(t){var e=[],r=t.path;e.push({name:"width",type:"NUMBER",value:t.advanceWidth});for(var n=0,a=0,s=0;s<r.commands.length;s+=1){var i=void 0,o=void 0,l=r.commands[s];if(l.type==="Q"){var c=.3333333333333333,u=2/3;l={type:"C",x:l.x,y:l.y,x1:Math.round(c*n+u*l.x1),y1:Math.round(c*a+u*l.y1),x2:Math.round(c*l.x+u*l.x1),y2:Math.round(c*l.y+u*l.y1)}}if(l.type==="M")i=Math.round(l.x-n),o=Math.round(l.y-a),e.push({name:"dx",type:"NUMBER",value:i}),e.push({name:"dy",type:"NUMBER",value:o}),e.push({name:"rmoveto",type:"OP",value:21}),n=Math.round(l.x),a=Math.round(l.y);else if(l.type==="L")i=Math.round(l.x-n),o=Math.round(l.y-a),e.push({name:"dx",type:"NUMBER",value:i}),e.push({name:"dy",type:"NUMBER",value:o}),e.push({name:"rlineto",type:"OP",value:5}),n=Math.round(l.x),a=Math.round(l.y);else if(l.type==="C"){var f=Math.round(l.x1-n),h=Math.round(l.y1-a),p=Math.round(l.x2-l.x1),y=Math.round(l.y2-l.y1);i=Math.round(l.x-l.x2),o=Math.round(l.y-l.y2),e.push({name:"dx1",type:"NUMBER",value:f}),e.push({name:"dy1",type:"NUMBER",value:h}),e.push({name:"dx2",type:"NUMBER",value:p}),e.push({name:"dy2",type:"NUMBER",value:y}),e.push({name:"dx",type:"NUMBER",value:i}),e.push({name:"dy",type:"NUMBER",value:o}),e.push({name:"rrcurveto",type:"OP",value:8}),n=Math.round(l.x),a=Math.round(l.y)}}return e.push({name:"endchar",type:"OP",value:14}),e}function Ol(t){for(var e=new D.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]),r=0;r<t.length;r+=1){var n=t.get(r),a=Ll(n);e.charStrings.push({name:n.name,type:"CHARSTRING",value:a})}return e}function Bl(t,e){var r=new D.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);return r.dict=En(Fn,t,e),r}function Rl(t,e){for(var r=new D.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]),n=1/e.unitsPerEm,a={version:e.version,fullName:e.fullName,familyName:e.familyName,weight:e.weightName,fontBBox:e.fontBBox||[0,0,0,0],fontMatrix:[n,0,0,n,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]},s={},i=[],o,l=1;l<t.length;l+=1)o=t.get(l),i.push(o.name);var c=[];r.header=Fl(),r.nameIndex=Cl([e.postScriptName]);var u=Lr(a,c);r.topDictIndex=Or(u),r.globalSubrIndex=El(),r.charsets=Ul(i,c),r.charStringsIndex=Ol(t),r.privateDict=Bl(s,c),r.stringIndex=_l(c);var f=r.header.sizeOf()+r.nameIndex.sizeOf()+r.topDictIndex.sizeOf()+r.stringIndex.sizeOf()+r.globalSubrIndex.sizeOf();return a.charset=f,a.encoding=0,a.charStrings=a.charset+r.charsets.sizeOf(),a.private[1]=a.charStrings+r.charStringsIndex.sizeOf(),u=Lr(a,c),r.topDictIndex=Or(u),r}var Un={parse:Tl,make:Rl};function Al(t,e){var r={},n=new N.Parser(t,e);return r.version=n.parseVersion(),r.fontRevision=Math.round(n.parseFixed()*1e3)/1e3,r.checkSumAdjustment=n.parseULong(),r.magicNumber=n.parseULong(),$.argument(r.magicNumber===1594834165,"Font header has wrong magic number."),r.flags=n.parseUShort(),r.unitsPerEm=n.parseUShort(),r.created=n.parseLongDateTime(),r.modified=n.parseLongDateTime(),r.xMin=n.parseShort(),r.yMin=n.parseShort(),r.xMax=n.parseShort(),r.yMax=n.parseShort(),r.macStyle=n.parseUShort(),r.lowestRecPPEM=n.parseUShort(),r.fontDirectionHint=n.parseShort(),r.indexToLocFormat=n.parseShort(),r.glyphDataFormat=n.parseShort(),r}function Il(t){var e=Math.round(new Date().getTime()/1e3)+2082844800,r=e;return t.createdTimestamp&&(r=t.createdTimestamp+2082844800),new D.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:r},{name:"modified",type:"LONGDATETIME",value:e},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],t)}var Ln={parse:Al,make:Il};function Dl(t,e){var r={},n=new N.Parser(t,e);return r.version=n.parseVersion(),r.ascender=n.parseShort(),r.descender=n.parseShort(),r.lineGap=n.parseShort(),r.advanceWidthMax=n.parseUShort(),r.minLeftSideBearing=n.parseShort(),r.minRightSideBearing=n.parseShort(),r.xMaxExtent=n.parseShort(),r.caretSlopeRise=n.parseShort(),r.caretSlopeRun=n.parseShort(),r.caretOffset=n.parseShort(),n.relativeOffset+=8,r.metricDataFormat=n.parseShort(),r.numberOfHMetrics=n.parseUShort(),r}function Ml(t){return new D.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],t)}var On={parse:Dl,make:Ml};function Pl(t,e,r,n,a){for(var s,i,o=new N.Parser(t,e),l=0;l<n;l+=1){l<r&&(s=o.parseUShort(),i=o.parseShort());var c=a.get(l);c.advanceWidth=s,c.leftSideBearing=i}}function Nl(t,e,r,n,a){t._hmtxTableData={};for(var s,i,o=new N.Parser(e,r),l=0;l<a;l+=1)l<n&&(s=o.parseUShort(),i=o.parseShort()),t._hmtxTableData[l]={advanceWidth:s,leftSideBearing:i}}function Gl(t,e,r,n,a,s,i){i.lowMemory?Nl(t,e,r,n,a):Pl(e,r,n,a,s)}function zl(t){for(var e=new D.Table("hmtx",[]),r=0;r<t.length;r+=1){var n=t.get(r),a=n.advanceWidth||0,s=n.leftSideBearing||0;e.fields.push({name:"advanceWidth_"+r,type:"USHORT",value:a}),e.fields.push({name:"leftSideBearing_"+r,type:"SHORT",value:s})}return e}var Bn={parse:Gl,make:zl};function Vl(t){for(var e=new D.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:t.length}]),r="",n=12+t.length*4,a=0;a<t.length;++a){var s=r.indexOf(t[a]);s<0&&(s=r.length,r+=t[a]),e.fields.push({name:"offset "+a,type:"USHORT",value:n+s}),e.fields.push({name:"length "+a,type:"USHORT",value:t[a].length})}return e.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),e}function $l(t,e){var r=new N.Parser(t,e),n=r.parseULong();$.argument(n===1,"Unsupported ltag table version."),r.skip("uLong",1);for(var a=r.parseULong(),s=[],i=0;i<a;i++){for(var o="",l=e+r.parseUShort(),c=r.parseUShort(),u=l;u<l+c;++u)o+=String.fromCharCode(t.getInt8(u));s.push(o)}return s}var Rn={make:Vl,parse:$l};function Hl(t,e){var r={},n=new N.Parser(t,e);return r.version=n.parseVersion(),r.numGlyphs=n.parseUShort(),r.version===1&&(r.maxPoints=n.parseUShort(),r.maxContours=n.parseUShort(),r.maxCompositePoints=n.parseUShort(),r.maxCompositeContours=n.parseUShort(),r.maxZones=n.parseUShort(),r.maxTwilightPoints=n.parseUShort(),r.maxStorage=n.parseUShort(),r.maxFunctionDefs=n.parseUShort(),r.maxInstructionDefs=n.parseUShort(),r.maxStackElements=n.parseUShort(),r.maxSizeOfInstructions=n.parseUShort(),r.maxComponentElements=n.parseUShort(),r.maxComponentDepth=n.parseUShort()),r}function jl(t){return new D.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:t}])}var An={parse:Hl,make:jl},In=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],Dn={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},Wl={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0},Mn={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function Xl(t,e,r){switch(t){case 0:if(e===65535)return"und";if(r)return r[e];break;case 1:return Dn[e];case 3:return Mn[e]}}var tr="utf-16",ql={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},Yl={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function Pn(t,e,r){switch(t){case 0:return tr;case 1:return Yl[r]||ql[e];case 3:if(e===1||e===10)return tr;break}}function Kl(t,e,r){for(var n={},a=new N.Parser(t,e),s=a.parseUShort(),i=a.parseUShort(),o=a.offset+a.parseUShort(),l=0;l<i;l++){var c=a.parseUShort(),u=a.parseUShort(),f=a.parseUShort(),h=a.parseUShort(),p=In[h]||h,y=a.parseUShort(),b=a.parseUShort(),m=Xl(c,f,r),g=Pn(c,u,f);if(g!==void 0&&m!==void 0){var w=void 0;if(g===tr?w=tt.UTF16(t,o+b,y):w=tt.MACSTRING(t,o+b,y,g),w){var v=n[p];v===void 0&&(v=n[p]={}),v[m]=w}}}return s===1&&a.parseUShort(),n}function Gt(t){var e={};for(var r in t)e[t[r]]=parseInt(r);return e}function Br(t,e,r,n,a,s){return new D.Record("NameRecord",[{name:"platformID",type:"USHORT",value:t},{name:"encodingID",type:"USHORT",value:e},{name:"languageID",type:"USHORT",value:r},{name:"nameID",type:"USHORT",value:n},{name:"length",type:"USHORT",value:a},{name:"offset",type:"USHORT",value:s}])}function Zl(t,e){var r=t.length,n=e.length-r+1;e:for(var a=0;a<n;a++)for(;a<n;a++){for(var s=0;s<r;s++)if(e[a+s]!==t[s])continue e;return a}return-1}function Rr(t,e){var r=Zl(t,e);if(r<0){r=e.length;for(var n=0,a=t.length;n<a;++n)e.push(t[n])}return r}function Jl(t,e){var r,n=[],a={},s=Gt(In);for(var i in t){var o=s[i];if(o===void 0&&(o=i),r=parseInt(o),isNaN(r))throw new Error('Name table entry "'+i+'" does not exist, see nameTableNames for complete list.');a[r]=t[i],n.push(r)}for(var l=Gt(Dn),c=Gt(Mn),u=[],f=[],h=0;h<n.length;h++){r=n[h];var p=a[r];for(var y in p){var b=p[y],m=1,g=l[y],w=Wl[g],v=Pn(m,w,g),S=A.MACSTRING(b,v);S===void 0&&(m=0,g=e.indexOf(y),g<0&&(g=e.length,e.push(y)),w=4,S=A.UTF16(b));var F=Rr(S,f);u.push(Br(m,w,g,r,S.length,F));var B=c[y];if(B!==void 0){var L=A.UTF16(b),O=Rr(L,f);u.push(Br(3,1,B,r,L.length,O))}}}u.sort(function(C,V){return C.platformID-V.platformID||C.encodingID-V.encodingID||C.languageID-V.languageID||C.nameID-V.nameID});for(var T=new D.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:u.length},{name:"stringOffset",type:"USHORT",value:6+u.length*12}]),x=0;x<u.length;x++)T.fields.push({name:"record_"+x,type:"RECORD",value:u[x]});return T.fields.push({name:"strings",type:"LITERAL",value:f}),T}var Nn={parse:Kl,make:Jl},rr=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function Ql(t){for(var e=0;e<rr.length;e+=1){var r=rr[e];if(t>=r.begin&&t<r.end)return e}return-1}function eu(t,e){var r={},n=new N.Parser(t,e);r.version=n.parseUShort(),r.xAvgCharWidth=n.parseShort(),r.usWeightClass=n.parseUShort(),r.usWidthClass=n.parseUShort(),r.fsType=n.parseUShort(),r.ySubscriptXSize=n.parseShort(),r.ySubscriptYSize=n.parseShort(),r.ySubscriptXOffset=n.parseShort(),r.ySubscriptYOffset=n.parseShort(),r.ySuperscriptXSize=n.parseShort(),r.ySuperscriptYSize=n.parseShort(),r.ySuperscriptXOffset=n.parseShort(),r.ySuperscriptYOffset=n.parseShort(),r.yStrikeoutSize=n.parseShort(),r.yStrikeoutPosition=n.parseShort(),r.sFamilyClass=n.parseShort(),r.panose=[];for(var a=0;a<10;a++)r.panose[a]=n.parseByte();return r.ulUnicodeRange1=n.parseULong(),r.ulUnicodeRange2=n.parseULong(),r.ulUnicodeRange3=n.parseULong(),r.ulUnicodeRange4=n.parseULong(),r.achVendID=String.fromCharCode(n.parseByte(),n.parseByte(),n.parseByte(),n.parseByte()),r.fsSelection=n.parseUShort(),r.usFirstCharIndex=n.parseUShort(),r.usLastCharIndex=n.parseUShort(),r.sTypoAscender=n.parseShort(),r.sTypoDescender=n.parseShort(),r.sTypoLineGap=n.parseShort(),r.usWinAscent=n.parseUShort(),r.usWinDescent=n.parseUShort(),r.version>=1&&(r.ulCodePageRange1=n.parseULong(),r.ulCodePageRange2=n.parseULong()),r.version>=2&&(r.sxHeight=n.parseShort(),r.sCapHeight=n.parseShort(),r.usDefaultChar=n.parseUShort(),r.usBreakChar=n.parseUShort(),r.usMaxContent=n.parseUShort()),r}function tu(t){return new D.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],t)}var nr={parse:eu,make:tu,unicodeRanges:rr,getUnicodeRange:Ql};function ru(t,e){var r={},n=new N.Parser(t,e);switch(r.version=n.parseVersion(),r.italicAngle=n.parseFixed(),r.underlinePosition=n.parseShort(),r.underlineThickness=n.parseShort(),r.isFixedPitch=n.parseULong(),r.minMemType42=n.parseULong(),r.maxMemType42=n.parseULong(),r.minMemType1=n.parseULong(),r.maxMemType1=n.parseULong(),r.version){case 1:r.names=qe.slice();break;case 2:r.numberOfGlyphs=n.parseUShort(),r.glyphNameIndex=new Array(r.numberOfGlyphs);for(var a=0;a<r.numberOfGlyphs;a++)r.glyphNameIndex[a]=n.parseUShort();r.names=[];for(var s=0;s<r.numberOfGlyphs;s++)if(r.glyphNameIndex[s]>=qe.length){var i=n.parseChar();r.names.push(n.parseString(i))}break;case 2.5:r.numberOfGlyphs=n.parseUShort(),r.offset=new Array(r.numberOfGlyphs);for(var o=0;o<r.numberOfGlyphs;o++)r.offset[o]=n.parseChar();break}return r}function nu(){return new D.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var Gn={parse:ru,make:nu},we=new Array(9);we[1]=function(){var e=this.offset+this.relativeOffset,r=this.parseUShort();if(r===1)return{substFormat:1,coverage:this.parsePointer(k.coverage),deltaGlyphId:this.parseUShort()};if(r===2)return{substFormat:2,coverage:this.parsePointer(k.coverage),substitute:this.parseOffset16List()};$.assert(!1,"0x"+e.toString(16)+": lookup type 1 format must be 1 or 2.")};we[2]=function(){var e=this.parseUShort();return $.argument(e===1,"GSUB Multiple Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(k.coverage),sequences:this.parseListOfLists()}};we[3]=function(){var e=this.parseUShort();return $.argument(e===1,"GSUB Alternate Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(k.coverage),alternateSets:this.parseListOfLists()}};we[4]=function(){var e=this.parseUShort();return $.argument(e===1,"GSUB ligature table identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(k.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var Qe={sequenceIndex:k.uShort,lookupListIndex:k.uShort};we[5]=function(){var e=this.offset+this.relativeOffset,r=this.parseUShort();if(r===1)return{substFormat:r,coverage:this.parsePointer(k.coverage),ruleSets:this.parseListOfLists(function(){var s=this.parseUShort(),i=this.parseUShort();return{input:this.parseUShortList(s-1),lookupRecords:this.parseRecordList(i,Qe)}})};if(r===2)return{substFormat:r,coverage:this.parsePointer(k.coverage),classDef:this.parsePointer(k.classDef),classSets:this.parseListOfLists(function(){var s=this.parseUShort(),i=this.parseUShort();return{classes:this.parseUShortList(s-1),lookupRecords:this.parseRecordList(i,Qe)}})};if(r===3){var n=this.parseUShort(),a=this.parseUShort();return{substFormat:r,coverages:this.parseList(n,k.pointer(k.coverage)),lookupRecords:this.parseRecordList(a,Qe)}}$.assert(!1,"0x"+e.toString(16)+": lookup type 5 format must be 1, 2 or 3.")};we[6]=function(){var e=this.offset+this.relativeOffset,r=this.parseUShort();if(r===1)return{substFormat:1,coverage:this.parsePointer(k.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Qe)}})};if(r===2)return{substFormat:2,coverage:this.parsePointer(k.coverage),backtrackClassDef:this.parsePointer(k.classDef),inputClassDef:this.parsePointer(k.classDef),lookaheadClassDef:this.parsePointer(k.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Qe)}})};if(r===3)return{substFormat:3,backtrackCoverage:this.parseList(k.pointer(k.coverage)),inputCoverage:this.parseList(k.pointer(k.coverage)),lookaheadCoverage:this.parseList(k.pointer(k.coverage)),lookupRecords:this.parseRecordList(Qe)};$.assert(!1,"0x"+e.toString(16)+": lookup type 6 format must be 1, 2 or 3.")};we[7]=function(){var e=this.parseUShort();$.argument(e===1,"GSUB Extension Substitution subtable identifier-format must be 1");var r=this.parseUShort(),n=new k(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:r,extension:we[r].call(n)}};we[8]=function(){var e=this.parseUShort();return $.argument(e===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(k.coverage),backtrackCoverage:this.parseList(k.pointer(k.coverage)),lookaheadCoverage:this.parseList(k.pointer(k.coverage)),substitutes:this.parseUShortList()}};function au(t,e){e=e||0;var r=new k(t,e),n=r.parseVersion(1);return $.argument(n===1||n===1.1,"Unsupported GSUB table version."),n===1?{version:n,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(we)}:{version:n,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(we),variations:r.parseFeatureVariationsList()}}var rt=new Array(9);rt[1]=function(e){return e.substFormat===1?new D.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)},{name:"deltaGlyphID",type:"USHORT",value:e.deltaGlyphId}]):new D.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)}].concat(D.ushortList("substitute",e.substitute)))};rt[2]=function(e){return $.assert(e.substFormat===1,"Lookup type 2 substFormat must be 1."),new D.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)}].concat(D.tableList("seqSet",e.sequences,function(r){return new D.Table("sequenceSetTable",D.ushortList("sequence",r))})))};rt[3]=function(e){return $.assert(e.substFormat===1,"Lookup type 3 substFormat must be 1."),new D.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)}].concat(D.tableList("altSet",e.alternateSets,function(r){return new D.Table("alternateSetTable",D.ushortList("alternate",r))})))};rt[4]=function(e){return $.assert(e.substFormat===1,"Lookup type 4 substFormat must be 1."),new D.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)}].concat(D.tableList("ligSet",e.ligatureSets,function(r){return new D.Table("ligatureSetTable",D.tableList("ligature",r,function(n){return new D.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:n.ligGlyph}].concat(D.ushortList("component",n.components,n.components.length+1)))}))})))};rt[6]=function(e){if(e.substFormat===1){var r=new D.Table("chainContextTable",[{name:"substFormat",type:"USHORT",value:e.substFormat},{name:"coverage",type:"TABLE",value:new D.Coverage(e.coverage)}].concat(D.tableList("chainRuleSet",e.chainRuleSets,function(s){return new D.Table("chainRuleSetTable",D.tableList("chainRule",s,function(i){var o=D.ushortList("backtrackGlyph",i.backtrack,i.backtrack.length).concat(D.ushortList("inputGlyph",i.input,i.input.length+1)).concat(D.ushortList("lookaheadGlyph",i.lookahead,i.lookahead.length)).concat(D.ushortList("substitution",[],i.lookupRecords.length));return i.lookupRecords.forEach(function(l,c){o=o.concat({name:"sequenceIndex"+c,type:"USHORT",value:l.sequenceIndex}).concat({name:"lookupListIndex"+c,type:"USHORT",value:l.lookupListIndex})}),new D.Table("chainRuleTable",o)}))})));return r}else if(e.substFormat===2)$.assert(!1,"lookup type 6 format 2 is not yet supported.");else if(e.substFormat===3){var n=[{name:"substFormat",type:"USHORT",value:e.substFormat}];n.push({name:"backtrackGlyphCount",type:"USHORT",value:e.backtrackCoverage.length}),e.backtrackCoverage.forEach(function(s,i){n.push({name:"backtrackCoverage"+i,type:"TABLE",value:new D.Coverage(s)})}),n.push({name:"inputGlyphCount",type:"USHORT",value:e.inputCoverage.length}),e.inputCoverage.forEach(function(s,i){n.push({name:"inputCoverage"+i,type:"TABLE",value:new D.Coverage(s)})}),n.push({name:"lookaheadGlyphCount",type:"USHORT",value:e.lookaheadCoverage.length}),e.lookaheadCoverage.forEach(function(s,i){n.push({name:"lookaheadCoverage"+i,type:"TABLE",value:new D.Coverage(s)})}),n.push({name:"substitutionCount",type:"USHORT",value:e.lookupRecords.length}),e.lookupRecords.forEach(function(s,i){n=n.concat({name:"sequenceIndex"+i,type:"USHORT",value:s.sequenceIndex}).concat({name:"lookupListIndex"+i,type:"USHORT",value:s.lookupListIndex})});var a=new D.Table("chainContextTable",n);return a}$.assert(!1,"lookup type 6 format must be 1, 2 or 3.")};function su(t){return new D.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new D.ScriptList(t.scripts)},{name:"features",type:"TABLE",value:new D.FeatureList(t.features)},{name:"lookups",type:"TABLE",value:new D.LookupList(t.lookups,rt)}])}var zn={parse:au,make:su};function iu(t,e){var r=new N.Parser(t,e),n=r.parseULong();$.argument(n===1,"Unsupported META table version."),r.parseULong(),r.parseULong();for(var a=r.parseULong(),s={},i=0;i<a;i++){var o=r.parseTag(),l=r.parseULong(),c=r.parseULong(),u=tt.UTF8(t,e+l,c);s[o]=u}return s}function ou(t){var e=Object.keys(t).length,r="",n=16+e*12,a=new D.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:n},{name:"numTags",type:"ULONG",value:e}]);for(var s in t){var i=r.length;r+=t[s],a.fields.push({name:"tag "+s,type:"TAG",value:s}),a.fields.push({name:"offset "+s,type:"ULONG",value:n+i}),a.fields.push({name:"length "+s,type:"ULONG",value:t[s].length})}return a.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),a}var Vn={parse:iu,make:ou};function Ar(t){return Math.log(t)/Math.log(2)|0}function fr(t){for(;t.length%4!==0;)t.push(0);for(var e=0,r=0;r<t.length;r+=4)e+=(t[r]<<24)+(t[r+1]<<16)+(t[r+2]<<8)+t[r+3];return e%=Math.pow(2,32),e}function Ir(t,e,r,n){return new D.Record("Table Record",[{name:"tag",type:"TAG",value:t!==void 0?t:""},{name:"checkSum",type:"ULONG",value:e!==void 0?e:0},{name:"offset",type:"ULONG",value:r!==void 0?r:0},{name:"length",type:"ULONG",value:n!==void 0?n:0}])}function $n(t){var e=new D.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);e.tables=t,e.numTables=t.length;var r=Math.pow(2,Ar(e.numTables));e.searchRange=16*r,e.entrySelector=Ar(r),e.rangeShift=e.numTables*16-e.searchRange;for(var n=[],a=[],s=e.sizeOf()+Ir().sizeOf()*e.numTables;s%4!==0;)s+=1,a.push({name:"padding",type:"BYTE",value:0});for(var i=0;i<t.length;i+=1){var o=t[i];$.argument(o.tableName.length===4,"Table name"+o.tableName+" is invalid.");var l=o.sizeOf(),c=Ir(o.tableName,fr(o.encode()),s,l);for(n.push({name:c.tag+" Table Record",type:"RECORD",value:c}),a.push({name:o.tableName+" table",type:"RECORD",value:o}),s+=l,$.argument(!isNaN(s),"Something went wrong calculating the offset.");s%4!==0;)s+=1,a.push({name:"padding",type:"BYTE",value:0})}return n.sort(function(u,f){return u.value.tag>f.value.tag?1:-1}),e.fields=e.fields.concat(n),e.fields=e.fields.concat(a),e}function Dr(t,e,r){for(var n=0;n<e.length;n+=1){var a=t.charToGlyphIndex(e[n]);if(a>0){var s=t.glyphs.get(a);return s.getMetrics()}}return r}function lu(t){for(var e=0,r=0;r<t.length;r+=1)e+=t[r];return e/t.length}function uu(t){for(var e=[],r=[],n=[],a=[],s=[],i=[],o=[],l,c=0,u=0,f=0,h=0,p=0,y=0;y<t.glyphs.length;y+=1){var b=t.glyphs.get(y),m=b.unicode|0;if(isNaN(b.advanceWidth))throw new Error("Glyph "+b.name+" ("+y+"): advanceWidth is not a number.");(l>m||l===void 0)&&m>0&&(l=m),c<m&&(c=m);var g=nr.getUnicodeRange(m);if(g<32)u|=1<<g;else if(g<64)f|=1<<g-32;else if(g<96)h|=1<<g-64;else if(g<123)p|=1<<g-96;else throw new Error("Unicode ranges bits > 123 are reserved for internal usage");if(b.name!==".notdef"){var w=b.getMetrics();e.push(w.xMin),r.push(w.yMin),n.push(w.xMax),a.push(w.yMax),i.push(w.leftSideBearing),o.push(w.rightSideBearing),s.push(b.advanceWidth)}}var v={xMin:Math.min.apply(null,e),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,n),yMax:Math.max.apply(null,a),advanceWidthMax:Math.max.apply(null,s),advanceWidthAvg:lu(s),minLeftSideBearing:Math.min.apply(null,i),maxLeftSideBearing:Math.max.apply(null,i),minRightSideBearing:Math.min.apply(null,o)};v.ascender=t.ascender,v.descender=t.descender;var S=Ln.make({flags:3,unitsPerEm:t.unitsPerEm,xMin:v.xMin,yMin:v.yMin,xMax:v.xMax,yMax:v.yMax,lowestRecPPEM:3,createdTimestamp:t.createdTimestamp}),F=On.make({ascender:v.ascender,descender:v.descender,advanceWidthMax:v.advanceWidthMax,minLeftSideBearing:v.minLeftSideBearing,minRightSideBearing:v.minRightSideBearing,xMaxExtent:v.maxLeftSideBearing+(v.xMax-v.xMin),numberOfHMetrics:t.glyphs.length}),B=An.make(t.glyphs.length),L=nr.make(Object.assign({xAvgCharWidth:Math.round(v.advanceWidthAvg),usFirstCharIndex:l,usLastCharIndex:c,ulUnicodeRange1:u,ulUnicodeRange2:f,ulUnicodeRange3:h,ulUnicodeRange4:p,sTypoAscender:v.ascender,sTypoDescender:v.descender,sTypoLineGap:0,usWinAscent:v.yMax,usWinDescent:Math.abs(v.yMin),ulCodePageRange1:1,sxHeight:Dr(t,"xyvw",{yMax:Math.round(v.ascender/2)}).yMax,sCapHeight:Dr(t,"HIKLEFJMNTZBDPRAGOQSUVWXY",v).yMax,usDefaultChar:t.hasChar(" ")?32:0,usBreakChar:t.hasChar(" ")?32:0},t.tables.os2)),O=Bn.make(t.glyphs),T=yn.make(t.glyphs),x=t.getEnglishName("fontFamily"),C=t.getEnglishName("fontSubfamily"),V=x+" "+C,j=t.getEnglishName("postScriptName");j||(j=x.replace(/\s/g,"")+"-"+C);var z={};for(var q in t.names)z[q]=t.names[q];z.uniqueID||(z.uniqueID={en:t.getEnglishName("manufacturer")+":"+V}),z.postScriptName||(z.postScriptName={en:j}),z.preferredFamily||(z.preferredFamily=t.names.fontFamily),z.preferredSubfamily||(z.preferredSubfamily=t.names.fontSubfamily);var Y=[],W=Nn.make(z,Y),I=Y.length>0?Rn.make(Y):void 0,E=Gn.make(),G=Un.make(t.glyphs,{version:t.getEnglishName("version"),fullName:V,familyName:x,weightName:C,postScriptName:j,unitsPerEm:t.unitsPerEm,fontBBox:[0,v.yMin,v.ascender,v.advanceWidthMax]}),K=t.metas&&Object.keys(t.metas).length>0?Vn.make(t.metas):void 0,J=[S,F,B,L,W,T,E,G,O];I&&J.push(I),t.tables.gsub&&J.push(zn.make(t.tables.gsub)),K&&J.push(K);for(var Oe=$n(J),Pe=Oe.encode(),ee=fr(Pe),fe=Oe.fields,vt=!1,yt=0;yt<fe.length;yt+=1)if(fe[yt].name==="head table"){fe[yt].value.checkSumAdjustment=2981146554-ee,vt=!0;break}if(!vt)throw new Error("Could not find head table with checkSum to adjust.");return Oe}var cu={make:$n,fontToTable:uu,computeCheckSum:fr};function zt(t,e){for(var r=0,n=t.length-1;r<=n;){var a=r+n>>>1,s=t[a].tag;if(s===e)return a;s<e?r=a+1:n=a-1}return-r-1}function Mr(t,e){for(var r=0,n=t.length-1;r<=n;){var a=r+n>>>1,s=t[a];if(s===e)return a;s<e?r=a+1:n=a-1}return-r-1}function Pr(t,e){for(var r,n=0,a=t.length-1;n<=a;){var s=n+a>>>1;r=t[s];var i=r.start;if(i===e)return r;i<e?n=s+1:a=s-1}if(n>0)return r=t[n-1],e>r.end?0:r}function dt(t,e){this.font=t,this.tableName=e}dt.prototype={searchTag:zt,binSearch:Mr,getTable:function(t){var e=this.font.tables[this.tableName];return!e&&t&&(e=this.font.tables[this.tableName]=this.createDefaultTable()),e},getScriptNames:function(){var t=this.getTable();return t?t.scripts.map(function(e){return e.tag}):[]},getDefaultScriptName:function(){var t=this.getTable();if(t){for(var e=!1,r=0;r<t.scripts.length;r++){var n=t.scripts[r].tag;if(n==="DFLT")return n;n==="latn"&&(e=!0)}if(e)return"latn"}},getScriptTable:function(t,e){var r=this.getTable(e);if(r){t=t||"DFLT";var n=r.scripts,a=zt(r.scripts,t);if(a>=0)return n[a].script;if(e){var s={tag:t,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};return n.splice(-1-a,0,s),s.script}}},getLangSysTable:function(t,e,r){var n=this.getScriptTable(t,r);if(n){if(!e||e==="dflt"||e==="DFLT")return n.defaultLangSys;var a=zt(n.langSysRecords,e);if(a>=0)return n.langSysRecords[a].langSys;if(r){var s={tag:e,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};return n.langSysRecords.splice(-1-a,0,s),s.langSys}}},getFeatureTable:function(t,e,r,n){var a=this.getLangSysTable(t,e,n);if(a){for(var s,i=a.featureIndexes,o=this.font.tables[this.tableName].features,l=0;l<i.length;l++)if(s=o[i[l]],s.tag===r)return s.feature;if(n){var c=o.length;return $.assert(c===0||r>=o[c-1].tag,"Features must be added in alphabetical order."),s={tag:r,feature:{params:0,lookupListIndexes:[]}},o.push(s),i.push(c),s.feature}}},getLookupTables:function(t,e,r,n,a){var s=this.getFeatureTable(t,e,r,a),i=[];if(s){for(var o,l=s.lookupListIndexes,c=this.font.tables[this.tableName].lookups,u=0;u<l.length;u++)o=c[l[u]],o.lookupType===n&&i.push(o);if(i.length===0&&a){o={lookupType:n,lookupFlag:0,subtables:[],markFilteringSet:void 0};var f=c.length;return c.push(o),l.push(f),[o]}}return i},getGlyphClass:function(t,e){switch(t.format){case 1:return t.startGlyph<=e&&e<t.startGlyph+t.classes.length?t.classes[e-t.startGlyph]:0;case 2:var r=Pr(t.ranges,e);return r?r.classId:0}},getCoverageIndex:function(t,e){switch(t.format){case 1:var r=Mr(t.glyphs,e);return r>=0?r:-1;case 2:var n=Pr(t.ranges,e);return n?n.index+e-n.start:-1}},expandCoverage:function(t){if(t.format===1)return t.glyphs;for(var e=[],r=t.ranges,n=0;n<r.length;n++)for(var a=r[n],s=a.start,i=a.end,o=s;o<=i;o++)e.push(o);return e}};function ft(t){dt.call(this,t,"gpos")}ft.prototype=dt.prototype;ft.prototype.init=function(){var t=this.getDefaultScriptName();this.defaultKerningTables=this.getKerningTables(t)};ft.prototype.getKerningValue=function(t,e,r){for(var n=0;n<t.length;n++)for(var a=t[n].subtables,s=0;s<a.length;s++){var i=a[s],o=this.getCoverageIndex(i.coverage,e);if(!(o<0))switch(i.posFormat){case 1:for(var l=i.pairSets[o],c=0;c<l.length;c++){var u=l[c];if(u.secondGlyph===r)return u.value1&&u.value1.xAdvance||0}break;case 2:var f=this.getGlyphClass(i.classDef1,e),h=this.getGlyphClass(i.classDef2,r),p=i.classRecords[f][h];return p.value1&&p.value1.xAdvance||0}}return 0};ft.prototype.getKerningTables=function(t,e){if(this.font.tables.gpos)return this.getLookupTables(t,e,"kern",2)};function me(t){dt.call(this,t,"gsub")}function hu(t,e){var r=t.length;if(r!==e.length)return!1;for(var n=0;n<r;n++)if(t[n]!==e[n])return!1;return!0}function pr(t,e,r){for(var n=t.subtables,a=0;a<n.length;a++){var s=n[a];if(s.substFormat===e)return s}if(r)return n.push(r),r}me.prototype=dt.prototype;me.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}};me.prototype.getSingle=function(t,e,r){for(var n=[],a=this.getLookupTables(e,r,t,1),s=0;s<a.length;s++)for(var i=a[s].subtables,o=0;o<i.length;o++){var l=i[o],c=this.expandCoverage(l.coverage),u=void 0;if(l.substFormat===1){var f=l.deltaGlyphId;for(u=0;u<c.length;u++){var h=c[u];n.push({sub:h,by:h+f})}}else{var p=l.substitute;for(u=0;u<c.length;u++)n.push({sub:c[u],by:p[u]})}}return n};me.prototype.getMultiple=function(t,e,r){for(var n=[],a=this.getLookupTables(e,r,t,2),s=0;s<a.length;s++)for(var i=a[s].subtables,o=0;o<i.length;o++){var l=i[o],c=this.expandCoverage(l.coverage),u=void 0;for(u=0;u<c.length;u++){var f=c[u],h=l.sequences[u];n.push({sub:f,by:h})}}return n};me.prototype.getAlternates=function(t,e,r){for(var n=[],a=this.getLookupTables(e,r,t,3),s=0;s<a.length;s++)for(var i=a[s].subtables,o=0;o<i.length;o++)for(var l=i[o],c=this.expandCoverage(l.coverage),u=l.alternateSets,f=0;f<c.length;f++)n.push({sub:c[f],by:u[f]});return n};me.prototype.getLigatures=function(t,e,r){for(var n=[],a=this.getLookupTables(e,r,t,4),s=0;s<a.length;s++)for(var i=a[s].subtables,o=0;o<i.length;o++)for(var l=i[o],c=this.expandCoverage(l.coverage),u=l.ligatureSets,f=0;f<c.length;f++)for(var h=c[f],p=u[f],y=0;y<p.length;y++){var b=p[y];n.push({sub:[h].concat(b.components),by:b.ligGlyph})}return n};me.prototype.addSingle=function(t,e,r,n){var a=this.getLookupTables(r,n,t,1,!0)[0],s=pr(a,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});$.assert(s.coverage.format===1,"Single: unable to modify coverage table format "+s.coverage.format);var i=e.sub,o=this.binSearch(s.coverage.glyphs,i);o<0&&(o=-1-o,s.coverage.glyphs.splice(o,0,i),s.substitute.splice(o,0,0)),s.substitute[o]=e.by};me.prototype.addMultiple=function(t,e,r,n){$.assert(e.by instanceof Array&&e.by.length>1,'Multiple: "by" must be an array of two or more ids');var a=this.getLookupTables(r,n,t,2,!0)[0],s=pr(a,1,{substFormat:1,coverage:{format:1,glyphs:[]},sequences:[]});$.assert(s.coverage.format===1,"Multiple: unable to modify coverage table format "+s.coverage.format);var i=e.sub,o=this.binSearch(s.coverage.glyphs,i);o<0&&(o=-1-o,s.coverage.glyphs.splice(o,0,i),s.sequences.splice(o,0,0)),s.sequences[o]=e.by};me.prototype.addAlternate=function(t,e,r,n){var a=this.getLookupTables(r,n,t,3,!0)[0],s=pr(a,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});$.assert(s.coverage.format===1,"Alternate: unable to modify coverage table format "+s.coverage.format);var i=e.sub,o=this.binSearch(s.coverage.glyphs,i);o<0&&(o=-1-o,s.coverage.glyphs.splice(o,0,i),s.alternateSets.splice(o,0,0)),s.alternateSets[o]=e.by};me.prototype.addLigature=function(t,e,r,n){var a=this.getLookupTables(r,n,t,4,!0)[0],s=a.subtables[0];s||(s={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]},a.subtables[0]=s),$.assert(s.coverage.format===1,"Ligature: unable to modify coverage table format "+s.coverage.format);var i=e.sub[0],o=e.sub.slice(1),l={ligGlyph:e.by,components:o},c=this.binSearch(s.coverage.glyphs,i);if(c>=0){for(var u=s.ligatureSets[c],f=0;f<u.length;f++)if(hu(u[f].components,o))return;u.push(l)}else c=-1-c,s.coverage.glyphs.splice(c,0,i),s.ligatureSets.splice(c,0,[l])};me.prototype.getFeature=function(t,e,r){if(/ss\d\d/.test(t))return this.getSingle(t,e,r);switch(t){case"aalt":case"salt":return this.getSingle(t,e,r).concat(this.getAlternates(t,e,r));case"dlig":case"liga":case"rlig":return this.getLigatures(t,e,r);case"ccmp":return this.getMultiple(t,e,r).concat(this.getLigatures(t,e,r));case"stch":return this.getMultiple(t,e,r)}};me.prototype.add=function(t,e,r,n){if(/ss\d\d/.test(t))return this.addSingle(t,e,r,n);switch(t){case"aalt":case"salt":return typeof e.by=="number"?this.addSingle(t,e,r,n):this.addAlternate(t,e,r,n);case"dlig":case"liga":case"rlig":return this.addLigature(t,e,r,n);case"ccmp":return e.by instanceof Array?this.addMultiple(t,e,r,n):this.addLigature(t,e,r,n)}};function du(){return typeof window<"u"}function Hn(t){for(var e=new ArrayBuffer(t.length),r=new Uint8Array(e),n=0;n<t.length;++n)r[n]=t[n];return e}function fu(t){for(var e=new Buffer(t.byteLength),r=new Uint8Array(t),n=0;n<e.length;++n)e[n]=r[n];return e}function at(t,e){if(!t)throw e}function Nr(t,e,r,n,a){var s;return(e&n)>0?(s=t.parseByte(),e&a||(s=-s),s=r+s):(e&a)>0?s=r:s=r+t.parseShort(),s}function jn(t,e,r){var n=new N.Parser(e,r);t.numberOfContours=n.parseShort(),t._xMin=n.parseShort(),t._yMin=n.parseShort(),t._xMax=n.parseShort(),t._yMax=n.parseShort();var a,s;if(t.numberOfContours>0){for(var i=t.endPointIndices=[],o=0;o<t.numberOfContours;o+=1)i.push(n.parseUShort());t.instructionLength=n.parseUShort(),t.instructions=[];for(var l=0;l<t.instructionLength;l+=1)t.instructions.push(n.parseByte());var c=i[i.length-1]+1;a=[];for(var u=0;u<c;u+=1)if(s=n.parseByte(),a.push(s),(s&8)>0)for(var f=n.parseByte(),h=0;h<f;h+=1)a.push(s),u+=1;if($.argument(a.length===c,"Bad flags."),i.length>0){var p=[],y;if(c>0){for(var b=0;b<c;b+=1)s=a[b],y={},y.onCurve=!!(s&1),y.lastPointOfContour=i.indexOf(b)>=0,p.push(y);for(var m=0,g=0;g<c;g+=1)s=a[g],y=p[g],y.x=Nr(n,s,m,2,16),m=y.x;for(var w=0,v=0;v<c;v+=1)s=a[v],y=p[v],y.y=Nr(n,s,w,4,32),w=y.y}t.points=p}else t.points=[]}else if(t.numberOfContours===0)t.points=[];else{t.isComposite=!0,t.points=[],t.components=[];for(var S=!0;S;){a=n.parseUShort();var F={glyphIndex:n.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};(a&1)>0?(a&2)>0?(F.dx=n.parseShort(),F.dy=n.parseShort()):F.matchedPoints=[n.parseUShort(),n.parseUShort()]:(a&2)>0?(F.dx=n.parseChar(),F.dy=n.parseChar()):F.matchedPoints=[n.parseByte(),n.parseByte()],(a&8)>0?F.xScale=F.yScale=n.parseF2Dot14():(a&64)>0?(F.xScale=n.parseF2Dot14(),F.yScale=n.parseF2Dot14()):(a&128)>0&&(F.xScale=n.parseF2Dot14(),F.scale01=n.parseF2Dot14(),F.scale10=n.parseF2Dot14(),F.yScale=n.parseF2Dot14()),t.components.push(F),S=!!(a&32)}if(a&256){t.instructionLength=n.parseUShort(),t.instructions=[];for(var B=0;B<t.instructionLength;B+=1)t.instructions.push(n.parseByte())}}}function Vt(t,e){for(var r=[],n=0;n<t.length;n+=1){var a=t[n],s={x:e.xScale*a.x+e.scale01*a.y+e.dx,y:e.scale10*a.x+e.yScale*a.y+e.dy,onCurve:a.onCurve,lastPointOfContour:a.lastPointOfContour};r.push(s)}return r}function pu(t){for(var e=[],r=[],n=0;n<t.length;n+=1){var a=t[n];r.push(a),a.lastPointOfContour&&(e.push(r),r=[])}return $.argument(r.length===0,"There are still points left in the current contour."),e}function Wn(t){var e=new oe;if(!t)return e;for(var r=pu(t),n=0;n<r.length;++n){var a=r[n],s=null,i=a[a.length-1],o=a[0];if(i.onCurve)e.moveTo(i.x,i.y);else if(o.onCurve)e.moveTo(o.x,o.y);else{var l={x:(i.x+o.x)*.5,y:(i.y+o.y)*.5};e.moveTo(l.x,l.y)}for(var c=0;c<a.length;++c)if(s=i,i=o,o=a[(c+1)%a.length],i.onCurve)e.lineTo(i.x,i.y);else{var u=o;s.onCurve||((i.x+s.x)*.5,(i.y+s.y)*.5),o.onCurve||(u={x:(i.x+o.x)*.5,y:(i.y+o.y)*.5}),e.quadraticCurveTo(i.x,i.y,u.x,u.y)}e.closePath()}return e}function Xn(t,e){if(e.isComposite)for(var r=0;r<e.components.length;r+=1){var n=e.components[r],a=t.get(n.glyphIndex);if(a.getPath(),a.points){var s=void 0;if(n.matchedPoints===void 0)s=Vt(a.points,n);else{if(n.matchedPoints[0]>e.points.length-1||n.matchedPoints[1]>a.points.length-1)throw Error("Matched points out of range in "+e.name);var i=e.points[n.matchedPoints[0]],o=a.points[n.matchedPoints[1]],l={xScale:n.xScale,scale01:n.scale01,scale10:n.scale10,yScale:n.yScale,dx:0,dy:0};o=Vt([o],l)[0],l.dx=i.x-o.x,l.dy=i.y-o.y,s=Vt(a.points,l)}e.points=e.points.concat(s)}}return Wn(e.points)}function gu(t,e,r,n){for(var a=new Le.GlyphSet(n),s=0;s<r.length-1;s+=1){var i=r[s],o=r[s+1];i!==o?a.push(s,Le.ttfGlyphLoader(n,s,jn,t,e+i,Xn)):a.push(s,Le.glyphLoader(n,s))}return a}function mu(t,e,r,n){var a=new Le.GlyphSet(n);return n._push=function(s){var i=r[s],o=r[s+1];i!==o?a.push(s,Le.ttfGlyphLoader(n,s,jn,t,e+i,Xn)):a.push(s,Le.glyphLoader(n,s))},a}function vu(t,e,r,n,a){return a.lowMemory?mu(t,e,r,n):gu(t,e,r,n)}var qn={getPath:Wn,parse:vu},Yn,Ze,Kn,ar;function Zn(t){this.font=t,this.getCommands=function(e){return qn.getPath(e).commands},this._fpgmState=this._prepState=void 0,this._errorState=0}function yu(t){return t}function Jn(t){return Math.sign(t)*Math.round(Math.abs(t))}function bu(t){return Math.sign(t)*Math.round(Math.abs(t*2))/2}function xu(t){return Math.sign(t)*(Math.round(Math.abs(t)+.5)-.5)}function wu(t){return Math.sign(t)*Math.ceil(Math.abs(t))}function ku(t){return Math.sign(t)*Math.floor(Math.abs(t))}var Qn=function(t){var e=this.srPeriod,r=this.srPhase,n=this.srThreshold,a=1;return t<0&&(t=-t,a=-1),t+=n-r,t=Math.trunc(t/e)*e,t+=r,t<0?r*a:t*a},Ue={x:1,y:0,axis:"x",distance:function(t,e,r,n){return(r?t.xo:t.x)-(n?e.xo:e.x)},interpolate:function(t,e,r,n){var a,s,i,o,l,c,u;if(!n||n===this){if(a=t.xo-e.xo,s=t.xo-r.xo,l=e.x-e.xo,c=r.x-r.xo,i=Math.abs(a),o=Math.abs(s),u=i+o,u===0){t.x=t.xo+(l+c)/2;return}t.x=t.xo+(l*o+c*i)/u;return}if(a=n.distance(t,e,!0,!0),s=n.distance(t,r,!0,!0),l=n.distance(e,e,!1,!0),c=n.distance(r,r,!1,!0),i=Math.abs(a),o=Math.abs(s),u=i+o,u===0){Ue.setRelative(t,t,(l+c)/2,n,!0);return}Ue.setRelative(t,t,(l*o+c*i)/u,n,!0)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(t,e,r,n,a){if(!n||n===this){t.x=(a?e.xo:e.x)+r;return}var s=a?e.xo:e.x,i=a?e.yo:e.y,o=s+r*n.x,l=i+r*n.y;t.x=o+(t.y-l)/n.normalSlope},slope:0,touch:function(t){t.xTouched=!0},touched:function(t){return t.xTouched},untouch:function(t){t.xTouched=!1}},Be={x:0,y:1,axis:"y",distance:function(t,e,r,n){return(r?t.yo:t.y)-(n?e.yo:e.y)},interpolate:function(t,e,r,n){var a,s,i,o,l,c,u;if(!n||n===this){if(a=t.yo-e.yo,s=t.yo-r.yo,l=e.y-e.yo,c=r.y-r.yo,i=Math.abs(a),o=Math.abs(s),u=i+o,u===0){t.y=t.yo+(l+c)/2;return}t.y=t.yo+(l*o+c*i)/u;return}if(a=n.distance(t,e,!0,!0),s=n.distance(t,r,!0,!0),l=n.distance(e,e,!1,!0),c=n.distance(r,r,!1,!0),i=Math.abs(a),o=Math.abs(s),u=i+o,u===0){Be.setRelative(t,t,(l+c)/2,n,!0);return}Be.setRelative(t,t,(l*o+c*i)/u,n,!0)},normalSlope:0,setRelative:function(t,e,r,n,a){if(!n||n===this){t.y=(a?e.yo:e.y)+r;return}var s=a?e.xo:e.x,i=a?e.yo:e.y,o=s+r*n.x,l=i+r*n.y;t.y=l+n.normalSlope*(t.x-o)},slope:Number.POSITIVE_INFINITY,touch:function(t){t.yTouched=!0},touched:function(t){return t.yTouched},untouch:function(t){t.yTouched=!1}};Object.freeze(Ue);Object.freeze(Be);function pt(t,e){this.x=t,this.y=e,this.axis=void 0,this.slope=e/t,this.normalSlope=-t/e,Object.freeze(this)}pt.prototype.distance=function(t,e,r,n){return this.x*Ue.distance(t,e,r,n)+this.y*Be.distance(t,e,r,n)};pt.prototype.interpolate=function(t,e,r,n){var a,s,i,o,l,c,u;if(i=n.distance(t,e,!0,!0),o=n.distance(t,r,!0,!0),a=n.distance(e,e,!1,!0),s=n.distance(r,r,!1,!0),l=Math.abs(i),c=Math.abs(o),u=l+c,u===0){this.setRelative(t,t,(a+s)/2,n,!0);return}this.setRelative(t,t,(a*c+s*l)/u,n,!0)};pt.prototype.setRelative=function(t,e,r,n,a){n=n||this;var s=a?e.xo:e.x,i=a?e.yo:e.y,o=s+r*n.x,l=i+r*n.y,c=n.normalSlope,u=this.slope,f=t.x,h=t.y;t.x=(u*f-c*o+l-h)/(u-c),t.y=u*(t.x-f)+h};pt.prototype.touch=function(t){t.xTouched=!0,t.yTouched=!0};function gt(t,e){var r=Math.sqrt(t*t+e*e);return t/=r,e/=r,t===1&&e===0?Ue:t===0&&e===1?Be:new pt(t,e)}function Ae(t,e,r,n){this.x=this.xo=Math.round(t*64)/64,this.y=this.yo=Math.round(e*64)/64,this.lastPointOfContour=r,this.onCurve=n,this.prevPointOnContour=void 0,this.nextPointOnContour=void 0,this.xTouched=!1,this.yTouched=!1,Object.preventExtensions(this)}Ae.prototype.nextTouched=function(t){for(var e=this.nextPointOnContour;!t.touched(e)&&e!==this;)e=e.nextPointOnContour;return e};Ae.prototype.prevTouched=function(t){for(var e=this.prevPointOnContour;!t.touched(e)&&e!==this;)e=e.prevPointOnContour;return e};var ct=Object.freeze(new Ae(0,0)),Su={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:!0};function $e(t,e){switch(this.env=t,this.stack=[],this.prog=e,t){case"glyf":this.zp0=this.zp1=this.zp2=1,this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=Ue,this.round=Jn}}Zn.prototype.exec=function(t,e){if(typeof e!="number")throw new Error("Point size is not a number!");if(!(this._errorState>2)){var r=this.font,n=this._prepState;if(!n||n.ppem!==e){var a=this._fpgmState;if(!a){$e.prototype=Su,a=this._fpgmState=new $e("fpgm",r.tables.fpgm),a.funcs=[],a.font=r,exports.DEBUG&&(console.log("---EXEC FPGM---"),a.step=-1);try{Ze(a)}catch(c){console.log("Hinting error in FPGM:"+c),this._errorState=3;return}}$e.prototype=a,n=this._prepState=new $e("prep",r.tables.prep),n.ppem=e;var s=r.tables.cvt;if(s)for(var i=n.cvt=new Array(s.length),o=e/r.unitsPerEm,l=0;l<s.length;l++)i[l]=s[l]*o;else n.cvt=[];exports.DEBUG&&(console.log("---EXEC PREP---"),n.step=-1);try{Ze(n)}catch(c){this._errorState<2&&console.log("Hinting error in PREP:"+c),this._errorState=2}}if(!(this._errorState>1))try{return Kn(t,n)}catch(c){this._errorState<1&&(console.log("Hinting error:"+c),console.log("Note: further hinting errors are silenced")),this._errorState=1;return}}};Kn=function(t,e){var r=e.ppem/e.font.unitsPerEm,n=r,a=t.components,s,i,o;if($e.prototype=e,!a)o=new $e("glyf",t.instructions),exports.DEBUG&&(console.log("---EXEC GLYPH---"),o.step=-1),ar(t,o,r,n),i=o.gZone;else{var l=e.font;i=[],s=[];for(var c=0;c<a.length;c++){var u=a[c],f=l.glyphs.get(u.glyphIndex);o=new $e("glyf",f.instructions),exports.DEBUG&&(console.log("---EXEC COMP "+c+"---"),o.step=-1),ar(f,o,r,n);for(var h=Math.round(u.dx*r),p=Math.round(u.dy*n),y=o.gZone,b=o.contours,m=0;m<y.length;m++){var g=y[m];g.xTouched=g.yTouched=!1,g.xo=g.x=g.x+h,g.yo=g.y=g.y+p}var w=i.length;i.push.apply(i,y);for(var v=0;v<b.length;v++)s.push(b[v]+w)}t.instructions&&!o.inhibitGridFit&&(o=new $e("glyf",t.instructions),o.gZone=o.z0=o.z1=o.z2=i,o.contours=s,i.push(new Ae(0,0),new Ae(Math.round(t.advanceWidth*r),0)),exports.DEBUG&&(console.log("---EXEC COMPOSITE---"),o.step=-1),Ze(o),i.length-=2)}return i};ar=function(t,e,r,n){for(var a=t.points||[],s=a.length,i=e.gZone=e.z0=e.z1=e.z2=[],o=e.contours=[],l,c=0;c<s;c++)l=a[c],i[c]=new Ae(l.x*r,l.y*n,l.lastPointOfContour,l.onCurve);for(var u,f,h=0;h<s;h++)l=i[h],u||(u=l,o.push(h)),l.lastPointOfContour?(l.nextPointOnContour=u,u.prevPointOnContour=l,u=void 0):(f=i[h+1],l.nextPointOnContour=f,f.prevPointOnContour=l);if(!e.inhibitGridFit){if(exports.DEBUG){console.log("PROCESSING GLYPH",e.stack);for(var p=0;p<s;p++)console.log(p,i[p].x,i[p].y)}if(i.push(new Ae(0,0),new Ae(Math.round(t.advanceWidth*r),0)),Ze(e),i.length-=2,exports.DEBUG){console.log("FINISHED GLYPH",e.stack);for(var y=0;y<s;y++)console.log(y,i[y].x,i[y].y)}}};Ze=function(t){var e=t.prog;if(e){var r=e.length,n;for(t.ip=0;t.ip<r;t.ip++){if(exports.DEBUG&&t.step++,n=Yn[e[t.ip]],!n)throw new Error("unknown instruction: 0x"+Number(e[t.ip]).toString(16));n(t)}}};function At(t){for(var e=t.tZone=new Array(t.gZone.length),r=0;r<e.length;r++)e[r]=new Ae(0,0)}function ea(t,e){var r=t.prog,n=t.ip,a=1,s;do if(s=r[++n],s===88)a++;else if(s===89)a--;else if(s===64)n+=r[n+1]+1;else if(s===65)n+=2*r[n+1]+1;else if(s>=176&&s<=183)n+=s-176+1;else if(s>=184&&s<=191)n+=(s-184+1)*2;else if(e&&a===1&&s===27)break;while(a>0);t.ip=n}function Gr(t,e){exports.DEBUG&&console.log(e.step,"SVTCA["+t.axis+"]"),e.fv=e.pv=e.dpv=t}function zr(t,e){exports.DEBUG&&console.log(e.step,"SPVTCA["+t.axis+"]"),e.pv=e.dpv=t}function Vr(t,e){exports.DEBUG&&console.log(e.step,"SFVTCA["+t.axis+"]"),e.fv=t}function $r(t,e){var r=e.stack,n=r.pop(),a=r.pop(),s=e.z2[n],i=e.z1[a];exports.DEBUG&&console.log("SPVTL["+t+"]",n,a);var o,l;t?(o=s.y-i.y,l=i.x-s.x):(o=i.x-s.x,l=i.y-s.y),e.pv=e.dpv=gt(o,l)}function Hr(t,e){var r=e.stack,n=r.pop(),a=r.pop(),s=e.z2[n],i=e.z1[a];exports.DEBUG&&console.log("SFVTL["+t+"]",n,a);var o,l;t?(o=s.y-i.y,l=i.x-s.x):(o=i.x-s.x,l=i.y-s.y),e.fv=gt(o,l)}function Tu(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"SPVFS[]",r,n),t.pv=t.dpv=gt(n,r)}function Fu(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"SPVFS[]",r,n),t.fv=gt(n,r)}function Cu(t){var e=t.stack,r=t.pv;exports.DEBUG&&console.log(t.step,"GPV[]"),e.push(r.x*16384),e.push(r.y*16384)}function _u(t){var e=t.stack,r=t.fv;exports.DEBUG&&console.log(t.step,"GFV[]"),e.push(r.x*16384),e.push(r.y*16384)}function Eu(t){t.fv=t.pv,exports.DEBUG&&console.log(t.step,"SFVTPV[]")}function Uu(t){var e=t.stack,r=e.pop(),n=e.pop(),a=e.pop(),s=e.pop(),i=e.pop(),o=t.z0,l=t.z1,c=o[r],u=o[n],f=l[a],h=l[s],p=t.z2[i];exports.DEBUG&&console.log("ISECT[], ",r,n,a,s,i);var y=c.x,b=c.y,m=u.x,g=u.y,w=f.x,v=f.y,S=h.x,F=h.y,B=(y-m)*(v-F)-(b-g)*(w-S),L=y*g-b*m,O=w*F-v*S;p.x=(L*(w-S)-O*(y-m))/B,p.y=(L*(v-F)-O*(b-g))/B}function Lu(t){t.rp0=t.stack.pop(),exports.DEBUG&&console.log(t.step,"SRP0[]",t.rp0)}function Ou(t){t.rp1=t.stack.pop(),exports.DEBUG&&console.log(t.step,"SRP1[]",t.rp1)}function Bu(t){t.rp2=t.stack.pop(),exports.DEBUG&&console.log(t.step,"SRP2[]",t.rp2)}function Ru(t){var e=t.stack.pop();switch(exports.DEBUG&&console.log(t.step,"SZP0[]",e),t.zp0=e,e){case 0:t.tZone||At(t),t.z0=t.tZone;break;case 1:t.z0=t.gZone;break;default:throw new Error("Invalid zone pointer")}}function Au(t){var e=t.stack.pop();switch(exports.DEBUG&&console.log(t.step,"SZP1[]",e),t.zp1=e,e){case 0:t.tZone||At(t),t.z1=t.tZone;break;case 1:t.z1=t.gZone;break;default:throw new Error("Invalid zone pointer")}}function Iu(t){var e=t.stack.pop();switch(exports.DEBUG&&console.log(t.step,"SZP2[]",e),t.zp2=e,e){case 0:t.tZone||At(t),t.z2=t.tZone;break;case 1:t.z2=t.gZone;break;default:throw new Error("Invalid zone pointer")}}function Du(t){var e=t.stack.pop();switch(exports.DEBUG&&console.log(t.step,"SZPS[]",e),t.zp0=t.zp1=t.zp2=e,e){case 0:t.tZone||At(t),t.z0=t.z1=t.z2=t.tZone;break;case 1:t.z0=t.z1=t.z2=t.gZone;break;default:throw new Error("Invalid zone pointer")}}function Mu(t){t.loop=t.stack.pop(),exports.DEBUG&&console.log(t.step,"SLOOP[]",t.loop)}function Pu(t){exports.DEBUG&&console.log(t.step,"RTG[]"),t.round=Jn}function Nu(t){exports.DEBUG&&console.log(t.step,"RTHG[]"),t.round=xu}function Gu(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"SMD[]",e),t.minDis=e/64}function zu(t){exports.DEBUG&&console.log(t.step,"ELSE[]"),ea(t,!1)}function Vu(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"JMPR[]",e),t.ip+=e-1}function $u(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"SCVTCI[]",e),t.cvCutIn=e/64}function Hu(t){var e=t.stack;exports.DEBUG&&console.log(t.step,"DUP[]"),e.push(e[e.length-1])}function $t(t){exports.DEBUG&&console.log(t.step,"POP[]"),t.stack.pop()}function ju(t){exports.DEBUG&&console.log(t.step,"CLEAR[]"),t.stack.length=0}function Wu(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"SWAP[]"),e.push(r),e.push(n)}function Xu(t){var e=t.stack;exports.DEBUG&&console.log(t.step,"DEPTH[]"),e.push(e.length)}function qu(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"LOOPCALL[]",r,n);var a=t.ip,s=t.prog;t.prog=t.funcs[r];for(var i=0;i<n;i++)Ze(t),exports.DEBUG&&console.log(++t.step,i+1<n?"next loopcall":"done loopcall",i);t.ip=a,t.prog=s}function Yu(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"CALL[]",e);var r=t.ip,n=t.prog;t.prog=t.funcs[e],Ze(t),t.ip=r,t.prog=n,exports.DEBUG&&console.log(++t.step,"returning from",e)}function Ku(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"CINDEX[]",r),e.push(e[e.length-r])}function Zu(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"MINDEX[]",r),e.push(e.splice(e.length-r,1)[0])}function Ju(t){if(t.env!=="fpgm")throw new Error("FDEF not allowed here");var e=t.stack,r=t.prog,n=t.ip,a=e.pop(),s=n;for(exports.DEBUG&&console.log(t.step,"FDEF[]",a);r[++n]!==45;);t.ip=n,t.funcs[a]=r.slice(s+1,n)}function jr(t,e){var r=e.stack.pop(),n=e.z0[r],a=e.fv,s=e.pv;exports.DEBUG&&console.log(e.step,"MDAP["+t+"]",r);var i=s.distance(n,ct);t&&(i=e.round(i)),a.setRelative(n,ct,i,s),a.touch(n),e.rp0=e.rp1=r}function Wr(t,e){var r=e.z2,n=r.length-2,a,s,i;exports.DEBUG&&console.log(e.step,"IUP["+t.axis+"]");for(var o=0;o<n;o++)a=r[o],!t.touched(a)&&(s=a.prevTouched(t),s!==a&&(i=a.nextTouched(t),s===i&&t.setRelative(a,a,t.distance(s,s,!1,!0),t,!0),t.interpolate(a,s,i,t)))}function Xr(t,e){for(var r=e.stack,n=t?e.rp1:e.rp2,a=(t?e.z0:e.z1)[n],s=e.fv,i=e.pv,o=e.loop,l=e.z2;o--;){var c=r.pop(),u=l[c],f=i.distance(a,a,!1,!0);s.setRelative(u,u,f,i),s.touch(u),exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-o)+": ":"")+"SHP["+(t?"rp1":"rp2")+"]",c)}e.loop=1}function qr(t,e){var r=e.stack,n=t?e.rp1:e.rp2,a=(t?e.z0:e.z1)[n],s=e.fv,i=e.pv,o=r.pop(),l=e.z2[e.contours[o]],c=l;exports.DEBUG&&console.log(e.step,"SHC["+t+"]",o);var u=i.distance(a,a,!1,!0);do c!==a&&s.setRelative(c,c,u,i),c=c.nextPointOnContour;while(c!==l)}function Yr(t,e){var r=e.stack,n=t?e.rp1:e.rp2,a=(t?e.z0:e.z1)[n],s=e.fv,i=e.pv,o=r.pop();exports.DEBUG&&console.log(e.step,"SHZ["+t+"]",o);var l;switch(o){case 0:l=e.tZone;break;case 1:l=e.gZone;break;default:throw new Error("Invalid zone")}for(var c,u=i.distance(a,a,!1,!0),f=l.length-2,h=0;h<f;h++)c=l[h],s.setRelative(c,c,u,i)}function Qu(t){for(var e=t.stack,r=t.loop,n=t.fv,a=e.pop()/64,s=t.z2;r--;){var i=e.pop(),o=s[i];exports.DEBUG&&console.log(t.step,(t.loop>1?"loop "+(t.loop-r)+": ":"")+"SHPIX[]",i,a),n.setRelative(o,o,a),n.touch(o)}t.loop=1}function ec(t){for(var e=t.stack,r=t.rp1,n=t.rp2,a=t.loop,s=t.z0[r],i=t.z1[n],o=t.fv,l=t.dpv,c=t.z2;a--;){var u=e.pop(),f=c[u];exports.DEBUG&&console.log(t.step,(t.loop>1?"loop "+(t.loop-a)+": ":"")+"IP[]",u,r,"<->",n),o.interpolate(f,s,i,l),o.touch(f)}t.loop=1}function Kr(t,e){var r=e.stack,n=r.pop()/64,a=r.pop(),s=e.z1[a],i=e.z0[e.rp0],o=e.fv,l=e.pv;o.setRelative(s,i,n,l),o.touch(s),exports.DEBUG&&console.log(e.step,"MSIRP["+t+"]",n,a),e.rp1=e.rp0,e.rp2=a,t&&(e.rp0=a)}function tc(t){for(var e=t.stack,r=t.rp0,n=t.z0[r],a=t.loop,s=t.fv,i=t.pv,o=t.z1;a--;){var l=e.pop(),c=o[l];exports.DEBUG&&console.log(t.step,(t.loop>1?"loop "+(t.loop-a)+": ":"")+"ALIGNRP[]",l),s.setRelative(c,n,0,i),s.touch(c)}t.loop=1}function rc(t){exports.DEBUG&&console.log(t.step,"RTDG[]"),t.round=bu}function Zr(t,e){var r=e.stack,n=r.pop(),a=r.pop(),s=e.z0[a],i=e.fv,o=e.pv,l=e.cvt[n];exports.DEBUG&&console.log(e.step,"MIAP["+t+"]",n,"(",l,")",a);var c=o.distance(s,ct);t&&(Math.abs(c-l)<e.cvCutIn&&(c=l),c=e.round(c)),i.setRelative(s,ct,c,o),e.zp0===0&&(s.xo=s.x,s.yo=s.y),i.touch(s),e.rp0=e.rp1=a}function nc(t){var e=t.prog,r=t.ip,n=t.stack,a=e[++r];exports.DEBUG&&console.log(t.step,"NPUSHB[]",a);for(var s=0;s<a;s++)n.push(e[++r]);t.ip=r}function ac(t){var e=t.ip,r=t.prog,n=t.stack,a=r[++e];exports.DEBUG&&console.log(t.step,"NPUSHW[]",a);for(var s=0;s<a;s++){var i=r[++e]<<8|r[++e];i&32768&&(i=-((i^65535)+1)),n.push(i)}t.ip=e}function sc(t){var e=t.stack,r=t.store;r||(r=t.store=[]);var n=e.pop(),a=e.pop();exports.DEBUG&&console.log(t.step,"WS",n,a),r[a]=n}function ic(t){var e=t.stack,r=t.store,n=e.pop();exports.DEBUG&&console.log(t.step,"RS",n);var a=r&&r[n]||0;e.push(a)}function oc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"WCVTP",r,n),t.cvt[n]=r/64}function lc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"RCVT",r),e.push(t.cvt[r]*64)}function Jr(t,e){var r=e.stack,n=r.pop(),a=e.z2[n];exports.DEBUG&&console.log(e.step,"GC["+t+"]",n),r.push(e.dpv.distance(a,ct,t,!1)*64)}function Qr(t,e){var r=e.stack,n=r.pop(),a=r.pop(),s=e.z1[n],i=e.z0[a],o=e.dpv.distance(i,s,t,t);exports.DEBUG&&console.log(e.step,"MD["+t+"]",n,a,"->",o),e.stack.push(Math.round(o*64))}function uc(t){exports.DEBUG&&console.log(t.step,"MPPEM[]"),t.stack.push(t.ppem)}function cc(t){exports.DEBUG&&console.log(t.step,"FLIPON[]"),t.autoFlip=!0}function hc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"LT[]",r,n),e.push(n<r?1:0)}function dc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"LTEQ[]",r,n),e.push(n<=r?1:0)}function fc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"GT[]",r,n),e.push(n>r?1:0)}function pc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"GTEQ[]",r,n),e.push(n>=r?1:0)}function gc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"EQ[]",r,n),e.push(r===n?1:0)}function mc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"NEQ[]",r,n),e.push(r!==n?1:0)}function vc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"ODD[]",r),e.push(Math.trunc(r)%2?1:0)}function yc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"EVEN[]",r),e.push(Math.trunc(r)%2?0:1)}function bc(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"IF[]",e),e||(ea(t,!0),exports.DEBUG&&console.log(t.step,"EIF[]"))}function xc(t){exports.DEBUG&&console.log(t.step,"EIF[]")}function wc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"AND[]",r,n),e.push(r&&n?1:0)}function kc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"OR[]",r,n),e.push(r||n?1:0)}function Sc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"NOT[]",r),e.push(r?0:1)}function Ht(t,e){var r=e.stack,n=r.pop(),a=e.fv,s=e.pv,i=e.ppem,o=e.deltaBase+(t-1)*16,l=e.deltaShift,c=e.z0;exports.DEBUG&&console.log(e.step,"DELTAP["+t+"]",n,r);for(var u=0;u<n;u++){var f=r.pop(),h=r.pop(),p=o+((h&240)>>4);if(p===i){var y=(h&15)-8;y>=0&&y++,exports.DEBUG&&console.log(e.step,"DELTAPFIX",f,"by",y*l);var b=c[f];a.setRelative(b,b,y*l,s)}}}function Tc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"SDB[]",r),t.deltaBase=r}function Fc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"SDS[]",r),t.deltaShift=Math.pow(.5,r)}function Cc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"ADD[]",r,n),e.push(n+r)}function _c(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"SUB[]",r,n),e.push(n-r)}function Ec(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"DIV[]",r,n),e.push(n*64/r)}function Uc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"MUL[]",r,n),e.push(n*r/64)}function Lc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"ABS[]",r),e.push(Math.abs(r))}function Oc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"NEG[]",r),e.push(-r)}function Bc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"FLOOR[]",r),e.push(Math.floor(r/64)*64)}function Rc(t){var e=t.stack,r=e.pop();exports.DEBUG&&console.log(t.step,"CEILING[]",r),e.push(Math.ceil(r/64)*64)}function Tt(t,e){var r=e.stack,n=r.pop();exports.DEBUG&&console.log(e.step,"ROUND[]"),r.push(e.round(n/64)*64)}function Ac(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"WCVTF[]",r,n),t.cvt[n]=r*t.ppem/t.font.unitsPerEm}function jt(t,e){var r=e.stack,n=r.pop(),a=e.ppem,s=e.deltaBase+(t-1)*16,i=e.deltaShift;exports.DEBUG&&console.log(e.step,"DELTAC["+t+"]",n,r);for(var o=0;o<n;o++){var l=r.pop(),c=r.pop(),u=s+((c&240)>>4);if(u===a){var f=(c&15)-8;f>=0&&f++;var h=f*i;exports.DEBUG&&console.log(e.step,"DELTACFIX",l,"by",h),e.cvt[l]+=h}}}function Ic(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"SROUND[]",e),t.round=Qn;var r;switch(e&192){case 0:r=.5;break;case 64:r=1;break;case 128:r=2;break;default:throw new Error("invalid SROUND value")}switch(t.srPeriod=r,e&48){case 0:t.srPhase=0;break;case 16:t.srPhase=.25*r;break;case 32:t.srPhase=.5*r;break;case 48:t.srPhase=.75*r;break;default:throw new Error("invalid SROUND value")}e&=15,e===0?t.srThreshold=0:t.srThreshold=(e/8-.5)*r}function Dc(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"S45ROUND[]",e),t.round=Qn;var r;switch(e&192){case 0:r=Math.sqrt(2)/2;break;case 64:r=Math.sqrt(2);break;case 128:r=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}switch(t.srPeriod=r,e&48){case 0:t.srPhase=0;break;case 16:t.srPhase=.25*r;break;case 32:t.srPhase=.5*r;break;case 48:t.srPhase=.75*r;break;default:throw new Error("invalid S45ROUND value")}e&=15,e===0?t.srThreshold=0:t.srThreshold=(e/8-.5)*r}function Mc(t){exports.DEBUG&&console.log(t.step,"ROFF[]"),t.round=yu}function Pc(t){exports.DEBUG&&console.log(t.step,"RUTG[]"),t.round=wu}function Nc(t){exports.DEBUG&&console.log(t.step,"RDTG[]"),t.round=ku}function Gc(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"SCANCTRL[]",e)}function en(t,e){var r=e.stack,n=r.pop(),a=r.pop(),s=e.z2[n],i=e.z1[a];exports.DEBUG&&console.log(e.step,"SDPVTL["+t+"]",n,a);var o,l;t?(o=s.y-i.y,l=i.x-s.x):(o=i.x-s.x,l=i.y-s.y),e.dpv=gt(o,l)}function zc(t){var e=t.stack,r=e.pop(),n=0;exports.DEBUG&&console.log(t.step,"GETINFO[]",r),r&1&&(n=35),r&32&&(n|=4096),e.push(n)}function Vc(t){var e=t.stack,r=e.pop(),n=e.pop(),a=e.pop();exports.DEBUG&&console.log(t.step,"ROLL[]"),e.push(n),e.push(r),e.push(a)}function $c(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"MAX[]",r,n),e.push(Math.max(n,r))}function Hc(t){var e=t.stack,r=e.pop(),n=e.pop();exports.DEBUG&&console.log(t.step,"MIN[]",r,n),e.push(Math.min(n,r))}function jc(t){var e=t.stack.pop();exports.DEBUG&&console.log(t.step,"SCANTYPE[]",e)}function Wc(t){var e=t.stack.pop(),r=t.stack.pop();switch(exports.DEBUG&&console.log(t.step,"INSTCTRL[]",e,r),e){case 1:t.inhibitGridFit=!!r;return;case 2:t.ignoreCvt=!!r;return;default:throw new Error("invalid INSTCTRL[] selector")}}function Ne(t,e){var r=e.stack,n=e.prog,a=e.ip;exports.DEBUG&&console.log(e.step,"PUSHB["+t+"]");for(var s=0;s<t;s++)r.push(n[++a]);e.ip=a}function Ge(t,e){var r=e.ip,n=e.prog,a=e.stack;exports.DEBUG&&console.log(e.ip,"PUSHW["+t+"]");for(var s=0;s<t;s++){var i=n[++r]<<8|n[++r];i&32768&&(i=-((i^65535)+1)),a.push(i)}e.ip=r}function P(t,e,r,n,a,s){var i=s.stack,o=t&&i.pop(),l=i.pop(),c=s.rp0,u=s.z0[c],f=s.z1[l],h=s.minDis,p=s.fv,y=s.dpv,b,m,g,w;m=b=y.distance(f,u,!0,!0),g=m>=0?1:-1,m=Math.abs(m),t&&(w=s.cvt[o],n&&Math.abs(m-w)<s.cvCutIn&&(m=w)),r&&m<h&&(m=h),n&&(m=s.round(m)),p.setRelative(f,u,g*m,y),p.touch(f),exports.DEBUG&&console.log(s.step,(t?"MIRP[":"MDRP[")+(e?"M":"m")+(r?">":"_")+(n?"R":"_")+(a===0?"Gr":a===1?"Bl":a===2?"Wh":"")+"]",t?o+"("+s.cvt[o]+","+w+")":"",l,"(d =",b,"->",g*m,")"),s.rp1=s.rp0,s.rp2=l,e&&(s.rp0=l)}Yn=[Gr.bind(void 0,Be),Gr.bind(void 0,Ue),zr.bind(void 0,Be),zr.bind(void 0,Ue),Vr.bind(void 0,Be),Vr.bind(void 0,Ue),$r.bind(void 0,0),$r.bind(void 0,1),Hr.bind(void 0,0),Hr.bind(void 0,1),Tu,Fu,Cu,_u,Eu,Uu,Lu,Ou,Bu,Ru,Au,Iu,Du,Mu,Pu,Nu,Gu,zu,Vu,$u,void 0,void 0,Hu,$t,ju,Wu,Xu,Ku,Zu,void 0,void 0,void 0,qu,Yu,Ju,void 0,jr.bind(void 0,0),jr.bind(void 0,1),Wr.bind(void 0,Be),Wr.bind(void 0,Ue),Xr.bind(void 0,0),Xr.bind(void 0,1),qr.bind(void 0,0),qr.bind(void 0,1),Yr.bind(void 0,0),Yr.bind(void 0,1),Qu,ec,Kr.bind(void 0,0),Kr.bind(void 0,1),tc,rc,Zr.bind(void 0,0),Zr.bind(void 0,1),nc,ac,sc,ic,oc,lc,Jr.bind(void 0,0),Jr.bind(void 0,1),void 0,Qr.bind(void 0,0),Qr.bind(void 0,1),uc,void 0,cc,void 0,void 0,hc,dc,fc,pc,gc,mc,vc,yc,bc,xc,wc,kc,Sc,Ht.bind(void 0,1),Tc,Fc,Cc,_c,Ec,Uc,Lc,Oc,Bc,Rc,Tt.bind(void 0,0),Tt.bind(void 0,1),Tt.bind(void 0,2),Tt.bind(void 0,3),void 0,void 0,void 0,void 0,Ac,Ht.bind(void 0,2),Ht.bind(void 0,3),jt.bind(void 0,1),jt.bind(void 0,2),jt.bind(void 0,3),Ic,Dc,void 0,void 0,Mc,void 0,Pc,Nc,$t,$t,void 0,void 0,void 0,void 0,void 0,Gc,en.bind(void 0,0),en.bind(void 0,1),zc,void 0,Vc,$c,Hc,jc,Wc,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,Ne.bind(void 0,1),Ne.bind(void 0,2),Ne.bind(void 0,3),Ne.bind(void 0,4),Ne.bind(void 0,5),Ne.bind(void 0,6),Ne.bind(void 0,7),Ne.bind(void 0,8),Ge.bind(void 0,1),Ge.bind(void 0,2),Ge.bind(void 0,3),Ge.bind(void 0,4),Ge.bind(void 0,5),Ge.bind(void 0,6),Ge.bind(void 0,7),Ge.bind(void 0,8),P.bind(void 0,0,0,0,0,0),P.bind(void 0,0,0,0,0,1),P.bind(void 0,0,0,0,0,2),P.bind(void 0,0,0,0,0,3),P.bind(void 0,0,0,0,1,0),P.bind(void 0,0,0,0,1,1),P.bind(void 0,0,0,0,1,2),P.bind(void 0,0,0,0,1,3),P.bind(void 0,0,0,1,0,0),P.bind(void 0,0,0,1,0,1),P.bind(void 0,0,0,1,0,2),P.bind(void 0,0,0,1,0,3),P.bind(void 0,0,0,1,1,0),P.bind(void 0,0,0,1,1,1),P.bind(void 0,0,0,1,1,2),P.bind(void 0,0,0,1,1,3),P.bind(void 0,0,1,0,0,0),P.bind(void 0,0,1,0,0,1),P.bind(void 0,0,1,0,0,2),P.bind(void 0,0,1,0,0,3),P.bind(void 0,0,1,0,1,0),P.bind(void 0,0,1,0,1,1),P.bind(void 0,0,1,0,1,2),P.bind(void 0,0,1,0,1,3),P.bind(void 0,0,1,1,0,0),P.bind(void 0,0,1,1,0,1),P.bind(void 0,0,1,1,0,2),P.bind(void 0,0,1,1,0,3),P.bind(void 0,0,1,1,1,0),P.bind(void 0,0,1,1,1,1),P.bind(void 0,0,1,1,1,2),P.bind(void 0,0,1,1,1,3),P.bind(void 0,1,0,0,0,0),P.bind(void 0,1,0,0,0,1),P.bind(void 0,1,0,0,0,2),P.bind(void 0,1,0,0,0,3),P.bind(void 0,1,0,0,1,0),P.bind(void 0,1,0,0,1,1),P.bind(void 0,1,0,0,1,2),P.bind(void 0,1,0,0,1,3),P.bind(void 0,1,0,1,0,0),P.bind(void 0,1,0,1,0,1),P.bind(void 0,1,0,1,0,2),P.bind(void 0,1,0,1,0,3),P.bind(void 0,1,0,1,1,0),P.bind(void 0,1,0,1,1,1),P.bind(void 0,1,0,1,1,2),P.bind(void 0,1,0,1,1,3),P.bind(void 0,1,1,0,0,0),P.bind(void 0,1,1,0,0,1),P.bind(void 0,1,1,0,0,2),P.bind(void 0,1,1,0,0,3),P.bind(void 0,1,1,0,1,0),P.bind(void 0,1,1,0,1,1),P.bind(void 0,1,1,0,1,2),P.bind(void 0,1,1,0,1,3),P.bind(void 0,1,1,1,0,0),P.bind(void 0,1,1,1,0,1),P.bind(void 0,1,1,1,0,2),P.bind(void 0,1,1,1,0,3),P.bind(void 0,1,1,1,1,0),P.bind(void 0,1,1,1,1,1),P.bind(void 0,1,1,1,1,2),P.bind(void 0,1,1,1,1,3)];function nt(t){this.char=t,this.state={},this.activeState=null}function gr(t,e,r){this.contextName=r,this.startIndex=t,this.endOffset=e}function Xc(t,e,r){this.contextName=t,this.openRange=null,this.ranges=[],this.checkStart=e,this.checkEnd=r}function ke(t,e){this.context=t,this.index=e,this.length=t.length,this.current=t[e],this.backtrack=t.slice(0,e),this.lookahead=t.slice(e+1)}function It(t){this.eventId=t,this.subscribers=[]}function qc(t){var e=this,r=["start","end","next","newToken","contextStart","contextEnd","insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD","updateContextsRanges"];r.forEach(function(a){Object.defineProperty(e.events,a,{value:new It(a)})}),t&&r.forEach(function(a){var s=t[a];typeof s=="function"&&e.events[a].subscribe(s)});var n=["insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD"];n.forEach(function(a){e.events[a].subscribe(e.updateContextsRanges)})}function ne(t){this.tokens=[],this.registeredContexts={},this.contextCheckers=[],this.events={},this.registeredModifiers=[],qc.call(this,t)}nt.prototype.setState=function(t,e){return this.state[t]=e,this.activeState={key:t,value:this.state[t]},this.activeState};nt.prototype.getState=function(t){return this.state[t]||null};ne.prototype.inboundIndex=function(t){return t>=0&&t<this.tokens.length};ne.prototype.composeRUD=function(t){var e=this,r=!0,n=t.map(function(s){return e[s[0]].apply(e,s.slice(1).concat(r))}),a=function(s){return typeof s=="object"&&s.hasOwnProperty("FAIL")};if(n.every(a))return{FAIL:"composeRUD: one or more operations hasn't completed successfully",report:n.filter(a)};this.dispatch("composeRUD",[n.filter(function(s){return!a(s)})])};ne.prototype.replaceRange=function(t,e,r,n){e=e!==null?e:this.tokens.length;var a=r.every(function(i){return i instanceof nt});if(!isNaN(t)&&this.inboundIndex(t)&&a){var s=this.tokens.splice.apply(this.tokens,[t,e].concat(r));return n||this.dispatch("replaceToken",[t,e,r]),[s,r]}else return{FAIL:"replaceRange: invalid tokens or startIndex."}};ne.prototype.replaceToken=function(t,e,r){if(!isNaN(t)&&this.inboundIndex(t)&&e instanceof nt){var n=this.tokens.splice(t,1,e);return r||this.dispatch("replaceToken",[t,e]),[n[0],e]}else return{FAIL:"replaceToken: invalid token or index."}};ne.prototype.removeRange=function(t,e,r){e=isNaN(e)?this.tokens.length:e;var n=this.tokens.splice(t,e);return r||this.dispatch("removeRange",[n,t,e]),n};ne.prototype.removeToken=function(t,e){if(!isNaN(t)&&this.inboundIndex(t)){var r=this.tokens.splice(t,1);return e||this.dispatch("removeToken",[r,t]),r}else return{FAIL:"removeToken: invalid token index."}};ne.prototype.insertToken=function(t,e,r){var n=t.every(function(a){return a instanceof nt});return n?(this.tokens.splice.apply(this.tokens,[e,0].concat(t)),r||this.dispatch("insertToken",[t,e]),t):{FAIL:"insertToken: invalid token(s)."}};ne.prototype.registerModifier=function(t,e,r){this.events.newToken.subscribe(function(n,a){var s=[n,a],i=e===null||e.apply(this,s)===!0,o=[n,a];if(i){var l=r.apply(this,o);n.setState(t,l)}}),this.registeredModifiers.push(t)};It.prototype.subscribe=function(t){return typeof t=="function"?this.subscribers.push(t)-1:{FAIL:"invalid '"+this.eventId+"' event handler"}};It.prototype.unsubscribe=function(t){this.subscribers.splice(t,1)};ke.prototype.setCurrentIndex=function(t){this.index=t,this.current=this.context[t],this.backtrack=this.context.slice(0,t),this.lookahead=this.context.slice(t+1)};ke.prototype.get=function(t){switch(!0){case t===0:return this.current;case(t<0&&Math.abs(t)<=this.backtrack.length):return this.backtrack.slice(t)[0];case(t>0&&t<=this.lookahead.length):return this.lookahead[t-1];default:return null}};ne.prototype.rangeToText=function(t){if(t instanceof gr)return this.getRangeTokens(t).map(function(e){return e.char}).join("")};ne.prototype.getText=function(){return this.tokens.map(function(t){return t.char}).join("")};ne.prototype.getContext=function(t){var e=this.registeredContexts[t];return e||null};ne.prototype.on=function(t,e){var r=this.events[t];return r?r.subscribe(e):null};ne.prototype.dispatch=function(t,e){var r=this,n=this.events[t];n instanceof It&&n.subscribers.forEach(function(a){a.apply(r,e||[])})};ne.prototype.registerContextChecker=function(t,e,r){if(this.getContext(t))return{FAIL:"context name '"+t+"' is already registered."};if(typeof e!="function")return{FAIL:"missing context start check."};if(typeof r!="function")return{FAIL:"missing context end check."};var n=new Xc(t,e,r);return this.registeredContexts[t]=n,this.contextCheckers.push(n),n};ne.prototype.getRangeTokens=function(t){var e=t.startIndex+t.endOffset;return[].concat(this.tokens.slice(t.startIndex,e))};ne.prototype.getContextRanges=function(t){var e=this.getContext(t);return e?e.ranges:{FAIL:"context checker '"+t+"' is not registered."}};ne.prototype.resetContextsRanges=function(){var t=this.registeredContexts;for(var e in t)if(t.hasOwnProperty(e)){var r=t[e];r.ranges=[]}};ne.prototype.updateContextsRanges=function(){this.resetContextsRanges();for(var t=this.tokens.map(function(n){return n.char}),e=0;e<t.length;e++){var r=new ke(t,e);this.runContextCheck(r)}this.dispatch("updateContextsRanges",[this.registeredContexts])};ne.prototype.setEndOffset=function(t,e){var r=this.getContext(e).openRange.startIndex,n=new gr(r,t,e),a=this.getContext(e).ranges;return n.rangeId=e+"."+a.length,a.push(n),this.getContext(e).openRange=null,n};ne.prototype.runContextCheck=function(t){var e=this,r=t.index;this.contextCheckers.forEach(function(n){var a=n.contextName,s=e.getContext(a).openRange;if(!s&&n.checkStart(t)&&(s=new gr(r,null,a),e.getContext(a).openRange=s,e.dispatch("contextStart",[a,r])),s&&n.checkEnd(t)){var i=r-s.startIndex+1,o=e.setEndOffset(i,a);e.dispatch("contextEnd",[a,o])}})};ne.prototype.tokenize=function(t){this.tokens=[],this.resetContextsRanges();var e=Array.from(t);this.dispatch("start");for(var r=0;r<e.length;r++){var n=e[r],a=new ke(e,r);this.dispatch("next",[a]),this.runContextCheck(a);var s=new nt(n);this.tokens.push(s),this.dispatch("newToken",[s,a])}return this.dispatch("end",[this.tokens]),this.tokens};function je(t){return/[\u0600-\u065F\u066A-\u06D2\u06FA-\u06FF]/.test(t)}function ta(t){return/[\u0630\u0690\u0621\u0631\u0661\u0671\u0622\u0632\u0672\u0692\u06C2\u0623\u0673\u0693\u06C3\u0624\u0694\u06C4\u0625\u0675\u0695\u06C5\u06E5\u0676\u0696\u06C6\u0627\u0677\u0697\u06C7\u0648\u0688\u0698\u06C8\u0689\u0699\u06C9\u068A\u06CA\u066B\u068B\u06CB\u068C\u068D\u06CD\u06FD\u068E\u06EE\u06FE\u062F\u068F\u06CF\u06EF]/.test(t)}function We(t){return/[\u0600-\u0605\u060C-\u060E\u0610-\u061B\u061E\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/.test(t)}function _t(t){return/[A-z]/.test(t)}function Yc(t){return/\s/.test(t)}function ve(t){this.font=t,this.features={}}function Ye(t){this.id=t.id,this.tag=t.tag,this.substitution=t.substitution}function mt(t,e){if(!t)return-1;switch(e.format){case 1:return e.glyphs.indexOf(t);case 2:for(var r=e.ranges,n=0;n<r.length;n++){var a=r[n];if(t>=a.start&&t<=a.end){var s=t-a.start;return a.index+s}}break;default:return-1}return-1}function Kc(t,e){var r=mt(t,e.coverage);return r===-1?null:t+e.deltaGlyphId}function Zc(t,e){var r=mt(t,e.coverage);return r===-1?null:e.substitute[r]}function Wt(t,e){for(var r=[],n=0;n<t.length;n++){var a=t[n],s=e.current;s=Array.isArray(s)?s[0]:s;var i=mt(s,a);i!==-1&&r.push(i)}return r.length!==t.length?-1:r}function Jc(t,e){var r=e.inputCoverage.length+e.lookaheadCoverage.length+e.backtrackCoverage.length;if(t.context.length<r)return[];var n=Wt(e.inputCoverage,t);if(n===-1)return[];var a=e.inputCoverage.length-1;if(t.lookahead.length<e.lookaheadCoverage.length)return[];for(var s=t.lookahead.slice(a);s.length&&We(s[0].char);)s.shift();var i=new ke(s,0),o=Wt(e.lookaheadCoverage,i),l=[].concat(t.backtrack);for(l.reverse();l.length&&We(l[0].char);)l.shift();if(l.length<e.backtrackCoverage.length)return[];var c=new ke(l,0),u=Wt(e.backtrackCoverage,c),f=n.length===e.inputCoverage.length&&o.length===e.lookaheadCoverage.length&&u.length===e.backtrackCoverage.length,h=[];if(f)for(var p=0;p<e.lookupRecords.length;p++)for(var y=e.lookupRecords[p],b=y.lookupListIndex,m=this.getLookupByIndex(b),g=0;g<m.subtables.length;g++){var w=m.subtables[g],v=this.getLookupMethod(m,w),S=this.getSubstitutionType(m,w);if(S==="12")for(var F=0;F<n.length;F++){var B=t.get(F),L=v(B);L&&h.push(L)}}return h}function Qc(t,e){var r=t.current,n=mt(r,e.coverage);if(n===-1)return null;for(var a,s=e.ligatureSets[n],i=0;i<s.length;i++){a=s[i];for(var o=0;o<a.components.length;o++){var l=t.lookahead[o],c=a.components[o];if(l!==c)break;if(o===a.components.length-1)return a}}return null}function eh(t,e){var r=mt(t,e.coverage);return r===-1?null:e.sequences[r]}ve.prototype.getDefaultScriptFeaturesIndexes=function(){for(var t=this.font.tables.gsub.scripts,e=0;e<t.length;e++){var r=t[e];if(r.tag==="DFLT")return r.script.defaultLangSys.featureIndexes}return[]};ve.prototype.getScriptFeaturesIndexes=function(t){var e=this.font.tables;if(!e.gsub)return[];if(!t)return this.getDefaultScriptFeaturesIndexes();for(var r=this.font.tables.gsub.scripts,n=0;n<r.length;n++){var a=r[n];if(a.tag===t&&a.script.defaultLangSys)return a.script.defaultLangSys.featureIndexes;var s=a.langSysRecords;if(s)for(var i=0;i<s.length;i++){var o=s[i];if(o.tag===t){var l=o.langSys;return l.featureIndexes}}}return this.getDefaultScriptFeaturesIndexes()};ve.prototype.mapTagsToFeatures=function(t,e){for(var r={},n=0;n<t.length;n++){var a=t[n].tag,s=t[n].feature;r[a]=s}this.features[e].tags=r};ve.prototype.getScriptFeatures=function(t){var e=this.features[t];if(this.features.hasOwnProperty(t))return e;var r=this.getScriptFeaturesIndexes(t);if(!r)return null;var n=this.font.tables.gsub;return e=r.map(function(a){return n.features[a]}),this.features[t]=e,this.mapTagsToFeatures(e,t),e};ve.prototype.getSubstitutionType=function(t,e){var r=t.lookupType.toString(),n=e.substFormat.toString();return r+n};ve.prototype.getLookupMethod=function(t,e){var r=this,n=this.getSubstitutionType(t,e);switch(n){case"11":return function(a){return Kc.apply(r,[a,e])};case"12":return function(a){return Zc.apply(r,[a,e])};case"63":return function(a){return Jc.apply(r,[a,e])};case"41":return function(a){return Qc.apply(r,[a,e])};case"21":return function(a){return eh.apply(r,[a,e])};default:throw new Error("lookupType: "+t.lookupType+" - substFormat: "+e.substFormat+" is not yet supported")}};ve.prototype.lookupFeature=function(t){var e=t.contextParams,r=e.index,n=this.getFeature({tag:t.tag,script:t.script});if(!n)return new Error("font '"+this.font.names.fullName.en+"' doesn't support feature '"+t.tag+"' for script '"+t.script+"'.");for(var a=this.getFeatureLookups(n),s=[].concat(e.context),i=0;i<a.length;i++)for(var o=a[i],l=this.getLookupSubtables(o),c=0;c<l.length;c++){var u=l[c],f=this.getSubstitutionType(o,u),h=this.getLookupMethod(o,u),p=void 0;switch(f){case"11":p=h(e.current),p&&s.splice(r,1,new Ye({id:11,tag:t.tag,substitution:p}));break;case"12":p=h(e.current),p&&s.splice(r,1,new Ye({id:12,tag:t.tag,substitution:p}));break;case"63":p=h(e),Array.isArray(p)&&p.length&&s.splice(r,1,new Ye({id:63,tag:t.tag,substitution:p}));break;case"41":p=h(e),p&&s.splice(r,1,new Ye({id:41,tag:t.tag,substitution:p}));break;case"21":p=h(e.current),p&&s.splice(r,1,new Ye({id:21,tag:t.tag,substitution:p}));break}e=new ke(s,r),!(Array.isArray(p)&&!p.length)&&(p=null)}return s.length?s:null};ve.prototype.supports=function(t){if(!t.script)return!1;this.getScriptFeatures(t.script);var e=this.features.hasOwnProperty(t.script);if(!t.tag)return e;var r=this.features[t.script].some(function(n){return n.tag===t.tag});return e&&r};ve.prototype.getLookupSubtables=function(t){return t.subtables||null};ve.prototype.getLookupByIndex=function(t){var e=this.font.tables.gsub.lookups;return e[t]||null};ve.prototype.getFeatureLookups=function(t){return t.lookupListIndexes.map(this.getLookupByIndex.bind(this))};ve.prototype.getFeature=function(e){if(!this.font)return{FAIL:"No font was found"};this.features.hasOwnProperty(e.script)||this.getScriptFeatures(e.script);var r=this.features[e.script];return r?r.tags[e.tag]?this.features[e.script].tags[e.tag]:null:{FAIL:"No feature for script "+e.script}};function th(t){var e=t.current,r=t.get(-1);return r===null&&je(e)||!je(r)&&je(e)}function rh(t){var e=t.get(1);return e===null||!je(e)}var nh={startCheck:th,endCheck:rh};function ah(t){var e=t.current,r=t.get(-1);return(je(e)||We(e))&&!je(r)}function sh(t){var e=t.get(1);switch(!0){case e===null:return!0;case(!je(e)&&!We(e)):var r=Yc(e);if(!r)return!0;if(r){var n=!1;if(n=t.lookahead.some(function(a){return je(a)||We(a)}),!n)return!0}break;default:return!1}}var ih={startCheck:ah,endCheck:sh};function oh(t,e,r){e[r].setState(t.tag,t.substitution)}function lh(t,e,r){e[r].setState(t.tag,t.substitution)}function uh(t,e,r){t.substitution.forEach(function(n,a){var s=e[r+a];s.setState(t.tag,n)})}function ch(t,e,r){var n=e[r];n.setState(t.tag,t.substitution.ligGlyph);for(var a=t.substitution.components.length,s=0;s<a;s++)n=e[r+s+1],n.setState("deleted",!0)}var tn={11:oh,12:lh,63:uh,41:ch};function mr(t,e,r){t instanceof Ye&&tn[t.id]&&tn[t.id](t,e,r)}function hh(t){for(var e=[].concat(t.backtrack),r=e.length-1;r>=0;r--){var n=e[r],a=ta(n),s=We(n);if(!a&&!s)return!0;if(a)return!1}return!1}function dh(t){if(ta(t.current))return!1;for(var e=0;e<t.lookahead.length;e++){var r=t.lookahead[e],n=We(r);if(!n)return!0}return!1}function fh(t){var e=this,r="arab",n=this.featuresTags[r],a=this.tokenizer.getRangeTokens(t);if(a.length!==1){var s=new ke(a.map(function(o){return o.getState("glyphIndex")}),0),i=new ke(a.map(function(o){return o.char}),0);a.forEach(function(o,l){if(!We(o.char)){s.setCurrentIndex(l),i.setCurrentIndex(l);var c=0;hh(i)&&(c|=1),dh(i)&&(c|=2);var u;switch(c){case 1:u="fina";break;case 2:u="init";break;case 3:u="medi";break}if(n.indexOf(u)!==-1){var f=e.query.lookupFeature({tag:u,script:r,contextParams:s});if(f instanceof Error)return console.info(f.message);f.forEach(function(h,p){h instanceof Ye&&(mr(h,a,p),s.context[p]=h.substitution)})}}})}}function rn(t,e){var r=t.map(function(n){return n.activeState.value});return new ke(r,0)}function ph(t){var e=this,r="arab",n=this.tokenizer.getRangeTokens(t),a=rn(n);a.context.forEach(function(s,i){a.setCurrentIndex(i);var o=e.query.lookupFeature({tag:"rlig",script:r,contextParams:a});o.length&&(o.forEach(function(l){return mr(l,n,i)}),a=rn(n))})}function gh(t){var e=t.current,r=t.get(-1);return r===null&&_t(e)||!_t(r)&&_t(e)}function mh(t){var e=t.get(1);return e===null||!_t(e)}var vh={startCheck:gh,endCheck:mh};function nn(t,e){var r=t.map(function(n){return n.activeState.value});return new ke(r,0)}function yh(t){var e=this,r="latn",n=this.tokenizer.getRangeTokens(t),a=nn(n);a.context.forEach(function(s,i){a.setCurrentIndex(i);var o=e.query.lookupFeature({tag:"liga",script:r,contextParams:a});o.length&&(o.forEach(function(l){return mr(l,n,i)}),a=nn(n))})}function Fe(t){this.baseDir=t||"ltr",this.tokenizer=new ne,this.featuresTags={}}Fe.prototype.setText=function(t){this.text=t};Fe.prototype.contextChecks={latinWordCheck:vh,arabicWordCheck:nh,arabicSentenceCheck:ih};function Xt(t){var e=this.contextChecks[t+"Check"];return this.tokenizer.registerContextChecker(t,e.startCheck,e.endCheck)}function bh(){return Xt.call(this,"latinWord"),Xt.call(this,"arabicWord"),Xt.call(this,"arabicSentence"),this.tokenizer.tokenize(this.text)}function xh(){var t=this,e=this.tokenizer.getContextRanges("arabicSentence");e.forEach(function(r){var n=t.tokenizer.getRangeTokens(r);t.tokenizer.replaceRange(r.startIndex,r.endOffset,n.reverse())})}Fe.prototype.registerFeatures=function(t,e){var r=this,n=e.filter(function(a){return r.query.supports({script:t,tag:a})});this.featuresTags.hasOwnProperty(t)?this.featuresTags[t]=this.featuresTags[t].concat(n):this.featuresTags[t]=n};Fe.prototype.applyFeatures=function(t,e){if(!t)throw new Error("No valid font was provided to apply features");this.query||(this.query=new ve(t));for(var r=0;r<e.length;r++){var n=e[r];this.query.supports({script:n.script})&&this.registerFeatures(n.script,n.tags)}};Fe.prototype.registerModifier=function(t,e,r){this.tokenizer.registerModifier(t,e,r)};function vr(){if(this.tokenizer.registeredModifiers.indexOf("glyphIndex")===-1)throw new Error("glyphIndex modifier is required to apply arabic presentation features.")}function wh(){var t=this,e="arab";if(this.featuresTags.hasOwnProperty(e)){vr.call(this);var r=this.tokenizer.getContextRanges("arabicWord");r.forEach(function(n){fh.call(t,n)})}}function kh(){var t=this,e="arab";if(this.featuresTags.hasOwnProperty(e)){var r=this.featuresTags[e];if(r.indexOf("rlig")!==-1){vr.call(this);var n=this.tokenizer.getContextRanges("arabicWord");n.forEach(function(a){ph.call(t,a)})}}}function Sh(){var t=this,e="latn";if(this.featuresTags.hasOwnProperty(e)){var r=this.featuresTags[e];if(r.indexOf("liga")!==-1){vr.call(this);var n=this.tokenizer.getContextRanges("latinWord");n.forEach(function(a){yh.call(t,a)})}}}Fe.prototype.checkContextReady=function(t){return!!this.tokenizer.getContext(t)};Fe.prototype.applyFeaturesToContexts=function(){this.checkContextReady("arabicWord")&&(wh.call(this),kh.call(this)),this.checkContextReady("latinWord")&&Sh.call(this),this.checkContextReady("arabicSentence")&&xh.call(this)};Fe.prototype.processText=function(t){(!this.text||this.text!==t)&&(this.setText(t),bh.call(this),this.applyFeaturesToContexts())};Fe.prototype.getBidiText=function(t){return this.processText(t),this.tokenizer.getText()};Fe.prototype.getTextGlyphs=function(t){this.processText(t);for(var e=[],r=0;r<this.tokenizer.tokens.length;r++){var n=this.tokenizer.tokens[r];if(!n.state.deleted){var a=n.activeState.value;e.push(Array.isArray(a)?a[0]:a)}}return e};function Q(t){t=t||{},t.tables=t.tables||{},t.empty||(at(t.familyName,"When creating a new Font object, familyName is required."),at(t.styleName,"When creating a new Font object, styleName is required."),at(t.unitsPerEm,"When creating a new Font object, unitsPerEm is required."),at(t.ascender,"When creating a new Font object, ascender is required."),at(t.descender<=0,"When creating a new Font object, negative descender value is required."),this.names={fontFamily:{en:t.familyName||" "},fontSubfamily:{en:t.styleName||" "},fullName:{en:t.fullName||t.familyName+" "+t.styleName},postScriptName:{en:t.postScriptName||(t.familyName+t.styleName).replace(/\s/g,"")},designer:{en:t.designer||" "},designerURL:{en:t.designerURL||" "},manufacturer:{en:t.manufacturer||" "},manufacturerURL:{en:t.manufacturerURL||" "},license:{en:t.license||" "},licenseURL:{en:t.licenseURL||" "},version:{en:t.version||"Version 0.1"},description:{en:t.description||" "},copyright:{en:t.copyright||" "},trademark:{en:t.trademark||" "}},this.unitsPerEm=t.unitsPerEm||1e3,this.ascender=t.ascender,this.descender=t.descender,this.createdTimestamp=t.createdTimestamp,this.tables=Object.assign(t.tables,{os2:Object.assign({usWeightClass:t.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:t.widthClass||this.usWidthClasses.MEDIUM,fsSelection:t.fsSelection||this.fsSelectionValues.REGULAR},t.tables.os2)})),this.supported=!0,this.glyphs=new Le.GlyphSet(this,t.glyphs||[]),this.encoding=new bn(this),this.position=new ft(this),this.substitution=new me(this),this.tables=this.tables||{},this._push=null,this._hmtxTableData={},Object.defineProperty(this,"hinting",{get:function(){if(this._hinting)return this._hinting;if(this.outlinesFormat==="truetype")return this._hinting=new Zn(this)}})}Q.prototype.hasChar=function(t){return this.encoding.charToGlyphIndex(t)!==null};Q.prototype.charToGlyphIndex=function(t){return this.encoding.charToGlyphIndex(t)};Q.prototype.charToGlyph=function(t){var e=this.charToGlyphIndex(t),r=this.glyphs.get(e);return r||(r=this.glyphs.get(0)),r};Q.prototype.updateFeatures=function(t){return this.defaultRenderOptions.features.map(function(e){return e.script==="latn"?{script:"latn",tags:e.tags.filter(function(r){return t[r]})}:e})};Q.prototype.stringToGlyphs=function(t,e){var r=this,n=new Fe,a=function(f){return r.charToGlyphIndex(f.char)};n.registerModifier("glyphIndex",null,a);var s=e?this.updateFeatures(e.features):this.defaultRenderOptions.features;n.applyFeatures(this,s);for(var i=n.getTextGlyphs(t),o=i.length,l=new Array(o),c=this.glyphs.get(0),u=0;u<o;u+=1)l[u]=this.glyphs.get(i[u])||c;return l};Q.prototype.nameToGlyphIndex=function(t){return this.glyphNames.nameToGlyphIndex(t)};Q.prototype.nameToGlyph=function(t){var e=this.nameToGlyphIndex(t),r=this.glyphs.get(e);return r||(r=this.glyphs.get(0)),r};Q.prototype.glyphIndexToName=function(t){return this.glyphNames.glyphIndexToName?this.glyphNames.glyphIndexToName(t):""};Q.prototype.getKerningValue=function(t,e){t=t.index||t,e=e.index||e;var r=this.position.defaultKerningTables;return r?this.position.getKerningValue(r,t,e):this.kerningPairs[t+","+e]||0};Q.prototype.defaultRenderOptions={kerning:!0,features:[{script:"arab",tags:["init","medi","fina","rlig"]},{script:"latn",tags:["liga","rlig"]}]};Q.prototype.forEachGlyph=function(t,e,r,n,a,s){e=e!==void 0?e:0,r=r!==void 0?r:0,n=n!==void 0?n:72,a=Object.assign({},this.defaultRenderOptions,a);var i=1/this.unitsPerEm*n,o=this.stringToGlyphs(t,a),l;if(a.kerning){var c=a.script||this.position.getDefaultScriptName();l=this.position.getKerningTables(c,a.language)}for(var u=0;u<o.length;u+=1){var f=o[u];if(s.call(this,f,e,r,n,a),f.advanceWidth&&(e+=f.advanceWidth*i),a.kerning&&u<o.length-1){var h=l?this.position.getKerningValue(l,f.index,o[u+1].index):this.getKerningValue(f,o[u+1]);e+=h*i}a.letterSpacing?e+=a.letterSpacing*n:a.tracking&&(e+=a.tracking/1e3*n)}return e};Q.prototype.getPath=function(t,e,r,n,a){var s=new oe;return this.forEachGlyph(t,e,r,n,a,function(i,o,l,c){var u=i.getPath(o,l,c,a,this);s.extend(u)}),s};Q.prototype.getPaths=function(t,e,r,n,a){var s=[];return this.forEachGlyph(t,e,r,n,a,function(i,o,l,c){var u=i.getPath(o,l,c,a,this);s.push(u)}),s};Q.prototype.getAdvanceWidth=function(t,e,r){return this.forEachGlyph(t,0,0,e,r,function(){})};Q.prototype.draw=function(t,e,r,n,a,s){this.getPath(e,r,n,a,s).draw(t)};Q.prototype.drawPoints=function(t,e,r,n,a,s){this.forEachGlyph(e,r,n,a,s,function(i,o,l,c){i.drawPoints(t,o,l,c)})};Q.prototype.drawMetrics=function(t,e,r,n,a,s){this.forEachGlyph(e,r,n,a,s,function(i,o,l,c){i.drawMetrics(t,o,l,c)})};Q.prototype.getEnglishName=function(t){var e=this.names[t];if(e)return e.en};Q.prototype.validate=function(){var t=this;function e(n,a){}function r(n){var a=t.getEnglishName(n);a&&a.trim().length>0}r("fontFamily"),r("weightName"),r("manufacturer"),r("copyright"),r("version"),this.unitsPerEm>0};Q.prototype.toTables=function(){return cu.fontToTable(this)};Q.prototype.toBuffer=function(){return console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead."),this.toArrayBuffer()};Q.prototype.toArrayBuffer=function(){for(var t=this.toTables(),e=t.encode(),r=new ArrayBuffer(e.length),n=new Uint8Array(r),a=0;a<e.length;a++)n[a]=e[a];return r};Q.prototype.download=function(t){var e=this.getEnglishName("fontFamily"),r=this.getEnglishName("fontSubfamily");t=t||e.replace(/\s/g,"")+"-"+r+".otf";var n=this.toArrayBuffer();if(du())if(window.URL=window.URL||window.webkitURL,window.URL){var a=new DataView(n),s=new Blob([a],{type:"font/opentype"}),i=document.createElement("a");i.href=window.URL.createObjectURL(s),i.download=t;var o=document.createEvent("MouseEvents");o.initEvent("click",!0,!1),i.dispatchEvent(o)}else console.warn("Font file could not be downloaded. Try using a different browser.");else{var l=require("fs"),c=fu(n);l.writeFileSync(t,c)}};Q.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512};Q.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9};Q.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function ra(t,e){var r=JSON.stringify(t),n=256;for(var a in e){var s=parseInt(a);if(!(!s||s<256)){if(JSON.stringify(e[a])===r)return s;n<=s&&(n=s+1)}}return e[n]=t,n}function Th(t,e,r){var n=ra(e.name,r);return[{name:"tag_"+t,type:"TAG",value:e.tag},{name:"minValue_"+t,type:"FIXED",value:e.minValue<<16},{name:"defaultValue_"+t,type:"FIXED",value:e.defaultValue<<16},{name:"maxValue_"+t,type:"FIXED",value:e.maxValue<<16},{name:"flags_"+t,type:"USHORT",value:0},{name:"nameID_"+t,type:"USHORT",value:n}]}function Fh(t,e,r){var n={},a=new N.Parser(t,e);return n.tag=a.parseTag(),n.minValue=a.parseFixed(),n.defaultValue=a.parseFixed(),n.maxValue=a.parseFixed(),a.skip("uShort",1),n.name=r[a.parseUShort()]||{},n}function Ch(t,e,r,n){for(var a=ra(e.name,n),s=[{name:"nameID_"+t,type:"USHORT",value:a},{name:"flags_"+t,type:"USHORT",value:0}],i=0;i<r.length;++i){var o=r[i].tag;s.push({name:"axis_"+t+" "+o,type:"FIXED",value:e.coordinates[o]<<16})}return s}function _h(t,e,r,n){var a={},s=new N.Parser(t,e);a.name=n[s.parseUShort()]||{},s.skip("uShort",1),a.coordinates={};for(var i=0;i<r.length;++i)a.coordinates[r[i].tag]=s.parseFixed();return a}function Eh(t,e){var r=new D.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:t.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:t.instances.length},{name:"instanceSize",type:"USHORT",value:4+t.axes.length*4}]);r.offsetToData=r.sizeOf();for(var n=0;n<t.axes.length;n++)r.fields=r.fields.concat(Th(n,t.axes[n],e));for(var a=0;a<t.instances.length;a++)r.fields=r.fields.concat(Ch(a,t.instances[a],t.axes,e));return r}function Uh(t,e,r){var n=new N.Parser(t,e),a=n.parseULong();$.argument(a===65536,"Unsupported fvar table version.");var s=n.parseOffset16();n.skip("uShort",1);for(var i=n.parseUShort(),o=n.parseUShort(),l=n.parseUShort(),c=n.parseUShort(),u=[],f=0;f<i;f++)u.push(Fh(t,e+s+f*o,r));for(var h=[],p=e+s+i*o,y=0;y<l;y++)h.push(_h(t,p+y*c,u,r));return{axes:u,instances:h}}var Lh={make:Eh,parse:Uh},Oh=function(){return{coverage:this.parsePointer(k.coverage),attachPoints:this.parseList(k.pointer(k.uShortList))}},Bh=function(){var t=this.parseUShort();if($.argument(t===1||t===2||t===3,"Unsupported CaretValue table version."),t===1)return{coordinate:this.parseShort()};if(t===2)return{pointindex:this.parseShort()};if(t===3)return{coordinate:this.parseShort()}},Rh=function(){return this.parseList(k.pointer(Bh))},Ah=function(){return{coverage:this.parsePointer(k.coverage),ligGlyphs:this.parseList(k.pointer(Rh))}},Ih=function(){return this.parseUShort(),this.parseList(k.pointer(k.coverage))};function Dh(t,e){e=e||0;var r=new k(t,e),n=r.parseVersion(1);$.argument(n===1||n===1.2||n===1.3,"Unsupported GDEF table version.");var a={version:n,classDef:r.parsePointer(k.classDef),attachList:r.parsePointer(Oh),ligCaretList:r.parsePointer(Ah),markAttachClassDef:r.parsePointer(k.classDef)};return n>=1.2&&(a.markGlyphSets=r.parsePointer(Ih)),a}var Mh={parse:Dh},Se=new Array(10);Se[1]=function(){var e=this.offset+this.relativeOffset,r=this.parseUShort();if(r===1)return{posFormat:1,coverage:this.parsePointer(k.coverage),value:this.parseValueRecord()};if(r===2)return{posFormat:2,coverage:this.parsePointer(k.coverage),values:this.parseValueRecordList()};$.assert(!1,"0x"+e.toString(16)+": GPOS lookup type 1 format must be 1 or 2.")};Se[2]=function(){var e=this.offset+this.relativeOffset,r=this.parseUShort();$.assert(r===1||r===2,"0x"+e.toString(16)+": GPOS lookup type 2 format must be 1 or 2.");var n=this.parsePointer(k.coverage),a=this.parseUShort(),s=this.parseUShort();if(r===1)return{posFormat:r,coverage:n,valueFormat1:a,valueFormat2:s,pairSets:this.parseList(k.pointer(k.list(function(){return{secondGlyph:this.parseUShort(),value1:this.parseValueRecord(a),value2:this.parseValueRecord(s)}})))};if(r===2){var i=this.parsePointer(k.classDef),o=this.parsePointer(k.classDef),l=this.parseUShort(),c=this.parseUShort();return{posFormat:r,coverage:n,valueFormat1:a,valueFormat2:s,classDef1:i,classDef2:o,class1Count:l,class2Count:c,classRecords:this.parseList(l,k.list(c,function(){return{value1:this.parseValueRecord(a),value2:this.parseValueRecord(s)}}))}}};Se[3]=function(){return{error:"GPOS Lookup 3 not supported"}};Se[4]=function(){return{error:"GPOS Lookup 4 not supported"}};Se[5]=function(){return{error:"GPOS Lookup 5 not supported"}};Se[6]=function(){return{error:"GPOS Lookup 6 not supported"}};Se[7]=function(){return{error:"GPOS Lookup 7 not supported"}};Se[8]=function(){return{error:"GPOS Lookup 8 not supported"}};Se[9]=function(){return{error:"GPOS Lookup 9 not supported"}};function Ph(t,e){e=e||0;var r=new k(t,e),n=r.parseVersion(1);return $.argument(n===1||n===1.1,"Unsupported GPOS table version "+n),n===1?{version:n,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(Se)}:{version:n,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(Se),variations:r.parseFeatureVariationsList()}}var Nh=new Array(10);function Gh(t){return new D.Table("GPOS",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new D.ScriptList(t.scripts)},{name:"features",type:"TABLE",value:new D.FeatureList(t.features)},{name:"lookups",type:"TABLE",value:new D.LookupList(t.lookups,Nh)}])}var zh={parse:Ph,make:Gh};function Vh(t){var e={};t.skip("uShort");var r=t.parseUShort();$.argument(r===0,"Unsupported kern sub-table version."),t.skip("uShort",2);var n=t.parseUShort();t.skip("uShort",3);for(var a=0;a<n;a+=1){var s=t.parseUShort(),i=t.parseUShort(),o=t.parseShort();e[s+","+i]=o}return e}function $h(t){var e={};t.skip("uShort");var r=t.parseULong();r>1&&console.warn("Only the first kern subtable is supported."),t.skip("uLong");var n=t.parseUShort(),a=n&255;if(t.skip("uShort"),a===0){var s=t.parseUShort();t.skip("uShort",3);for(var i=0;i<s;i+=1){var o=t.parseUShort(),l=t.parseUShort(),c=t.parseShort();e[o+","+l]=c}}return e}function Hh(t,e){var r=new N.Parser(t,e),n=r.parseUShort();if(n===0)return Vh(r);if(n===1)return $h(r);throw new Error("Unsupported kern table version ("+n+").")}var jh={parse:Hh};function Wh(t,e,r,n){for(var a=new N.Parser(t,e),s=n?a.parseUShort:a.parseULong,i=[],o=0;o<r+1;o+=1){var l=s.call(a);n&&(l*=2),i.push(l)}return i}var Xh={parse:Wh};function qh(t,e){var r=require("fs");r.readFile(t,function(n,a){if(n)return e(n.message);e(null,Hn(a))})}function Yh(t,e){var r=new XMLHttpRequest;r.open("get",t,!0),r.responseType="arraybuffer",r.onload=function(){return r.response?e(null,r.response):e("Font could not be loaded: "+r.statusText)},r.onerror=function(){e("Font could not be loaded")},r.send()}function an(t,e){for(var r=[],n=12,a=0;a<e;a+=1){var s=N.getTag(t,n),i=N.getULong(t,n+4),o=N.getULong(t,n+8),l=N.getULong(t,n+12);r.push({tag:s,checksum:i,offset:o,length:l,compression:!1}),n+=16}return r}function Kh(t,e){for(var r=[],n=44,a=0;a<e;a+=1){var s=N.getTag(t,n),i=N.getULong(t,n+4),o=N.getULong(t,n+8),l=N.getULong(t,n+12),c=void 0;o<l?c="WOFF":c=!1,r.push({tag:s,offset:i,compression:c,compressedLength:o,length:l}),n+=20}return r}function ae(t,e){if(e.compression==="WOFF"){var r=new Uint8Array(t.buffer,e.offset+2,e.compressedLength-2),n=new Uint8Array(e.length);if(zo(r,n),n.byteLength!==e.length)throw new Error("Decompression error: "+e.tag+" decompressed length doesn't match recorded length");var a=new DataView(n.buffer,0);return{data:a,offset:0}}else return{data:t,offset:e.offset}}function yr(t,e){e=e??{};var r,n,a=new Q({empty:!0}),s=new DataView(t,0),i,o=[],l=N.getTag(s,0);if(l==="\0\0\0"||l==="true"||l==="typ1")a.outlinesFormat="truetype",i=N.getUShort(s,4),o=an(s,i);else if(l==="OTTO")a.outlinesFormat="cff",i=N.getUShort(s,4),o=an(s,i);else if(l==="wOFF"){var c=N.getTag(s,4);if(c==="\0\0\0")a.outlinesFormat="truetype";else if(c==="OTTO")a.outlinesFormat="cff";else throw new Error("Unsupported OpenType flavor "+l);i=N.getUShort(s,12),o=Kh(s,i)}else throw new Error("Unsupported OpenType signature "+l);for(var u,f,h,p,y,b,m,g,w,v,S,F,B=0;B<i;B+=1){var L=o[B],O=void 0;switch(L.tag){case"cmap":O=ae(s,L),a.tables.cmap=yn.parse(O.data,O.offset),a.encoding=new xn(a.tables.cmap);break;case"cvt ":O=ae(s,L),F=new N.Parser(O.data,O.offset),a.tables.cvt=F.parseShortList(L.length/2);break;case"fvar":f=L;break;case"fpgm":O=ae(s,L),F=new N.Parser(O.data,O.offset),a.tables.fpgm=F.parseByteList(L.length);break;case"head":O=ae(s,L),a.tables.head=Ln.parse(O.data,O.offset),a.unitsPerEm=a.tables.head.unitsPerEm,r=a.tables.head.indexToLocFormat;break;case"hhea":O=ae(s,L),a.tables.hhea=On.parse(O.data,O.offset),a.ascender=a.tables.hhea.ascender,a.descender=a.tables.hhea.descender,a.numberOfHMetrics=a.tables.hhea.numberOfHMetrics;break;case"hmtx":m=L;break;case"ltag":O=ae(s,L),n=Rn.parse(O.data,O.offset);break;case"maxp":O=ae(s,L),a.tables.maxp=An.parse(O.data,O.offset),a.numGlyphs=a.tables.maxp.numGlyphs;break;case"name":v=L;break;case"OS/2":O=ae(s,L),a.tables.os2=nr.parse(O.data,O.offset);break;case"post":O=ae(s,L),a.tables.post=Gn.parse(O.data,O.offset),a.glyphNames=new hr(a.tables.post);break;case"prep":O=ae(s,L),F=new N.Parser(O.data,O.offset),a.tables.prep=F.parseByteList(L.length);break;case"glyf":h=L;break;case"loca":w=L;break;case"CFF ":u=L;break;case"kern":g=L;break;case"GDEF":p=L;break;case"GPOS":y=L;break;case"GSUB":b=L;break;case"meta":S=L;break}}var T=ae(s,v);if(a.tables.name=Nn.parse(T.data,T.offset,n),a.names=a.tables.name,h&&w){var x=r===0,C=ae(s,w),V=Xh.parse(C.data,C.offset,a.numGlyphs,x),j=ae(s,h);a.glyphs=qn.parse(j.data,j.offset,V,a,e)}else if(u){var z=ae(s,u);Un.parse(z.data,z.offset,a,e)}else throw new Error("Font doesn't contain TrueType or CFF outlines.");var q=ae(s,m);if(Bn.parse(a,q.data,q.offset,a.numberOfHMetrics,a.numGlyphs,a.glyphs,e),ll(a,e),g){var Y=ae(s,g);a.kerningPairs=jh.parse(Y.data,Y.offset)}else a.kerningPairs={};if(p){var W=ae(s,p);a.tables.gdef=Mh.parse(W.data,W.offset)}if(y){var I=ae(s,y);a.tables.gpos=zh.parse(I.data,I.offset),a.position.init()}if(b){var E=ae(s,b);a.tables.gsub=zn.parse(E.data,E.offset)}if(f){var G=ae(s,f);a.tables.fvar=Lh.parse(G.data,G.offset,a.names)}if(S){var K=ae(s,S);a.tables.meta=Vn.parse(K.data,K.offset),a.metas=a.tables.meta}return a}function Zh(t,e,r){r=r??{};var n=typeof window>"u",a=n&&!r.isUrl?qh:Yh;return new Promise(function(s,i){a(t,function(o,l){if(o){if(e)return e(o);i(o)}var c;try{c=yr(l,r)}catch(u){if(e)return e(u,null);i(u)}if(e)return e(null,c);s(c)})})}function Jh(t,e){var r=require("fs"),n=r.readFileSync(t);return yr(Hn(n),e)}var sr=Object.freeze({__proto__:null,Font:Q,Glyph:ge,Path:oe,BoundingBox:Me,_parse:N,parse:yr,load:Zh,loadSync:Jh});const Qh=()=>ya(()=>import("./ft_render-ByO_jG18.js"),[]);let _=null,ht=0;const ed=new Promise(t=>{Qh().then(e=>{e.default().then(r=>{_=r,t()})})});function sn(t){return t/65536}function ye(t){return t/64}function st(t){return t>=0?t:t+256}let na,aa,sa,br,ia,oa,la;async function td(){if(await ed,_._init_constants(),na=_.cwrap("FT_New_Memory_Face","number",["number","number","number","number","number"]),aa=_.cwrap("FT_Set_Char_Size","number",["number","number","number","number","number"]),sa=_.cwrap("FT_Set_Pixel_Sizes","number",["number","number","number"]),br=_.cwrap("FT_Get_Char_Index","number",["number","number"]),ia=_.cwrap("FT_Load_Glyph","number",["number","number","number"]),oa=_.cwrap("FT_Get_Sfnt_Table","number",["number","number"]),_.cwrap("FT_Get_Kerning","number",["number","number","number","number","number"]),la=_.cwrap("FT_Done_Face","number",["number"]),!ht){let t=_._malloc(4);try{let e=_.ccall("FT_Init_FreeType","number",["number"],[t]);if(e)throw new Error(`error in FT_Init_FreeType: ${e}`);ht=_.getValue(t,"i32")}finally{_._free(t)}}}function rd(t,e){let r,n;if(t instanceof ArrayBuffer)n=t.byteLength;else if(t instanceof Uint8Array)n=t.byteLength;else if(t&&typeof t.length=="number")n=t.length;else throw new Error("Invalid font source format");let a={ptr:0,font:_._malloc(n)};const s=t instanceof ArrayBuffer?new Uint8Array(t):t;_.writeArrayToMemory(s,a.font);let i=_._malloc(4);try{if(r=na(ht,a.font,n,0,i),r)throw new Error(`error in FT_New_Memory_Face: ${r}`);a.ptr=_.getValue(i,"i32")}finally{_._free(i)}if(r=aa(a.ptr,0,e*64,300,300),r)throw new Error(`error in FT_Set_Char_Size: ${r}`);if(r=sa(a.ptr,0,e),r)throw new Error(`error in FT_Set_Pixel_Sizes: ${r}`);let o=_.getValue(a.ptr+_.OFFSET_FACE_UNITS_PER_EM,"i16"),l=_.getValue(a.ptr+_.OFFSET_FACE_ASCENDER,"i16"),c=_.getValue(a.ptr+_.OFFSET_FACE_DESCENDER,"i16"),u=_.getValue(a.ptr+_.OFFSET_FACE_HEIGHT,"i16");return Object.assign(a,{units_per_em:o,ascender:l,descender:c,height:u})}function nd(t){let e=oa(t.ptr,_.FT_SFNT_OS2);if(!e)throw new Error("os/2 table not found for this font");let r=_.getValue(e+_.OFFSET_TT_OS2_ASCENDER,"i16"),n=_.getValue(e+_.OFFSET_TT_OS2_DESCENDER,"i16"),a=_.getValue(e+_.OFFSET_TT_OS2_LINEGAP,"i16");return{typoAscent:r,typoDescent:n,typoLineGap:a}}function qt(t,e){return br(t.ptr,e)!==0}function ad(t,e,r={}){let n=br(t.ptr,e);if(n===0)throw new Error(`glyph does not exist for codepoint ${e}`);let a=_.FT_LOAD_RENDER;r.mono?a|=_.FT_LOAD_TARGET_MONO:r.lcd?a|=_.FT_LOAD_TARGET_LCD:r.lcd_v?a|=_.FT_LOAD_TARGET_LCD_V:r.autohint_strong?a|=_.FT_LOAD_TARGET_NORMAL:a|=_.FT_LOAD_TARGET_LIGHT,r.autohint_off?a|=_.FT_LOAD_NO_AUTOHINT:a|=_.FT_LOAD_FORCE_AUTOHINT,r.use_color_info&&(a|=_.FT_LOAD_COLOR);let s=ia(t.ptr,n,a);if(s)throw new Error(`error in FT_Load_Glyph: ${s}`);let i=_.getValue(t.ptr+_.OFFSET_FACE_GLYPH,"i32"),o={glyph_index:_.getValue(i+_.OFFSET_GLYPH_INDEX,"i32"),metrics:{width:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_WIDTH,"i32")),height:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_HEIGHT,"i32")),horiBearingX:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_HORI_BEARING_X,"i32")),horiBearingY:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_HORI_BEARING_Y,"i32")),horiAdvance:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_HORI_ADVANCE,"i32")),vertBearingX:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_VERT_BEARING_X,"i32")),vertBearingY:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_VERT_BEARING_Y,"i32")),vertAdvance:ye(_.getValue(i+_.OFFSET_GLYPH_METRICS_VERT_ADVANCE,"i32"))},linearHoriAdvance:sn(_.getValue(i+_.OFFSET_GLYPH_LINEAR_HORI_ADVANCE,"i32")),linearVertAdvance:sn(_.getValue(i+_.OFFSET_GLYPH_LINEAR_VERT_ADVANCE,"i32")),advance:{x:ye(_.getValue(i+_.OFFSET_GLYPH_ADVANCE_X,"i32")),y:ye(_.getValue(i+_.OFFSET_GLYPH_ADVANCE_Y,"i32"))},bitmap:{width:_.getValue(i+_.OFFSET_GLYPH_BITMAP_WIDTH,"i32"),rows:_.getValue(i+_.OFFSET_GLYPH_BITMAP_ROWS,"i32"),pitch:_.getValue(i+_.OFFSET_GLYPH_BITMAP_PITCH,"i32"),num_grays:_.getValue(i+_.OFFSET_GLYPH_BITMAP_NUM_GRAYS,"i16"),pixel_mode:_.getValue(i+_.OFFSET_GLYPH_BITMAP_PIXEL_MODE,"i8"),palette_mode:_.getValue(i+_.OFFSET_GLYPH_BITMAP_PALETTE_MODE,"i8")},bitmap_left:_.getValue(i+_.OFFSET_GLYPH_BITMAP_LEFT,"i32"),bitmap_top:_.getValue(i+_.OFFSET_GLYPH_BITMAP_TOP,"i32"),lsb_delta:ye(_.getValue(i+_.OFFSET_GLYPH_LSB_DELTA,"i32")),rsb_delta:ye(_.getValue(i+_.OFFSET_GLYPH_RSB_DELTA,"i32"))},l=o.bitmap.width,c=o.bitmap.rows,u=o.bitmap_left,f=o.bitmap_top,h=_.getValue(i+_.OFFSET_GLYPH_BITMAP_BUFFER,"i32"),p=Math.abs(o.bitmap.pitch),y=o.linearHoriAdvance,b=o.linearVertAdvance,m=o.bitmap.pixel_mode,g=[];for(let w=0;w<c;w++){let v=h+w*p,S=[];for(let F=0;F<l;F++)if(m===_.FT_PIXEL_MODE_MONO){let B=_.getValue(v+~~(F/8),"i8");S.push(B&1<<7-F%8?255:0)}else if(m===_.FT_PIXEL_MODE_BGRA){let B=st(_.getValue(v+F*4+0,"i8")),L=st(_.getValue(v+F*4+1,"i8")),O=st(_.getValue(v+F*4+2,"i8")),T=st(_.getValue(v+F*4+3,"i8")),x=Math.round(.299*O+.587*L+.114*B);x>255&&(x=255),T=(255-x)*T/255,S.push(T)}else{let B=_.getValue(v+F,"i8");S.push(st(B))}g.push(S)}return{x:u,y:f,width:l,height:c,advance_x:y,advance_y:b,pixels:g,freetype:o}}function sd(t){let e=la(t.ptr);if(e)throw new Error(`error in FT_Done_Face: ${e}`);_._free(t.font),t.ptr=0,t.font=0}function id(){let t=_.ccall("FT_Done_FreeType","number",["number"],[ht]);if(t)throw new Error(`error in FT_Done_FreeType: ${t}`);ht=0}class Ie extends Error{constructor(e){super(e),this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,Ie)}}class od{constructor(){this.data={}}add_range(e,r,n,a){let s=a-r,i=[];for(let o=r;o<=n;o++)this._set_char(e,o,o+s),i.push(o);return i}add_symbols(e,r){let n=[];for(let a of r){let s=a.codePointAt(0);this._set_char(e,s,s),n.push(s)}return n}_set_char(e,r,n){this.data[n]={font:e,code:r}}get(){return this.data}}async function ld(t){await td();let e={};t.font.forEach(h=>{e[h.source_path]=h});let r={},n={};for(let{source_path:h,source_bin:p}of t.font)if(!r[h])try{let y=p;y instanceof File?y=await y.arrayBuffer():y instanceof Uint8Array&&(y=y.buffer.slice(y.byteOffset,y.byteOffset+y.byteLength)),r[h]=sr.parse(y),n[h]=rd(y,t.size)}catch(y){throw new Ie(`Cannot load font "${h}": ${y.message}`)}let a=new od;for(let{source_path:h,ranges:p}of t.font){let y=n[h];for(let b of p){if(b.range)for(let m=0;m<b.range.length;m+=3){let g=b.range.slice(m,m+3),w=a.add_range(h,...g),v=!0;for(let S of w)if(qt(y,S)){v=!1;break}if(v){let S="0x"+g[0].toString(16),F="0x"+g[1].toString(16);throw new Ie(`Font "${h}" doesn't have any characters included in range ${S}-${F}`)}}if(b.symbols){let m=a.add_symbols(h,b.symbols),g=!0;for(let w of m)if(qt(y,w)){g=!1;break}if(g)throw new Ie(`Font "${h}" doesn't have any characters included in "${b.symbols}"`)}}}let s=a.get(),i=[],o=Object.keys(s).sort((h,p)=>h-p).map(Number);for(let h of o){let p=s[h].code,y=s[h].font;if(!qt(n[y],p))continue;let b=ad(n[y],p,{autohint_off:e[y].autohint_off,autohint_strong:e[y].autohint_strong,lcd:t.lcd,lcd_v:t.lcd_v,mono:!t.lcd&&!t.lcd_v&&t.bpp===1,use_color_info:t.use_color_info});i.push({code:h,advanceWidth:b.advance_x,bbox:{x:b.x,y:b.y-b.height,width:b.width,height:b.height},kerning:{},freetype:b.freetype,pixels:b.pixels})}if(!t.no_kerning){let h=i.map(p=>p.code);for(let{code:p,kerning:y}of i){let b=s[p].code,m=s[p].font,g=r[m],w=g.charToGlyph(String.fromCodePoint(b));for(let v of h){if(s[v].font!==m)continue;let S=s[v].code,F=g.charToGlyph(String.fromCodePoint(S)),B=g.getKerningValue(w,F);B&&(y[v]=B*t.size/g.unitsPerEm)}}}let l=n[t.font[0].source_path],c=t.size/l.units_per_em,u=nd(l),f=r[t.font[0].source_path].tables.post;for(let h of Object.values(n))sd(h);return id(),{ascent:Math.max(...i.map(h=>h.bbox.y+h.bbox.height)),descent:Math.min(...i.map(h=>h.bbox.y)),typoAscent:Math.round(u.typoAscent*c),typoDescent:Math.round(u.typoDescent*c),typoLineGap:Math.round(u.typoLineGap*c),size:t.size,glyphs:i,underlinePosition:Math.round(f.underlinePosition*c),underlineThickness:Math.round(f.underlineThickness*c)}}function ud(){return 16}function cd(t,e){return 16+(e-t+1)}function hd(t){return 16+t*2}function on(t){t=t.sort((n,a)=>n-a);let e=[];for(let n=0;n<t.length;n++){let a={dist:1/0};for(let s=0;s<=n;s++){let i=s-1>=0?e[s-1].dist:0,o;t[n]-t[s]<256&&(o=cd(t[s],t[n]),i+o<a.dist&&(a={dist:i+o,start:s,end:n,format:"format0"})),t[n]-t[s]<256&&t[n]-n===t[s]-s&&(o=ud(t[s],t[n]),i+o<a.dist&&(a={dist:i+o,start:s,end:n,format:"format0_tiny"})),t[n]-t[s]<65536&&(o=hd(n-s+1),i+o<a.dist&&(a={dist:i+o,start:s,end:n,format:"sparse_tiny"}))}e[n]=a}let r=[];for(let n=t.length-1;n>=0;){let a=e[n];r.unshift([a.format,t.slice(a.start,a.end+1)]),n=a.start-1}return r}const pe=4,dd=(t,e,r)=>{t.setUint32(r,e,!0),t.setUint32(r+4,0,!0)};class fd{constructor(e,r){if(this.src=e,this.opts=r,this.font_name=r.lv_font_name,this.font_name||(this.font_name=r.output||"font"),r.bpp===3&&r.no_compress)throw new Ie('LVGL supports "--bpp 3" with compression only');this.init_tables()}init_tables(){this.head=new pd(this),this.glyf=new md(this),this.cmap=new vd(this),this.kern=new yd(this)}toCBin(){const[e,r]=this.glyf.toCBin(),n=this.cmap.toCBin(pe),a=this.kern.toCBin(pe),s=12+pe*6+0,i=8+pe*4,o=new ArrayBuffer(s+i),l=new DataView(o),c=(m,g)=>l.setUint32(g,m,!0);var u=0;c(0,u),u+=pe,c(0,u),u+=pe,c(0,u),u+=pe,l.setUint32(u,this.src.ascent-this.src.descent,!0),u+=4,l.setInt32(u,-this.src.descent,!0),u+=4,l.setUint8(u,this.src.subpixels_mode||0),u+=1,l.setInt8(u,this.src.underlinePosition||0),u+=1,l.setInt8(u,this.src.underlineThickness||0),u+=1,u+=1,c(s,u),u+=pe,c(0,u),u+=pe,c(0,u),u+=pe;const f=this.head.kern_ref();c(i+a.byteLength,u),u+=pe,c(i+a.byteLength+e.byteLength,u),u+=pe,c(i+a.byteLength+e.byteLength+r.byteLength,u),u+=pe,c(f.dsc==="NULL"?0:i,u),u+=pe,l.setUint16(u,f.scale,!0),u+=2;const h=this.cmap.getMapNumber(),p=this.opts.bpp,y=f.classes,b=this.glyf.getCompressionCode();return l.setUint16(u,h|p<<9|y<<13|b<<14,!0),u+=2,this.concatArrayBuffers([o,a,e,r,n])}concatArrayBuffers(e){const r=e.reduce((i,o)=>i+o.byteLength,0),n=new ArrayBuffer(r),a=new Uint8Array(n);let s=0;for(const i of e)a.set(new Uint8Array(i),s),s+=i.byteLength;return n}}class pd{constructor(e){this.font=e}kern_ref(){return this.font,{scale:0,dsc:"NULL",classes:0}}}class gd{constructor(e){this.buffer=new Uint8Array(e),this.byteIndex=0,this.bitIndex=0,this.bigEndian=!0}writeBits(e,r){for(;r>0;){const n=Math.min(8-this.bitIndex,r),a=(1<<n)-1,s=e>>r-n&a;this.bigEndian?this.buffer[this.byteIndex]|=s<<8-this.bitIndex-n:this.buffer[this.byteIndex]|=s<<this.bitIndex,this.bitIndex+=n,this.bitIndex>=8&&(this.byteIndex++,this.bitIndex=0),r-=n}}getUsedBytes(){return this.bitIndex>0?this.byteIndex+1:this.byteIndex}}class md{constructor(e){this.font=e,this.lv_data=[],this.lv_compiled=!1}pixelsToBpp(e){const r=this.font.opts.bpp;return e.map(n=>n.map(a=>a>>>8-r))}storePixels(e,r){this.getCompressionCode()===0?this.storePixelsRaw(e,r):this.storePixelsCompressed(e,r)}storePixelsRaw(e,r){const n=this.font.opts.bpp;for(let a=0;a<r.length;a++){const s=r[a];for(let i=0;i<s.length;i++)e.writeBits(s[i],n)}}storePixelsCompressed(e,r){this.storePixelsRaw(e,r)}lv_bitmap(e){const r=100+e.bbox.width*e.bbox.height*4,n=new ArrayBuffer(r),a=new gd(n);a.bigEndian=!0;const s=this.pixelsToBpp(e.pixels);this.storePixels(a,s);const i=new ArrayBuffer(a.getUsedBytes()),o=new Uint8Array(n);return new Uint8Array(i).set(o.subarray(0,a.getUsedBytes())),i}lv_compile(){if(this.lv_compiled)return;this.lv_compiled=!0;const e=this.font;this.lv_data=[];let r=0;e.src.glyphs.forEach(n=>{const a=e.glyph_id[n.code],s=this.lv_bitmap(n);this.lv_data[a]={bin:s,offset:r,glyph:n},r+=s.byteLength})}toCBin(){this.lv_compile();const e=this.lv_data.slice(1).filter(i=>i).map(i=>i.bin),r=this.balign4(this.concatArrayBuffers(e)),n=new ArrayBuffer(this.lv_data.length*16+16),a=new DataView(n);let s=1;return this.lv_data.forEach(i=>{if(i){const o=Math.round(i.glyph.advanceWidth*16);a.setUint32(s*16,i.offset,!0),a.setUint32(s*16+4,o,!0),a.setUint16(s*16+8,i.glyph.bbox.width,!0),a.setUint16(s*16+10,i.glyph.bbox.height,!0),a.setInt16(s*16+12,i.glyph.bbox.x,!0),a.setInt16(s*16+14,i.glyph.bbox.y,!0)}s++}),[r,n]}balign4(e){const r=e.byteLength%4;if(r===0)return e;const n=4-r,a=new ArrayBuffer(n);return this.concatArrayBuffers([e,a])}concatArrayBuffers(e){const r=e.reduce((i,o)=>i+o.byteLength,0),n=new ArrayBuffer(r),a=new Uint8Array(n);let s=0;for(const i of e)a.set(new Uint8Array(i),s),s+=i.byteLength;return n}getCompressionCode(){return this.font.opts.no_compress||this.font.opts.bpp===1?0:this.font.opts.no_prefilter?2:1}}class vd{constructor(e){this.font=e,this.lv_compiled=!1,this.lv_subtables=[],this.subtables_plan=null,this.buildGlyphIdMap()}buildGlyphIdMap(){const e=this.font;e.glyph_id={},e.src.glyphs&&e.src.glyphs.forEach((r,n)=>{e.glyph_id[r.code]=n+1})}lv_format2enum(e){switch(e){case"format0_tiny":return"LV_FONT_FMT_TXT_CMAP_FORMAT0_TINY";case"format0":return"LV_FONT_FMT_TXT_CMAP_FORMAT0_FULL";case"sparse_tiny":return"LV_FONT_FMT_TXT_CMAP_SPARSE_TINY";case"sparse":return"LV_FONT_FMT_TXT_CMAP_SPARSE_FULL";default:throw new Error("Unknown subtable format")}}lv_format2int(e){return["format0","sparse","format0_tiny","sparse_tiny"].indexOf(e)}getMapNumber(){if(!this.subtables_plan){const e=this.font;if(!e.src.glyphs||e.src.glyphs.length===0)return 0;this.subtables_plan=on(e.src.glyphs.map(r=>r.code))}return this.subtables_plan.length}glyphByCode(e){const r=this.font;return r.src.glyphs?r.src.glyphs.find(n=>n.code===e):null}collect_format0_data(e,r,n){const a=this.font,s=[];for(let i=e;i<=r;i++){const o=a.glyph_id[i]||0;s.push(o?o-n:0)}return s}collect_sparse_data(e,r){const n=this.font;let a=[],s=[];for(let i of e){let o=this.glyphByCode(i),l=n.glyph_id[o.code],c=i-e[0],u=l-r;if(c<0||c>65535)throw new Error("Codepoint delta out of range");if(u<0||u>65535)throw new Error("Glyph ID delta out of range");a.push(c),s.push(u)}return{codes:a,ids:s}}toCBin(e){const r=this.font;if(!r.src.glyphs||r.src.glyphs.length===0)return new ArrayBuffer(0);this.subtables_plan||(this.subtables_plan=on(r.src.glyphs.map(f=>f.code)));const n=this.subtables_plan;let a=0;const s=12+e*2+(e==4?0:4),i=new ArrayBuffer(n.length*s),o=new DataView(i),l=e==4?(f,h)=>o.setUint32(h,f,!0):(f,h)=>dd(o,f,h),c=[];let u=i.byteLength;for(let[f,h]of n){let p=this.glyphByCode(h[0]),y=r.glyph_id[p.code],b=h[0],m=h[h.length-1],g=!1,w=!1,v=0,S=new ArrayBuffer(0),F=new ArrayBuffer(0);if(f!=="format0_tiny")if(f==="format0"){w=!0;let L=this.collect_format0_data(b,m,y);v=L.length,S=this.balign4(this.uint8ArrayToBuffer(new Uint8Array(L)))}else if(f==="sparse_tiny"){g=!0;let L=this.collect_sparse_data(h,y);v=L.codes.length,F=this.balign4(this.uint16ArrayToBuffer(new Uint16Array(L.codes)))}else{g=!0,w=!0;let L=this.collect_sparse_data(h,y);v=L.codes.length,F=this.balign4(this.uint16ArrayToBuffer(new Uint16Array(L.codes))),S=this.align4(this.uint16ArrayToBuffer(new Uint16Array(L.ids)))}let B=a*s;o.setUint32(B,b,!0),B+=4,o.setUint16(B,m-b+1,!0),B+=2,o.setUint16(B,y,!0),B+=2,l(g?u:0,B),B+=e,u+=F.byteLength,l(w?u:0,B),B+=e,u+=S.byteLength,o.setUint16(B,v,!0),B+=2,o.setUint8(B,this.lv_format2int(f)),B+=1,c.push(F),c.push(S),a++}return this.concatArrayBuffers([i,...c])}balign4(e){const r=e.byteLength%4;if(r===0)return e;const n=4-r,a=new ArrayBuffer(n);return this.concatArrayBuffers([e,a])}align4(e){const r=e.byteLength%4;if(r===0)return e;const n=4-r,a=new ArrayBuffer(n);return this.concatArrayBuffers([e,a])}uint8ArrayToBuffer(e){const r=new ArrayBuffer(e.byteLength);return new Uint8Array(r).set(e),r}uint16ArrayToBuffer(e){return e.buffer.slice(0,e.byteLength)}concatArrayBuffers(e){const r=e.reduce((i,o)=>i+o.byteLength,0),n=new ArrayBuffer(r),a=new Uint8Array(n);let s=0;for(const i of e)a.set(new Uint8Array(i),s),s+=i.byteLength;return n}}class yd{constructor(e){this.font=e}toCBin(e){return new ArrayBuffer(0)}}function bd(t,e){if(!t.output)throw new Ie('Output is required for "cbin" writer');const n=new fd(e,t).toCBin();return{[t.output]:n}}class xd{constructor(){this.initialized=!1,this.supportedFormats=["ttf","woff","woff2","otf"],this.charsetCache=new Map}async initialize(){if(!this.initialized)try{if(typeof sr>"u")throw new Error("opentype.js chưa được nạp");this.initialized=!0,console.log("BrowserFontConverter khởi tạo hoàn tất")}catch(e){throw console.error("BrowserFontConverter 初始化失败:",e),e}}validateFont(e){if(!e)return!1;if(e instanceof File){const r=e.name.toLowerCase(),n=e.type.toLowerCase(),a=this.supportedFormats.some(i=>r.endsWith(`.${i}`)),s=["font/ttf","font/truetype","application/x-font-ttf","font/woff","font/woff2","application/font-woff","font/otf","application/x-font-otf"].some(i=>n.includes(i));return a||s}return e instanceof ArrayBuffer&&e.byteLength>0}async getFontInfo(e){try{let r;if(e instanceof File)r=await e.arrayBuffer();else if(e instanceof ArrayBuffer)r=e;else throw new Error("不支持的字体文件类型");const n=sr.parse(r);return{familyName:this.getLocalizedName(n.names.fontFamily)||"Unknown",fullName:this.getLocalizedName(n.names.fullName)||"Unknown",postScriptName:this.getLocalizedName(n.names.postScriptName)||"Unknown",version:this.getLocalizedName(n.names.version)||"Unknown",unitsPerEm:n.unitsPerEm,ascender:n.ascender,descender:n.descender,numGlyphs:n.numGlyphs,supported:!0}}catch(r){return console.error("Lấy thông tin phông chữ thất bại:",r),{familyName:"Unknown",supported:!1,error:r.message}}}getLocalizedName(e){return e?e.zh||e["zh-CN"]||e.en||e[Object.keys(e)[0]]:null}async convertToCBIN(e){this.initialized||await this.initialize();const{fontFile:r,fontName:n,fontSize:a=20,bpp:s=4,charset:i="deepseek",symbols:o="",range:l="",compression:c=!1,lcd:u=!1,lcd_v:f=!1,progressCallback:h=null}=e;if(!this.validateFont(r))throw new Ie("Định dạng tệp phông chữ không được hỗ trợ");try{h&&h(0,"Bắt đầu xử lý phông chữ...");let p;r instanceof File?p=await r.arrayBuffer():p=r,h&&h(10,"Phân tích cấu trúc phông chữ...");const{ranges:y,charSymbols:b}=await this.parseCharacterInputAsync(i,o,l);h&&h(20,"Chuẩn bị tham số chuyển đổi...");const m={font:[{source_path:n||"custom_font",source_bin:p,ranges:[{range:y,symbols:b}],autohint_off:!1,autohint_strong:!1}],size:a,bpp:s,lcd:u,lcd_v:f,no_compress:!c,no_kerning:!1,use_color_info:!1,format:"cbin",output:n||"font"};h&&h(30,"Thu thập dữ liệu phông chữ...");const g=await ld(m);h&&h(70,"Tạo dữ liệu CBIN...");const w=bd(m,g),v=m.output;return h&&h(100,"Chuyển đổi hoàn tất!"),w[v]}catch(p){throw console.error("Chuyển đổi phông chữ thất bại:",p),new Ie(`Chuyển đổi phông chữ thất bại: ${p.message}`)}}async parseCharacterInputAsync(e,r,n){let a=[],s=r||"";return e&&e!=="custom"&&(s=await this.getCharsetContentAsync(e)+s),n&&(a=this.parseUnicodeRange(n)),{ranges:a,charSymbols:s}}parseCharacterInput(e,r,n){let a=[],s=r||"";return e&&e!=="custom"&&(s=this.getCharsetContent(e)+s),n&&(a=this.parseUnicodeRange(n)),{ranges:a,charSymbols:s}}async loadCharsetFromFile(e){const n={latin:"./static/charsets/latin1.txt",deepseek:"./static/charsets/deepseek.txt",gb2312:"./static/charsets/gb2312.txt"}[e];if(!n)return null;try{const a=await fetch(n);if(!a.ok)throw new Error(`Failed to load charset file: ${a.status}`);const i=(await a.text()).split(`
`).join("");return this.charsetCache.set(e,i),i}catch(a){return console.error(`Tải charset ${e} thất bại:`,a),null}}getCharsetContent(e){const r={};return(e==="latin"||e==="deepseek"||e==="gb2312")&&this.charsetCache.has(e)?this.charsetCache.get(e):e==="basic"?this.getCharsetContent("latin"):r[e]||""}async getCharsetContentAsync(e){if(e==="basic"&&(e="latin"),this.charsetCache.has(e))return this.charsetCache.get(e);if(e==="latin"||e==="deepseek"||e==="gb2312"){const r=await this.loadCharsetFromFile(e);if(r)return r}return this.getCharsetContent(e)}parseUnicodeRange(e){const r=[],n=e.split(",");for(const a of n){const s=a.trim();if(s)if(s.includes("-")){const[i,o]=s.split("-"),l=this.parseHexOrDec(i),c=this.parseHexOrDec(o);l!==null&&c!==null&&r.push(l,c,l)}else{const i=this.parseHexOrDec(s);i!==null&&r.push(i,i,i)}}return r}parseHexOrDec(e){const r=e.trim();if(r.startsWith("0x")||r.startsWith("0X")){const a=parseInt(r,16);return isNaN(a)?null:a}const n=parseInt(r,10);return isNaN(n)?null:n}async estimateSizeAsync(e){const{fontSize:r=20,bpp:n=4,charset:a="latin",symbols:s="",range:i=""}=e;let o=s.length;if(a&&a!=="custom"){const u=await this.getCharsetContentAsync(a);o+=u.length}if(i){const u=this.parseUnicodeRange(i);for(let f=0;f<u.length;f+=3)o+=u[f+1]-u[f]+1}o=Math.min(o,o*.8);const l=Math.ceil(r*r*n/8)+40,c=o*l+2048;return{characterCount:Math.floor(o),avgBytesPerChar:l,estimatedSize:c,formattedSize:this.formatBytes(c)}}estimateSize(e){const{fontSize:r=20,bpp:n=4,charset:a="latin",symbols:s="",range:i=""}=e;let o=s.length;if(a&&a!=="custom"){const u=this.getCharsetContent(a);o+=u.length}if(i){const u=this.parseUnicodeRange(i);for(let f=0;f<u.length;f+=3)o+=u[f+1]-u[f]+1}o=Math.min(o,o*.8);const l=Math.ceil(r*r*n/8)+40,c=o*l+2048;return{characterCount:Math.floor(o),avgBytesPerChar:l,estimatedSize:c,formattedSize:this.formatBytes(c)}}formatBytes(e){if(e===0)return"0 Bytes";const r=1024,n=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,a)).toFixed(2))+" "+n[a]}cleanup(){this.initialized=!1}}const wd=new xd;class kd{constructor(){this.models=new Map}addModelFile(e,r,n){this.models.has(e)||this.models.set(e,new Map),this.models.get(e).set(r,n)}async loadModelFromShare(e){try{const r=["_MODEL_INFO_","wn9_data","wn9_index"];let n=0;for(const a of r)try{const s=await fetch(`./static/wakenet_model/${e}/${a}`);if(s.ok){const i=await s.arrayBuffer();this.addModelFile(e,a,i),n++}else console.warn(`Không thể tải tệp: ${a}, mã trạng thái: ${s.status}`)}catch(s){console.warn(`Tải tệp thất bại: ${a}`,s)}return n===r.length}catch(r){return console.error(`Tải mô hình thất bại: ${e}`,r),!1}}packString(e,r){const n=new Uint8Array(r),a=Math.min(e.length,r);for(let s=0;s<a;s++)n[s]=e.charCodeAt(s)&255;return n}packUint32(e){const r=new Uint8Array(4);return r[0]=e&255,r[1]=e>>8&255,r[2]=e>>16&255,r[3]=e>>24&255,r}packModels(){if(this.models.size===0)throw new Error("Không có dữ liệu mô hình để đóng gói");let e=0;const r=[];for(const[c,u]of Array.from(this.models.entries()).sort((f,h)=>f[0].localeCompare(h[0]))){e+=u.size;const f=Array.from(u.entries()).sort((h,p)=>h[0].localeCompare(p[0]));r.push({name:c,files:f})}const n=this.models.size;let a=4;for(const c of r)a+=36,a+=c.files.length*40;const s=a+Array.from(this.models.values()).reduce((c,u)=>c+Array.from(u.values()).reduce((f,h)=>f+h.byteLength,0),0),i=new Uint8Array(s);let o=0;i.set(this.packUint32(n),o),o+=4;let l=a;for(const c of r){i.set(this.packString(c.name,32),o),o+=32,i.set(this.packUint32(c.files.length),o),o+=4;for(const[u,f]of c.files)i.set(this.packString(u,32),o),o+=32,i.set(this.packUint32(l),o),o+=4,i.set(this.packUint32(f.byteLength),o),o+=4,l+=f.byteLength}for(const c of r)for(const[u,f]of c.files)i.set(new Uint8Array(f),o),o+=f.byteLength;return i.buffer}static async getAvailableModels(){try{return{WakeNet9:["wn9_alexa","wn9_astrolabe_tts","wn9_bluechip_tts2","wn9_computer_tts","wn9_haixiaowu_tts","wn9_heyily_tts2","wn9_heyprinter_tts","wn9_heywanda_tts","wn9_heywillow_tts","wn9_hiesp","wn9_hifairy_tts2","wn9_hijason_tts2","wn9_hijolly_tts2","wn9_hijoy_tts","wn9_hilexin","wn9_hilili_tts","wn9_himfive","wn9_himiaomiao_tts","wn9_hitelly_tts","wn9_hiwalle_tts2","wn9_hixiaoxing_tts","wn9_jarvis_tts","wn9_linaiban_tts2","wn9_miaomiaotongxue_tts","wn9_mycroft_tts","wn9_nihaobaiying_tts2","wn9_nihaodongdong_tts2","wn9_nihaomiaoban_tts2","wn9_nihaoxiaoan_tts2","wn9_nihaoxiaoxin_tts","wn9_nihaoxiaoyi_tts2","wn9_nihaoxiaozhi","wn9_nihaoxiaozhi_tts","wn9_sophia_tts","wn9_xiaoaitongxue","wn9_xiaobinxiaobin_tts","wn9_xiaojianxiaojian_tts2","wn9_xiaokangtongxue_tts2","wn9_xiaolongxiaolong_tts","wn9_xiaoluxiaolu_tts2","wn9_xiaomeitongxue_tts","wn9_xiaomingtongxue_tts2","wn9_xiaosurou_tts2","wn9_xiaotexiaote_tts2","wn9_xiaoyaxiaoya_tts2","wn9_xiaoyutongxue_tts2"],WakeNet9s:["wn9s_alexa","wn9s_hiesp","wn9s_hijason","wn9s_hilexin","wn9s_nihaoxiaozhi"]}}catch(e){return console.error("Lấy danh sách mô hình thất bại:",e),{WakeNet9:[],WakeNet9s:[]}}}static isValidModel(e,r){return r==="esp32c3"||r==="esp32c6"?e.startsWith("wn9s_"):e.startsWith("wn9_")}clear(){this.models.clear()}getStats(){let e=0,r=0;for(const n of this.models.values()){e+=n.size;for(const a of n.values())r+=a.byteLength}return{modelCount:this.models.size,fileCount:e,totalSize:r,models:Array.from(this.models.keys())}}validatePackingCompatibility(){const e="test_model",r=this.packString(e,32),n=305419896,a=this.packUint32(n);return{stringPacking:{input:e,output:Array.from(r).map(s=>`0x${s.toString(16).padStart(2,"0")}`),isASCII:r.every((s,i)=>i>=e.length||s===e.charCodeAt(i))},intPacking:{input:`0x${n.toString(16)}`,output:Array.from(a).map(s=>`0x${s.toString(16).padStart(2,"0")}`),isLittleEndian:a[0]===120&&a[3]===18}}}}class Sd{constructor(){this.files=[],this.textEncoder=new TextEncoder}addFile(e,r,n={}){e.length>32&&console.warn(`Tên file "${e}" vượt quá 32 byte, sẽ bị cắt bớt`),this.files.push({filename:e,data:r,size:r.byteLength,width:n.width||0,height:n.height||0})}async getImageDimensions(e){return new Promise(r=>{try{const n=new Blob([e]),a=URL.createObjectURL(n),s=new Image;s.onload=()=>{URL.revokeObjectURL(a),r({width:s.width,height:s.height})},s.onerror=()=>{URL.revokeObjectURL(a),r({width:0,height:0})},s.src=a}catch{r({width:0,height:0})}})}parseSpecialImageFormat(e,r){const n=e.toLowerCase().split(".").pop();if([".sjpg",".spng",".sqoi"].includes("."+n))try{const a=new DataView(r),s=a.getUint16(14,!0),i=a.getUint16(16,!0);return{width:s,height:i}}catch(a){console.warn(`Phân tích định dạng ảnh đặc biệt thất bại: ${e}`,a)}return{width:0,height:0}}packUint32(e){const r=new Uint8Array(4);return r[0]=e&255,r[1]=e>>8&255,r[2]=e>>16&255,r[3]=e>>24&255,r}packUint16(e){const r=new Uint8Array(2);return r[0]=e&255,r[1]=e>>8&255,r}packString(e,r){const n=new Uint8Array(r),a=this.textEncoder.encode(e),s=Math.min(a.length,r);return n.set(a.slice(0,s),0),n}computeChecksum(e){let r=0;for(let n=0;n<e.length;n++)r+=e[n];return r&65535}sortFiles(e){return e.slice().sort((r,n)=>{const a=r.filename.split(".").pop()||"",s=n.filename.split(".").pop()||"";if(a!==s)return a.localeCompare(s);const i=r.filename.replace(/\.[^/.]+$/,""),o=n.filename.replace(/\.[^/.]+$/,"");return i.localeCompare(o)})}async generate(e=null){if(this.files.length===0)throw new Error("Không có file để đóng gói");e&&e(0,"开始打包文件...");const r=this.sortFiles(this.files),n=r.length,a=[];let s=0;for(let w=0;w<r.length;w++){const v=r[w];let S=v.width,F=v.height;if(e&&e(10+w/n*30,`Xử lý file: ${v.filename}`),S===0&&F===0){const B=this.parseSpecialImageFormat(v.filename,v.data);if(B.width>0||B.height>0)S=B.width,F=B.height;else{const L=v.filename.toLowerCase().split(".").pop();if(["png","jpg","jpeg","gif","bmp","webp"].includes(L)){const O=await this.getImageDimensions(v.data);S=O.width,F=O.height}}}a.push({filename:v.filename,data:v.data,size:v.size,offset:s,width:S,height:F}),s+=2+v.size}e&&e(40,"Xây dựng bảng ánh xạ file...");const i=n*44,o=new Uint8Array(i);let l=0;for(const w of a)o.set(this.packString(w.filename,32),l),l+=32,o.set(this.packUint32(w.size),l),l+=4,o.set(this.packUint32(w.offset),l),l+=4,o.set(this.packUint16(w.width),l),l+=2,o.set(this.packUint16(w.height),l),l+=2;e&&e(60,"Hợp nhất dữ liệu file...");const c=new Uint8Array(s);let u=0;for(let w=0;w<a.length;w++){const v=a[w];e&&e(60+w/n*20,`Hợp nhất file: ${v.filename}`),c[u]=90,c[u+1]=90,u+=2,c.set(new Uint8Array(v.data),u),u+=v.size}e&&e(80,"Tính checksum...");const f=new Uint8Array(i+s);f.set(o,0),f.set(c,i);const h=this.computeChecksum(f),p=f.length;e&&e(90,"Xây dựng file cuối cùng...");const b=12+p,m=new Uint8Array(b);let g=0;return m.set(this.packUint32(n),g),g+=4,m.set(this.packUint32(h),g),g+=4,m.set(this.packUint32(p),g),g+=4,m.set(f,g),e&&e(100,"Đóng gói hoàn tất"),m.buffer}getStats(){var n;let e=0;const r=new Map;for(const a of this.files){e+=a.size;const s=((n=a.filename.split(".").pop())==null?void 0:n.toLowerCase())||"unknown";r.set(s,(r.get(s)||0)+1)}return{fileCount:this.files.length,totalSize:e,fileTypes:Object.fromEntries(r),averageFileSize:this.files.length>0?Math.round(e/this.files.length):0}}clear(){this.files=[]}}function Td(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ke={},ua={},De={};Object.defineProperty(De,"__esModule",{value:!0});De.loop=De.conditional=De.parse=void 0;var Fd=function t(e,r){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:n;if(Array.isArray(r))r.forEach(function(i){return t(e,i,n,a)});else if(typeof r=="function")r(e,n,a,t);else{var s=Object.keys(r)[0];Array.isArray(r[s])?(a[s]={},t(e,r[s],n,a[s])):a[s]=r[s](e,n,a,t)}return n};De.parse=Fd;var Cd=function(e,r){return function(n,a,s,i){r(n,a,s)&&i(n,e,a,s)}};De.conditional=Cd;var _d=function(e,r){return function(n,a,s,i){for(var o=[],l=n.pos;r(n,a,s);){var c={};if(i(n,e,a,c),n.pos===l)break;l=n.pos,o.push(c)}return o}};De.loop=_d;var ie={};Object.defineProperty(ie,"__esModule",{value:!0});ie.readBits=ie.readArray=ie.readUnsigned=ie.readString=ie.peekBytes=ie.readBytes=ie.peekByte=ie.readByte=ie.buildStream=void 0;var Ed=function(e){return{data:e,pos:0}};ie.buildStream=Ed;var ca=function(){return function(e){return e.data[e.pos++]}};ie.readByte=ca;var Ud=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+e]}};ie.peekByte=Ud;var Dt=function(e){return function(r){return r.data.subarray(r.pos,r.pos+=e)}};ie.readBytes=Dt;var Ld=function(e){return function(r){return r.data.subarray(r.pos,r.pos+e)}};ie.peekBytes=Ld;var Od=function(e){return function(r){return Array.from(Dt(e)(r)).map(function(n){return String.fromCharCode(n)}).join("")}};ie.readString=Od;var Bd=function(e){return function(r){var n=Dt(2)(r);return e?(n[1]<<8)+n[0]:(n[0]<<8)+n[1]}};ie.readUnsigned=Bd;var Rd=function(e,r){return function(n,a,s){for(var i=typeof r=="function"?r(n,a,s):r,o=Dt(e),l=new Array(i),c=0;c<i;c++)l[c]=o(n);return l}};ie.readArray=Rd;var Ad=function(e,r,n){for(var a=0,s=0;s<n;s++)a+=e[r+s]&&Math.pow(2,n-s-1);return a},Id=function(e){return function(r){for(var n=ca()(r),a=new Array(8),s=0;s<8;s++)a[7-s]=!!(n&1<<s);return Object.keys(e).reduce(function(i,o){var l=e[o];return l.length?i[o]=Ad(a,l.index,l.length):i[o]=a[l.index],i},{})}};ie.readBits=Id;(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var e=De,r=ie,n={blocks:function(h){for(var p=0,y=[],b=h.data.length,m=0,g=(0,r.readByte)()(h);g!==p&&g;g=(0,r.readByte)()(h)){if(h.pos+g>=b){var w=b-h.pos;y.push((0,r.readBytes)(w)(h)),m+=w;break}y.push((0,r.readBytes)(g)(h)),m+=g}for(var v=new Uint8Array(m),S=0,F=0;F<y.length;F++)v.set(y[F],S),S+=y[F].length;return v}},a=(0,e.conditional)({gce:[{codes:(0,r.readBytes)(2)},{byteSize:(0,r.readByte)()},{extras:(0,r.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,r.readUnsigned)(!0)},{transparentColorIndex:(0,r.readByte)()},{terminator:(0,r.readByte)()}]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===249}),s=(0,e.conditional)({image:[{code:(0,r.readByte)()},{descriptor:[{left:(0,r.readUnsigned)(!0)},{top:(0,r.readUnsigned)(!0)},{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{lct:(0,r.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,e.conditional)({lct:(0,r.readArray)(3,function(f,h,p){return Math.pow(2,p.descriptor.lct.size+1)})},function(f,h,p){return p.descriptor.lct.exists}),{data:[{minCodeSize:(0,r.readByte)()},n]}]},function(f){return(0,r.peekByte)()(f)===44}),i=(0,e.conditional)({text:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{preData:function(h,p,y){return(0,r.readBytes)(y.text.blockSize)(h)}},n]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===1}),o=(0,e.conditional)({application:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{id:function(h,p,y){return(0,r.readString)(y.blockSize)(h)}},n]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===255}),l=(0,e.conditional)({comment:[{codes:(0,r.readBytes)(2)},n]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===254}),c=[{header:[{signature:(0,r.readString)(3)},{version:(0,r.readString)(3)}]},{lsd:[{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{gct:(0,r.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,r.readByte)()},{pixelAspectRatio:(0,r.readByte)()}]},(0,e.conditional)({gct:(0,r.readArray)(3,function(f,h){return Math.pow(2,h.lsd.gct.size+1)})},function(f,h){return h.lsd.gct.exists}),{frames:(0,e.loop)([a,o,l,s,i],function(f){var h=(0,r.peekByte)()(f);return h===33||h===44})}],u=c;t.default=u})(ua);var Mt={};Object.defineProperty(Mt,"__esModule",{value:!0});Mt.deinterlace=void 0;var Dd=function(e,r){for(var n=new Array(e.length),a=e.length/r,s=function(h,p){var y=e.slice(p*r,(p+1)*r);n.splice.apply(n,[h*r,r].concat(y))},i=[0,4,2,1],o=[8,8,4,2],l=0,c=0;c<4;c++)for(var u=i[c];u<a;u+=o[c])s(u,l),l++;return n};Mt.deinterlace=Dd;var Pt={};Object.defineProperty(Pt,"__esModule",{value:!0});Pt.lzw=void 0;var Md=function(e,r,n){var a=4096,s=-1,i=n,o,l,c,u,f,h,p,B,y,b,F,m,L,O,x,T,g=new Array(n),w=new Array(a),v=new Array(a),S=new Array(a+1);for(m=e,l=1<<m,f=l+1,o=l+2,p=s,u=m+1,c=(1<<u)-1,y=0;y<l;y++)w[y]=0,v[y]=y;var F,B,L,O,T,x;for(F=B=L=O=T=x=0,b=0;b<i;){if(O===0){if(B<u){F+=r[x]<<B,B+=8,x++;continue}if(y=F&c,F>>=u,B-=u,y>o||y==f)break;if(y==l){u=m+1,c=(1<<u)-1,o=l+2,p=s;continue}if(p==s){S[O++]=v[y],p=y,L=y;continue}for(h=y,y==o&&(S[O++]=L,y=p);y>l;)S[O++]=v[y],y=w[y];L=v[y]&255,S[O++]=L,o<a&&(w[o]=p,v[o]=L,o++,!(o&c)&&o<a&&(u++,c+=o)),p=h}O--,g[T++]=S[O],b++}for(b=T;b<i;b++)g[b]=0;return g};Pt.lzw=Md;Object.defineProperty(Ke,"__esModule",{value:!0});var ha=Ke.decompressFrames=Ke.decompressFrame=da=Ke.parseGIF=void 0,Pd=$d(ua),Nd=De,Gd=ie,zd=Mt,Vd=Pt;function $d(t){return t&&t.__esModule?t:{default:t}}var Hd=function(e){var r=new Uint8Array(e);return(0,Nd.parse)((0,Gd.buildStream)(r),Pd.default)},da=Ke.parseGIF=Hd,jd=function(e){for(var r=e.pixels.length,n=new Uint8ClampedArray(r*4),a=0;a<r;a++){var s=a*4,i=e.pixels[a],o=e.colorTable[i]||[0,0,0];n[s]=o[0],n[s+1]=o[1],n[s+2]=o[2],n[s+3]=i!==e.transparentIndex?255:0}return n},fa=function(e,r,n){if(!e.image){console.warn("gif frame does not have associated image.");return}var a=e.image,s=a.descriptor.width*a.descriptor.height,i=(0,Vd.lzw)(a.data.minCodeSize,a.data.blocks,s);a.descriptor.lct.interlaced&&(i=(0,zd.deinterlace)(i,a.descriptor.width));var o={pixels:i,dims:{top:e.image.descriptor.top,left:e.image.descriptor.left,width:e.image.descriptor.width,height:e.image.descriptor.height}};return a.descriptor.lct&&a.descriptor.lct.exists?o.colorTable=a.lct:o.colorTable=r,e.gce&&(o.delay=(e.gce.delay||10)*10,o.disposalType=e.gce.extras.disposal,e.gce.extras.transparentColorGiven&&(o.transparentIndex=e.gce.transparentColorIndex)),n&&(o.patch=jd(o)),o};Ke.decompressFrame=fa;var Wd=function(e,r){return e.frames.filter(function(n){return n.image}).map(function(n){return fa(n,e.gct,r)})};ha=Ke.decompressFrames=Wd;function Ft(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var pa={exports:{}};(function(t,e){(function(r){t.exports=r()})(function(){return function r(n,a,s){function i(c,u){if(!a[c]){if(!n[c]){var f=typeof Ft=="function"&&Ft;if(!u&&f)return f(c,!0);if(o)return o(c,!0);var h=new Error("Cannot find module '"+c+"'");throw h.code="MODULE_NOT_FOUND",h}var p=a[c]={exports:{}};n[c][0].call(p.exports,function(y){var b=n[c][1][y];return i(b||y)},p,p.exports,r,n,a,s)}return a[c].exports}for(var o=typeof Ft=="function"&&Ft,l=0;l<s.length;l++)i(s[l]);return i}({1:[function(r,n,a){function s(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}n.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0,s.defaultMaxListeners=10,s.prototype.setMaxListeners=function(u){if(!o(u)||u<0||isNaN(u))throw TypeError("n must be a positive number");return this._maxListeners=u,this},s.prototype.emit=function(u){var f,h,p,y,b,m;if(this._events||(this._events={}),u==="error"&&(!this._events.error||l(this._events.error)&&!this._events.error.length)){if(f=arguments[1],f instanceof Error)throw f;var g=new Error('Uncaught, unspecified "error" event. ('+f+")");throw g.context=f,g}if(h=this._events[u],c(h))return!1;if(i(h))switch(arguments.length){case 1:h.call(this);break;case 2:h.call(this,arguments[1]);break;case 3:h.call(this,arguments[1],arguments[2]);break;default:y=Array.prototype.slice.call(arguments,1),h.apply(this,y)}else if(l(h))for(y=Array.prototype.slice.call(arguments,1),m=h.slice(),p=m.length,b=0;b<p;b++)m[b].apply(this,y);return!0},s.prototype.addListener=function(u,f){var h;if(!i(f))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",u,i(f.listener)?f.listener:f),this._events[u]?l(this._events[u])?this._events[u].push(f):this._events[u]=[this._events[u],f]:this._events[u]=f,l(this._events[u])&&!this._events[u].warned&&(c(this._maxListeners)?h=s.defaultMaxListeners:h=this._maxListeners,h&&h>0&&this._events[u].length>h&&(this._events[u].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[u].length),typeof console.trace=="function"&&console.trace())),this},s.prototype.on=s.prototype.addListener,s.prototype.once=function(u,f){if(!i(f))throw TypeError("listener must be a function");var h=!1;function p(){this.removeListener(u,p),h||(h=!0,f.apply(this,arguments))}return p.listener=f,this.on(u,p),this},s.prototype.removeListener=function(u,f){var h,p,y,b;if(!i(f))throw TypeError("listener must be a function");if(!this._events||!this._events[u])return this;if(h=this._events[u],y=h.length,p=-1,h===f||i(h.listener)&&h.listener===f)delete this._events[u],this._events.removeListener&&this.emit("removeListener",u,f);else if(l(h)){for(b=y;b-- >0;)if(h[b]===f||h[b].listener&&h[b].listener===f){p=b;break}if(p<0)return this;h.length===1?(h.length=0,delete this._events[u]):h.splice(p,1),this._events.removeListener&&this.emit("removeListener",u,f)}return this},s.prototype.removeAllListeners=function(u){var f,h;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[u]&&delete this._events[u],this;if(arguments.length===0){for(f in this._events)f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events={},this}if(h=this._events[u],i(h))this.removeListener(u,h);else if(h)for(;h.length;)this.removeListener(u,h[h.length-1]);return delete this._events[u],this},s.prototype.listeners=function(u){var f;return!this._events||!this._events[u]?f=[]:i(this._events[u])?f=[this._events[u]]:f=this._events[u].slice(),f},s.prototype.listenerCount=function(u){if(this._events){var f=this._events[u];if(i(f))return 1;if(f)return f.length}return 0},s.listenerCount=function(u,f){return u.listenerCount(f)};function i(u){return typeof u=="function"}function o(u){return typeof u=="number"}function l(u){return typeof u=="object"&&u!==null}function c(u){return u===void 0}},{}],2:[function(r,n,a){var s,i,o,l,c;c=navigator.userAgent.toLowerCase(),l=navigator.platform.toLowerCase(),s=c.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],o=s[1]==="ie"&&document.documentMode,i={name:s[1]==="version"?s[3]:s[1],version:o||parseFloat(s[1]==="opera"&&s[4]?s[4]:s[2]),platform:{name:c.match(/ip(?:ad|od|hone)/)?"ios":(c.match(/(?:webos|android)/)||l.match(/mac|win|linux/)||["other"])[0]}},i[i.name]=!0,i[i.name+parseInt(i.version,10)]=!0,i.platform[i.platform.name]=!0,n.exports=i},{}],3:[function(r,n,a){var s,i,o,l=function(h,p){for(var y in p)c.call(p,y)&&(h[y]=p[y]);function b(){this.constructor=h}return b.prototype=p.prototype,h.prototype=new b,h.__super__=p.prototype,h},c={}.hasOwnProperty,u=[].indexOf||function(h){for(var p=0,y=this.length;p<y;p++)if(p in this&&this[p]===h)return p;return-1},f=[].slice;s=r("events").EventEmitter,o=r("./browser.coffee"),i=function(h){var p,y;l(b,h),p={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},y={delay:500,copy:!1};function b(m){var g,w,v;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(m);for(w in p)v=p[w],(g=this.options)[w]==null&&(g[w]=v)}return b.prototype.setOption=function(m,g){if(this.options[m]=g,this._canvas!=null&&(m==="width"||m==="height"))return this._canvas[m]=g},b.prototype.setOptions=function(m){var g,w,v;w=[];for(g in m)c.call(m,g)&&(v=m[g],w.push(this.setOption(g,v)));return w},b.prototype.addFrame=function(m,g){var w,v;g==null&&(g={}),w={},w.transparent=this.options.transparent;for(v in y)w[v]=g[v]||y[v];if(this.options.width==null&&this.setOption("width",m.width),this.options.height==null&&this.setOption("height",m.height),typeof ImageData<"u"&&ImageData!==null&&m instanceof ImageData)w.data=m.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&m instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&m instanceof WebGLRenderingContext)g.copy?w.data=this.getContextData(m):w.context=m;else if(m.childNodes!=null)g.copy?w.data=this.getImageData(m):w.image=m;else throw new Error("Invalid image");return this.frames.push(w)},b.prototype.render=function(){var m,g,w;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var v,S,F;for(F=[],v=0,S=this.frames.length;0<=S?v<S:v>S;0<=S?++v:--v)F.push(null);return F}).call(this),g=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(m=0,w=g;0<=w?m<w:m>w;0<=w?++m:--m)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},b.prototype.abort=function(){for(var m;m=this.activeWorkers.shift(),m!=null;)this.log("killing active worker"),m.terminate();return this.running=!1,this.emit("abort")},b.prototype.spawnWorkers=function(){var m,g,w;return m=Math.min(this.options.workers,this.frames.length),(function(){w=[];for(var v=g=this.freeWorkers.length;g<=m?v<m:v>m;g<=m?v++:v--)w.push(v);return w}).apply(this).forEach(function(v){return function(S){var F;return v.log("spawning worker "+S),F=new Worker(v.options.workerScript),F.onmessage=function(B){return v.activeWorkers.splice(v.activeWorkers.indexOf(F),1),v.freeWorkers.push(F),v.frameFinished(B.data)},v.freeWorkers.push(F)}}(this)),m},b.prototype.frameFinished=function(m){var g,w;if(this.log("frame "+m.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[m.index]=m,this.options.globalPalette===!0&&(this.options.globalPalette=m.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(g=1,w=this.freeWorkers.length;1<=w?g<w:g>w;1<=w?++g:--g)this.renderNextFrame();return u.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},b.prototype.finishRendering=function(){var m,g,w,v,S,F,B,L,O,T,x,C,V,j,z,q;for(L=0,j=this.imageParts,S=0,O=j.length;S<O;S++)g=j[S],L+=(g.data.length-1)*g.pageSize+g.cursor;for(L+=g.pageSize-g.cursor,this.log("rendering finished - filesize "+Math.round(L/1e3)+"kb"),m=new Uint8Array(L),C=0,z=this.imageParts,F=0,T=z.length;F<T;F++)for(g=z[F],q=g.data,w=B=0,x=q.length;B<x;w=++B)V=q[w],m.set(V,C),w===g.data.length-1?C+=g.cursor:C+=g.pageSize;return v=new Blob([m],{type:"image/gif"}),this.emit("finished",v,m)},b.prototype.renderNextFrame=function(){var m,g,w;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return m=this.frames[this.nextFrame++],w=this.freeWorkers.shift(),g=this.getTask(m),this.log("starting frame "+(g.index+1)+" of "+this.frames.length),this.activeWorkers.push(w),w.postMessage(g)},b.prototype.getContextData=function(m){return m.getImageData(0,0,this.options.width,this.options.height).data},b.prototype.getImageData=function(m){var g;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),g=this._canvas.getContext("2d"),g.setFill=this.options.background,g.fillRect(0,0,this.options.width,this.options.height),g.drawImage(m,0,0),this.getContextData(g)},b.prototype.getTask=function(m){var g,w;if(g=this.frames.indexOf(m),w={index:g,last:g===this.frames.length-1,delay:m.delay,transparent:m.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:o.name==="chrome"},m.data!=null)w.data=m.data;else if(m.context!=null)w.data=this.getContextData(m.context);else if(m.image!=null)w.data=this.getImageData(m.image);else throw new Error("Invalid frame");return w},b.prototype.log=function(){var m;if(m=1<=arguments.length?f.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,m)},b}(s),n.exports=i},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(pa);var Xd=pa.exports;const qd=Td(Xd);class Yd{constructor(e={}){this.options={quality:e.quality||10,repeat:e.repeat!==void 0?e.repeat:-1,debug:e.debug||!1,scalingMode:e.scalingMode||"auto",workers:e.workers||2,workerScript:e.workerScript||"/tools/assets-generator//workers/gif.worker.js",...e},this.canvas=null,this.ctx=null,this.frames=[],this.delays=[],this.originalWidth=0,this.originalHeight=0,this.targetWidth=0,this.targetHeight=0,this.gifRepeat=0}initCanvas(e,r){this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=r,this.ctx=this.canvas.getContext("2d"),this.options.debug&&console.log(`Canvas initialized: ${e}x${r}`)}async parseGifFrames(e){try{return await this.parseGifWithGifuct(e)}catch(r){throw new Error(`GIF 解析失败: ${r.message}`)}}async parseGifWithGifuct(e){const r=await this.fileToArrayBuffer(e),n=da(r),a=ha(n,!0);if(this.originalWidth=n.lsd.width,this.originalHeight=n.lsd.height,this.frames=[],this.delays=[],this.options.repeat===-1){let l=0;if(n.applicationExtensions){const c=n.applicationExtensions.find(u=>u.identifier==="NETSCAPE"&&u.authenticationCode==="2.0");c&&c.data&&c.data.length>=3&&(l=c.data[1]+(c.data[2]<<8))}this.gifRepeat=l,this.options.debug&&console.log(`Cài đặt vòng lặp GIF gốc: ${l===0?"lặp vô hạn":l+" lần"}`)}else this.gifRepeat=this.options.repeat;const s=document.createElement("canvas");s.width=this.originalWidth,s.height=this.originalHeight;const i=s.getContext("2d",{willReadFrequently:!0});let o=null;for(let l=0;l<a.length;l++){const c=a[l];l===0||c.disposalType===2?i.clearRect(0,0,s.width,s.height):c.disposalType===3&&o&&i.putImageData(o,0,0),c.disposalType===3&&(o=i.getImageData(0,0,this.originalWidth,this.originalHeight));const u=document.createElement("canvas");u.width=c.dims.width,u.height=c.dims.height;const f=u.getContext("2d",{willReadFrequently:!0});f.clearRect(0,0,c.dims.width,c.dims.height);const h=new ImageData(c.patch,c.dims.width,c.dims.height);f.putImageData(h,0,0),i.drawImage(u,c.dims.left||0,c.dims.top||0);const p=i.getImageData(0,0,this.originalWidth,this.originalHeight);this.frames.push(p),this.delays.push(c.delay||100)}return this.options.debug&&console.log(`GIF parsed (gifuct-js): ${this.originalWidth}x${this.originalHeight}, frames: ${this.frames.length}`),this.frames}scaleFrame(e,r,n){const a=document.createElement("canvas"),s=a.getContext("2d");a.width=e.width,a.height=e.height,s.clearRect(0,0,e.width,e.height),s.putImageData(e,0,0);const i=document.createElement("canvas"),o=i.getContext("2d",{willReadFrequently:!0});i.width=r,i.height=n,o.clearRect(0,0,r,n);const l=Math.min(r/e.width,n/e.height),c=this.getOptimalScalingMode(l);return l<.5&&c==="pixelated"?this.scaleWithEdgePreservation(s,o,e.width,e.height,r,n):(this.applyScalingMode(o,c),o.drawImage(a,0,0,e.width,e.height,0,0,r,n)),o.getImageData(0,0,r,n)}getOptimalScalingMode(e){return this.options.scalingMode!=="auto"?this.options.scalingMode:e>=.5?"smooth":e>=.25?"sharp":"pixelated"}applyScalingMode(e,r){switch(r){case"smooth":e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";break;case"sharp":e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";break;case"pixelated":e.imageSmoothingEnabled=!1;break;default:e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high"}}scaleWithEdgePreservation(e,r,n,a,s,i){if(Math.min(s/n,i/a)<.5){const l=document.createElement("canvas"),c=l.getContext("2d"),u=Math.max(n*.5,s),f=Math.max(a*.5,i);l.width=u,l.height=f,c.imageSmoothingEnabled=!1,c.drawImage(e.canvas,0,0,n,a,0,0,u,f),u!==s||f!==i?(r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.drawImage(l,0,0,u,f,0,0,s,i)):r.drawImage(l,0,0)}else r.imageSmoothingEnabled=!1,r.drawImage(e.canvas,0,0,n,a,0,0,s,i)}calculateTargetSize(e,r,n,a){const s=Math.min(n/e,a/r);return{width:Math.round(e*s),height:Math.round(r*s)}}async scaleGif(e,r){try{const{maxWidth:n,maxHeight:a,keepAspectRatio:s=!0}=r;if(!n||!a)throw new Error("Phải chỉ định chiều rộng và chiều cao tối đa");await this.parseGifFrames(e);let i;if(s?i=this.calculateTargetSize(this.originalWidth,this.originalHeight,n,a):i={width:n,height:a},this.targetWidth=i.width,this.targetHeight=i.height,this.targetWidth===this.originalWidth&&this.targetHeight===this.originalHeight)return this.options.debug&&console.log("Không cần thay đổi kích thước, trả về file gốc"),e;const o=this.frames.map(c=>this.scaleFrame(c,this.targetWidth,this.targetHeight)),l=await this.generateGif(o,this.delays);return this.options.debug&&console.log(`Thu nhỏ GIF hoàn thành: ${this.originalWidth}x${this.originalHeight} -> ${this.targetWidth}x${this.targetHeight}`),l}catch(n){throw new Error(`Thu nhỏ GIF thất bại: ${n.message}`)}}async generateGif(e,r){try{return await this.generateGifWithGifJs(e,r)}catch(n){throw new Error(`Tạo GIF thất bại: ${n.message}`)}}async generateGifWithGifJs(e,r){return new Promise((n,a)=>{const s=new qd({workers:this.options.workers,quality:this.options.quality,width:this.targetWidth,height:this.targetHeight,transparent:"rgba(255, 0, 255, 0)",repeat:this.gifRepeat!==void 0?this.gifRepeat:0,workerScript:this.options.workerScript});e.forEach((i,o)=>{const l=document.createElement("canvas");l.width=this.targetWidth,l.height=this.targetHeight;const c=l.getContext("2d",{willReadFrequently:!0});c.clearRect(0,0,this.targetWidth,this.targetHeight),c.putImageData(i,0,0),s.addFrame(l,{delay:r[o]||100})}),s.on("finished",i=>{this.options.debug&&console.log(`GIF generated: ${e.length} frames, ${i.size} bytes, repeat: ${this.gifRepeat===0?"lặp vô hạn":this.gifRepeat+" lần"}`),n(i)}),s.on("abort",()=>{a(new Error("Tạo GIF bị huỷ"))}),s.render()})}async getGifInfo(e){try{return await this.parseGifWithGifuct(e),{width:this.originalWidth,height:this.originalHeight,frameCount:this.frames.length,totalDuration:this.delays.reduce((r,n)=>r+n,0),repeat:this.gifRepeat,fileSize:e.size}}catch(r){throw new Error(`Lấy thông tin GIF thất bại: ${r.message}`)}}async needsScaling(e,r,n){const a=await this.getGifInfo(e);return a.width>r||a.height>n}async fileToArrayBuffer(e){return new Promise((r,n)=>{const a=new FileReader;a.onload=()=>r(a.result),a.onerror=()=>n(new Error("文件读取失败")),a.readAsArrayBuffer(e)})}async scaleBatchGifs(e,r){const n=[];for(let a=0;a<e.length;a++)try{this.options.debug&&console.log(`Đang xử lý file thứ ${a+1}/${e.length}`);const s=await this.scaleGif(e[a],r);n.push({index:a,success:!0,result:s,originalFile:e[a]})}catch(s){n.push({index:a,success:!1,error:s.message,originalFile:e[a]})}return n}getSuggestedScaling(e,r,n=[]){const a=[],s=[{name:"emoji_32",width:32,height:32},{name:"emoji_64",width:64,height:64},{name:"small",width:48,height:48},{name:"medium",width:96,height:96}];return(n.length>0?n:s).forEach(o=>{const l=this.calculateTargetSize(e,r,o.width,o.height);a.push({name:o.name,target:o,actual:l,needsScaling:l.width!==e||l.height!==r,scaleRatio:l.width/e})}),{original:{width:e,height:r},suggestions:a}}dispose(){this.canvas&&(this.canvas=null,this.ctx=null),this.frames=[],this.delays=[],this.tempObjectUrls&&(this.tempObjectUrls.forEach(e=>URL.revokeObjectURL(e)),this.tempObjectUrls=[])}}class ga{constructor(){this.config=null,this.resources=new Map,this.tempFiles=[],this.fontConverterBrowser=wd,this.convertedFonts=new Map,this.wakenetPacker=new kd,this.spiffsGenerator=new Sd,this.gifScaler=new Yd({quality:10,debug:!0,scalingMode:"auto"}),this.configStorage=de,this.autoSaveEnabled=!0}setConfig(e,r={}){if(((r==null?void 0:r.strict)??!0)&&!this.validateConfig(e))throw new Error("Xác thực đối tượng cấu hình thất bại");return this.config={...e},this}validateConfig(e){var a,s,i;if(!e)return!1;if(!((a=e.chip)!=null&&a.model))return console.error("Thiếu cấu hình model chip"),!1;const r=e.chip.display;if(!(r!=null&&r.width)||!(r!=null&&r.height))return console.error("Thiếu cấu hình độ phân giải hiển thị"),!1;const n=(s=e.theme)==null?void 0:s.font;return(n==null?void 0:n.type)==="preset"&&!n.preset?(console.error("Cấu hình font preset chưa đầy đủ"),!1):(n==null?void 0:n.type)==="custom"&&!((i=n.custom)!=null&&i.file)?(console.error("Chưa cung cấp file font tùy chỉnh"),!1):!0}addResource(e,r,n,a="other"){return this.resources.set(e,{file:r,filename:n,size:r.size,type:r.type,lastModified:r.lastModified||Date.now(),resourceType:a}),this.autoSaveEnabled&&r instanceof File&&this.saveFileToStorage(e,r,a).catch(s=>{console.warn(`Tự động lưu file ${n} thất bại:`,s)}),this}async saveFileToStorage(e,r,n){try{await this.configStorage.saveFile(e,r,n),console.log(`File ${r.name} đã được tự động lưu vào storage`)}catch(a){throw console.error(`Lưu file vào storage thất bại: ${r.name}`,a),a}}async restoreResourceFromStorage(e){try{const r=await this.configStorage.loadFile(e);return r?(this.resources.set(e,{file:r,filename:r.name,size:r.size,type:r.type,lastModified:r.lastModified,resourceType:r.storedType,fromStorage:!0}),console.log(`Tài nguyên ${e} đã phục hồi thành công từ storage: ${r.name}`),!0):!1}catch(r){return console.error(`Khôi phục tài nguyên từ storage thất bại: ${e}`,r),!1}}async restoreAllResourcesFromStorage(e){var n,a,s,i,o,l,c,u,f,h,p,y;if(!e)return;const r=[];if(((a=(n=e.theme)==null?void 0:n.font)==null?void 0:a.type)==="custom"&&((s=e.theme.font.custom)==null?void 0:s.file)===null){const b="custom_font";if(await this.restoreResourceFromStorage(b)){const m=this.resources.get(b);m&&(e.theme.font.custom.file=m.file,r.push(`Font tùy chỉnh: ${m.filename}`))}}if(((o=(i=e.theme)==null?void 0:i.emoji)==null?void 0:o.type)==="custom"&&((l=e.theme.emoji.custom)!=null&&l.images)){for(const[b,m]of Object.entries(e.theme.emoji.custom.images))if(m===null){const g=`emoji_${b}`;if(await this.restoreResourceFromStorage(g)){const w=this.resources.get(g);w&&(e.theme.emoji.custom.images[b]=w.file,r.push(`Biểu cảm ${b}: ${w.filename}`))}}}if(((f=(u=(c=e.theme)==null?void 0:c.skin)==null?void 0:u.light)==null?void 0:f.backgroundType)==="image"&&e.theme.skin.light.backgroundImage===null){const b="background_light";if(await this.restoreResourceFromStorage(b)){const m=this.resources.get(b);m&&(e.theme.skin.light.backgroundImage=m.file,r.push(`Nền sáng: ${m.filename}`))}}if(((y=(p=(h=e.theme)==null?void 0:h.skin)==null?void 0:p.dark)==null?void 0:y.backgroundType)==="image"&&e.theme.skin.dark.backgroundImage===null){const b="background_dark";if(await this.restoreResourceFromStorage(b)){const m=this.resources.get(b);m&&(e.theme.skin.dark.backgroundImage=m.file,r.push(`Nền tối: ${m.filename}`))}}try{const b=this.getFontInfo();if(b&&b.type==="custom"){const m=`converted_font_${b.filename}`,g=await this.configStorage.loadTempData(m);g&&(this.convertedFonts.set(b.filename,g.data),console.log(`Dữ liệu font đã chuyển đổi đã phục hồi: ${b.filename}`))}}catch(b){console.warn("Lỗi khi khôi phục dữ liệu font đã chuyển đổi:",b)}r.length>0&&console.log("Các file đã được khôi phục từ storage:",r)}getWakewordModelInfo(){if(!this.config||!this.config.chip||!this.config.theme)return null;const e=this.config.chip.model,r=this.config.theme.wakeword;return r?{name:r,type:e==="esp32c3"||e==="esp32c6"?"WakeNet9s":"WakeNet9",filename:"srmodels.bin"}:null}getFontInfo(){if(!this.config||!this.config.theme||!this.config.theme.font)return null;const e=this.config.theme.font;if(e.type==="preset")return{type:"preset",filename:`${e.preset}.bin`,source:e.preset};if(e.type==="custom"&&e.custom.file){const r=e.custom;return{type:"custom",filename:`font_custom_${r.size}_${r.bpp}.bin`,source:e.custom.file,config:{size:r.size,bpp:r.bpp,charset:r.charset}}}return null}getEmojiCollectionInfo(){if(!this.config||!this.config.theme||!this.config.theme.emoji)return[];const e=this.config.theme.emoji,r=[];if(e.type==="preset"){const n=["neutral","happy","laughing","funny","sad","angry","crying","loving","embarrassed","surprised","shocked","thinking","winking","cool","relaxed","delicious","kissy","confident","sleepy","silly","confused"],a=e.preset==="twemoji32"?"32":"64";n.forEach(s=>{r.push({name:s,file:`${s}.png`,source:`preset:${e.preset}`,size:{width:parseInt(a),height:parseInt(a)}})})}else if(e.type==="custom"){const n=e.custom.images||{},a=e.custom.size||{width:64,height:64};Object.entries(n).forEach(([s,i])=>{if(i){const o=i.name?i.name.split(".").pop().toLowerCase():"png";r.push({name:s,file:`${s}.${o}`,source:i,size:{...a}})}}),r.find(s=>s.name==="neutral")||console.warn("Cảnh báo: chưa cung cấp emoji neutral, sẽ dùng ảnh mặc định")}return r}getSkinInfo(){if(!this.config||!this.config.theme||!this.config.theme.skin)return{};const e=this.config.theme.skin,r={};return e.light&&(r.light={text_color:e.light.textColor||"#000000",background_color:e.light.backgroundColor||"#ffffff"},e.light.backgroundType==="image"&&e.light.backgroundImage&&(r.light.background_image="background_light.raw")),e.dark&&(r.dark={text_color:e.dark.textColor||"#ffffff",background_color:e.dark.backgroundColor||"#121212"},e.dark.backgroundType==="image"&&e.dark.backgroundImage&&(r.dark.background_image="background_dark.raw")),r}generateIndexJson(){if(!this.config)throw new Error("Đối tượng cấu hình chưa được thiết lập");const e={version:1,chip_model:this.config.chip.model,display_config:{width:this.config.chip.display.width,height:this.config.chip.display.height,monochrome:!1,color:this.config.chip.display.color||"RGB565"}},r=this.getWakewordModelInfo();r&&(e.srmodels=r.filename);const n=this.getFontInfo();n&&(e.text_font=n.filename);const a=this.getSkinInfo();Object.keys(a).length>0&&(e.skin=a);const s=this.getEmojiCollectionInfo();return s.length>0&&(e.emoji_collection=s.map(i=>({name:i.name,file:i.file}))),e}preparePackageResources(){var i,o,l,c;const e={files:[],indexJson:this.generateIndexJson(),config:{...this.config}},r=this.getWakewordModelInfo();r&&r.name&&e.files.push({type:"wakeword",name:r.name,filename:r.filename,modelType:r.type});const n=this.getFontInfo();n&&e.files.push({type:"font",filename:n.filename,source:n.source,config:n.config||null}),this.getEmojiCollectionInfo().forEach(u=>{e.files.push({type:"emoji",name:u.name,filename:u.file,source:u.source,size:u.size})});const s=(o=(i=this.config)==null?void 0:i.theme)==null?void 0:o.skin;return((l=s==null?void 0:s.light)==null?void 0:l.backgroundType)==="image"&&s.light.backgroundImage&&e.files.push({type:"background",filename:"background_light.raw",source:s.light.backgroundImage,mode:"light"}),((c=s==null?void 0:s.dark)==null?void 0:c.backgroundType)==="image"&&s.dark.backgroundImage&&e.files.push({type:"background",filename:"background_dark.raw",source:s.dark.backgroundImage,mode:"dark"}),e}async preprocessCustomFonts(e=null){const r=this.getFontInfo();if(r&&r.type==="custom"&&!this.convertedFonts.has(r.filename)){e&&e(20,"Chuyển đổi font tùy chỉnh...");try{const n={fontFile:r.source,fontName:r.filename.replace(/\.bin$/,""),fontSize:r.config.size,bpp:r.config.bpp,charset:r.config.charset,symbols:r.config.symbols||"",range:r.config.range||"",compression:!1,progressCallback:(s,i)=>{e&&e(20+s*.2,`Chuyển đổi font: ${i}`)}};let a;if(await this.fontConverterBrowser.initialize(),a=await this.fontConverterBrowser.convertToCBIN(n),this.convertedFonts.set(r.filename,a),this.autoSaveEnabled){const s=`converted_font_${r.filename}`;try{await this.configStorage.saveTempData(s,a,"converted_font",{filename:r.filename,size:r.config.size,bpp:r.config.bpp,charset:r.config.charset}),console.log(`Font đã chuyển đổi đã được lưu vào storage: ${r.filename}`)}catch(i){console.warn(`Lưu font đã chuyển đổi thất bại: ${r.filename}`,i)}}}catch(n){throw console.error("Chuyển đổi font thất bại:",n),new Error(`Chuyển đổi font thất bại: ${n.message}`)}}}async generateAssetsBin(e=null){if(!this.config)throw new Error("Đối tượng cấu hình chưa được thiết lập");try{e&&e(0,"Bắt đầu tạo..."),await this.preprocessCustomFonts(e),await new Promise(a=>setTimeout(a,100)),e&&e(40,"Chuẩn bị file tài nguyên...");const r=this.preparePackageResources();this.wakenetPacker.clear(),this.spiffsGenerator.clear(),await this.processResourceFiles(r,e),await new Promise(a=>setTimeout(a,100)),e&&e(90,"Tạo file cuối cùng...");const n=await this.spiffsGenerator.generate((a,s)=>{e&&e(90+a*.1,s)});return e&&e(100,"Hoàn tất"),new Blob([n],{type:"application/octet-stream"})}catch(r){throw console.error("Tạo assets.bin thất bại:",r),r}}downloadAssetsBin(e,r="assets.bin"){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}async getFontInfoWithDetails(e=null){var r,n,a,s;try{const i=e||((s=(a=(n=(r=this.config)==null?void 0:r.theme)==null?void 0:n.font)==null?void 0:a.custom)==null?void 0:s.file);if(!i)return null;let o;return await this.fontConverterBrowser.initialize(),o=await this.fontConverterBrowser.getFontInfo(i),{...o,file:i,isCustom:!0}}catch(i){return console.error("Lấy thông tin chi tiết font thất bại:",i),null}}async estimateFontSize(e=null){var r,n,a;try{const s=e||((a=(n=(r=this.config)==null?void 0:r.theme)==null?void 0:n.font)==null?void 0:a.custom);if(!s)return null;const i={fontSize:s.size,bpp:s.bpp,charset:s.charset,symbols:s.symbols||"",range:s.range||""};let o;return o=this.fontConverterBrowser.estimateSize(i),o}catch(s){return console.error("Ước tính kích thước font thất bại:",s),null}}validateCustomFont(e){const r=[],n=[];return e.file?this.fontConverterBrowser.validateFont(e.file)||r.push("Định dạng file font không được hỗ trợ"):r.push("Thiếu file font"),(e.size<8||e.size>80)&&r.push("Kích thước font phải nằm trong khoảng 8-80"),[1,2,4,8].includes(e.bpp)||r.push("BPP phải là 1, 2, 4 hoặc 8"),!e.charset&&!e.symbols&&!e.range&&n.push("Chưa chỉ định charset, symbols hoặc range; sẽ dùng charset mặc định"),{valid:r.length===0,errors:r,warnings:n}}getConverterStatus(){return{initialized:this.fontConverterBrowser.initialized,supportedFormats:this.fontConverterBrowser.supportedFormats}}async processResourceFiles(e,r=null){let n=0;const a=e.files.length,s=new TextEncoder().encode(JSON.stringify(e.indexJson,null,2));console.log("index.json",e.indexJson),this.spiffsGenerator.addFile("index.json",s.buffer);for(const i of e.files){const o=40+n/a*40;r&&r(o,`Xử lý file: ${i.filename}`);try{await this.processResourceFile(i),n++}catch(l){throw console.error(`Xử lý file tài nguyên thất bại: ${i.filename}`,l),new Error(`Xử lý file tài nguyên thất bại: ${i.filename} - ${l.message}`)}}}async processResourceFile(e){switch(e.type){case"wakeword":await this.processWakewordModel(e);break;case"font":await this.processFontFile(e);break;case"emoji":await this.processEmojiFile(e);break;case"background":await this.processBackgroundFile(e);break;default:console.warn(`Loại tài nguyên không xác định: ${e.type}`)}}async processWakewordModel(e){if(!await this.wakenetPacker.loadModelFromShare(e.name))throw new Error(`Tải mô hình wakeword thất bại: ${e.name}`);const n=this.wakenetPacker.packModels();this.spiffsGenerator.addFile(e.filename,n)}async processFontFile(e){if(e.config){const r=this.convertedFonts.get(e.filename);if(r)this.spiffsGenerator.addFile(e.filename,r);else throw new Error(`Không tìm thấy font đã chuyển đổi: ${e.filename}`)}else{const r=await this.loadPresetFont(e.source);this.spiffsGenerator.addFile(e.filename,r)}}async processEmojiFile(e){var i,o;let r,n=!1,a="png",s=!1;if(typeof e.source=="string"&&e.source.startsWith("preset:")){const l=e.source.replace("preset:","");r=await this.loadPresetEmoji(l,e.name)}else{const l=e.source;s=this.isGifFile(l),a=l.name.split(".").pop().toLowerCase();try{const u=await this.getImageDimensions(l),f=e.size||{width:32,height:32};(u.width>f.width||u.height>f.height)&&(n=!0,console.log(`Emoji ${e.name} cần scale: ${u.width}x${u.height} -> ${f.width}x${f.height}`))}catch(u){console.warn(`Không thể lấy kích thước ảnh emoji: ${e.name}`,u)}n||(r=await this.fileToArrayBuffer(l))}if(n)try{const l=e.size||{width:32,height:32};if(s){console.log(`Dùng GifScaler xử lý GIF: ${e.name}`);const c=await this.gifScaler.scaleGif(e.source,{maxWidth:l.width,maxHeight:l.height,keepAspectRatio:!0});r=await this.fileToArrayBuffer(c)}else r=await this.scaleImageToFit(e.source,l,a)}catch(l){console.error(`Scale ảnh emoji thất bại: ${e.name}`,l),r=await this.fileToArrayBuffer(e.source)}this.spiffsGenerator.addFile(e.filename,r,{width:((i=e.size)==null?void 0:i.width)||0,height:((o=e.size)==null?void 0:o.height)||0})}async processBackgroundFile(e){const r=await this.fileToArrayBuffer(e.source),n=await this.convertImageToRgb565(r);this.spiffsGenerator.addFile(e.filename,n)}async loadPresetFont(e){try{const r=await fetch(`./static/fonts/${e}.bin`);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.arrayBuffer()}catch(r){throw new Error(`Tải font preset thất bại: ${e} - ${r.message}`)}}async loadPresetEmoji(e,r){try{const n=await fetch(`./static/${e}/${r}.png`);if(!n.ok)throw new Error(`HTTP ${n.status}`);return await n.arrayBuffer()}catch(n){throw new Error(`Tải emoji preset thất bại: ${e}/${r} - ${n.message}`)}}fileToArrayBuffer(e){return new Promise((r,n)=>{const a=new FileReader;a.onload=()=>r(a.result),a.onerror=()=>n(new Error("Đọc file thất bại")),a.readAsArrayBuffer(e)})}async scaleImageToFit(e,r,n="png"){return new Promise((a,s)=>{const i=e instanceof File?e:new Blob([e]),o=URL.createObjectURL(i),l=new Image;l.onload=()=>{try{const c=document.createElement("canvas"),u=c.getContext("2d");c.width=r.width,c.height=r.height;const f=l.width/l.height,h=r.width/r.height;let p,y,b,m;f>h?(p=r.width,y=r.width/f,b=0,m=(r.height-y)/2):(y=r.height,p=r.height*f,b=(r.width-p)/2,m=0),n==="png"?u.clearRect(0,0,c.width,c.height):(u.fillStyle="#FFFFFF",u.fillRect(0,0,c.width,c.height)),u.drawImage(l,b,m,p,y),c.toBlob(g=>{const w=new FileReader;w.onload=()=>a(w.result),w.onerror=()=>s(new Error("Chuyển đổi dữ liệu ảnh thất bại")),w.readAsArrayBuffer(g)},`image/${n}`),URL.revokeObjectURL(o)}catch(c){URL.revokeObjectURL(o),s(c)}},l.onerror=()=>{URL.revokeObjectURL(o),s(new Error("Không thể tải ảnh"))},l.src=o})}isGifFile(e){return e.type==="image/gif"?!0:e.name.split(".").pop().toLowerCase()==="gif"}async getImageDimensions(e){return new Promise((r,n)=>{const a=e instanceof File?e:new Blob([e]),s=URL.createObjectURL(a),i=new Image;i.onload=()=>{URL.revokeObjectURL(s),r({width:i.width,height:i.height})},i.onerror=()=>{URL.revokeObjectURL(s),n(new Error("Không thể lấy kích thước ảnh"))},i.src=s})}async convertImageToRgb565(e){return new Promise((r,n)=>{const a=new Blob([e]),s=URL.createObjectURL(a),i=new Image;i.onload=()=>{var o,l,c,u,f,h;try{const p=document.createElement("canvas"),y=p.getContext("2d",{willReadFrequently:!0});p.width=((c=(l=(o=this.config)==null?void 0:o.chip)==null?void 0:l.display)==null?void 0:c.width)||320,p.height=((h=(f=(u=this.config)==null?void 0:u.chip)==null?void 0:f.display)==null?void 0:h.height)||240;const b=i.width/i.height,m=p.width/p.height;let g,w,v,S;b>m?(w=p.height,g=p.height*b,v=(p.width-g)/2,S=0):(g=p.width,w=p.width/b,v=0,S=(p.height-w)/2),y.drawImage(i,v,S,g,w);const B=y.getImageData(0,0,p.width,p.height).data,L=new ArrayBuffer(p.width*p.height*2),O=new Uint16Array(L);for(let K=0;K<B.length;K+=4){const J=B[K]>>3,Oe=B[K+1]>>2,Pe=B[K+2]>>3;O[K/4]=J<<11|Oe<<5|Pe}const T=25,x=18,C=p.width*2,V=28,j=V+L.byteLength,z=new ArrayBuffer(j),q=new Uint8Array(z),Y=new DataView(z);let W=0;const I=0|x<<8|T;Y.setUint32(W,I,!0),W+=4;const E=p.height<<16|p.width;Y.setUint32(W,E,!0),W+=4;const G=0|C;Y.setUint32(W,G,!0),W+=4,Y.setUint32(W,L.byteLength,!0),W+=4,Y.setUint32(W,V,!0),W+=4,Y.setUint32(W,0,!0),W+=4,Y.setUint32(W,0,!0),W+=4,q.set(new Uint8Array(L),V),URL.revokeObjectURL(s),r(z)}catch(p){URL.revokeObjectURL(s),n(p)}},i.onerror=()=>{URL.revokeObjectURL(s),n(new Error("Không thể tải ảnh"))},i.src=s})}cleanup(){this.resources.clear(),this.tempFiles=[],this.convertedFonts.clear(),this.wakenetPacker.clear(),this.spiffsGenerator.clear(),this.gifScaler.dispose()}async clearAllStoredData(){try{await this.configStorage.clearAll(),this.cleanup(),console.log("Đã xóa toàn bộ dữ liệu lưu trữ")}catch(e){throw console.error("Xóa dữ liệu lưu trữ thất bại:",e),e}}async getStorageStatus(){try{const e=await this.configStorage.getStorageInfo();return{hasStoredData:await this.configStorage.hasStoredConfig(),storageInfo:e,autoSaveEnabled:this.autoSaveEnabled}}catch(e){return console.error("Lấy trạng thái storage thất bại:",e),{hasStoredData:!1,storageInfo:null,autoSaveEnabled:this.autoSaveEnabled}}}setAutoSave(e){this.autoSaveEnabled=e,console.log(`Tự động lưu đã ${e?"bật":"tắt"}`)}getResourceSummary(){const e=[],r=this.preparePackageResources(),n={wakeword:0,font:0,emoji:0,background:0};return r.files.forEach(a=>{n[a.type]=(n[a.type]||0)+1;let s="";switch(a.type){case"wakeword":s=`Mô hình wakeword: ${a.name} (${a.modelType})`;break;case"font":a.config?s=`Font tùy chỉnh: ${a.config.size}px, BPP ${a.config.bpp}`:s=`Font preset: ${a.source}`;break;case"emoji":s=`Emoji: ${a.name} (${a.size.width}x${a.size.height})`;break;case"background":s=`${a.mode==="light"?"Nền sáng":"Nền tối"} - ảnh nền`;break}e.push({type:a.type,filename:a.filename,description:s})}),{files:e,counts:n,totalFiles:e.length,indexJson:r.indexJson}}}const Kd={class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},Zd={class:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden"},Jd={class:"flex items-center justify-between p-6 border-b border-gray-200"},Qd={class:"p-6 overflow-y-auto",style:{"max-height":"calc(90vh - 140px)"}},ef={key:0,class:"space-y-6"},tf={class:"bg-gray-50 rounded-lg p-4 space-y-2 text-sm"},rf={class:"flex justify-between"},nf={class:"font-medium"},af={class:"flex justify-between"},sf={class:"font-medium"},of={class:"flex justify-between"},lf={class:"font-medium"},uf={class:"flex justify-between"},cf={class:"font-medium"},hf={class:"flex justify-between"},df={class:"font-medium"},ff={class:"space-y-2 max-h-64 overflow-y-auto"},pf={class:"flex items-center"},gf={class:"text-sm font-medium text-gray-900"},mf={class:"text-sm text-gray-700"},vf={key:0,class:"text-xs text-gray-500 ml-1"},yf={key:1,class:"space-y-6 text-center"},bf={class:"space-y-4"},xf={class:"bg-gray-200 rounded-full h-2 overflow-hidden"},wf={class:"text-sm text-gray-600"},kf={class:"mt-1"},Sf={class:"space-y-2 text-left"},Tf={class:"flex-shrink-0 mr-3"},Ff={key:0,class:"w-5 h-5 bg-green-500 rounded-full flex items-center justify-center"},Cf={key:1,class:"w-5 h-5 bg-primary-500 rounded-full animate-pulse"},_f={key:2,class:"w-5 h-5 bg-gray-300 rounded-full"},Ef={key:2,class:"text-center space-y-6"},Uf={class:"bg-green-50 border border-green-200 rounded-lg p-4"},Lf={class:"text-sm text-green-800 space-y-1"},Of={class:"space-y-3"},Bf=["disabled"],Rf={key:3,class:"space-y-6 text-center"},Af={class:"space-y-4"},If={class:"bg-gray-200 rounded-full h-2 overflow-hidden"},Df={class:"text-sm text-gray-600"},Mf={class:"mt-1"},Pf={class:"flex justify-end space-x-3 p-6 border-t border-gray-200"},Nf=["disabled"],Gf={__name:"GenerateModal",props:{config:{type:Object,required:!0}},emits:["close","generate","startFlash","cancelFlash"],setup(t,{emit:e}){const r=t,n=e,a=Z(!1),s=Z(!1),i=Z(0),o=Z(""),l=Z(""),c=Z(""),u=Z(null),f=Z(null),h=Z(!1),p=Z(!1),y=Z(0),b=Z(""),m=Z([{id:1,name:"Khởi tạo bộ tạo",status:"pending"},{id:2,name:"Xử lý tệp phông chữ",status:"pending"},{id:3,name:"Đóng gói mô hình từ đánh thức",status:"pending"},{id:4,name:"Xử lý ảnh biểu cảm",status:"pending"},{id:5,name:"Xử lý ảnh nền",status:"pending"},{id:6,name:"Tạo tệp chỉ mục",status:"pending"},{id:7,name:"Xây dựng ánh xạ SPIFFS",status:"pending"},{id:8,name:"Hoàn tất đóng gói",status:"pending"}]),g=Z([]),w=bt({render:()=>ce("svg",{fill:"currentColor",viewBox:"0 0 20 20"},[ce("path",{d:"M4 3a2 2 0 00-2 2v1a1 1 0 001 1h14a1 1 0 001-1V5a2 2 0 00-2-2H4zM3 8a1 1 0 011-1h12a1 1 0 011 1v5a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"})])}),v=bt({render:()=>ce("svg",{fill:"currentColor",viewBox:"0 0 20 20"},[ce("path",{"fill-rule":"evenodd",d:"M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z","clip-rule":"evenodd"})])}),S=bt({render:()=>ce("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[ce("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 4l8 16m-6-6h4"})])}),F=bt({render:()=>ce("svg",{fill:"currentColor",viewBox:"0 0 20 20"},[ce("path",{"fill-rule":"evenodd",d:"M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z","clip-rule":"evenodd"})])}),B=he(()=>g.value.length>0),L=()=>({wn9s_hilexin:"Hi, LeXin",wn9s_hiesp:"Hi, ESP",wn9s_nihaoxiaozhi:"Xin chào XiaoZhi",wn9_nihaoxiaozhi_tts:"Xin chào XiaoZhi",wn9_alexa:"Alexa"})[r.config.theme.wakeword]||r.config.theme.wakeword,O=()=>r.config.theme.font.type==="preset"?r.config.theme.font.preset.replace("font_","").replace("_"," "):"Phông chữ tùy chỉnh",T=()=>r.config.theme.emoji.type==="preset"&&r.config.theme.emoji.preset?r.config.theme.emoji.preset==="twemoji32"?"Twemoji 32×32":"Twemoji 64×64":r.config.theme.emoji.type==="custom"?"Gói biểu cảm tùy chỉnh":"Chưa cấu hình",x=()=>{if(g.value=[],g.value.push({id:"index",name:"index.json",description:"Tệp chỉ mục cấu hình",icon:w,iconColor:"text-blue-500",size:"1KB"}),r.config.theme.wakeword&&g.value.push({id:"srmodels",name:"srmodels.bin",description:"Mô hình từ đánh thức",icon:v,iconColor:"text-green-500",size:"~2.1MB"}),r.config.theme.font.type==="preset"){const I={font_puhui_deepseek_14_1:"180KB",font_puhui_deepseek_16_4:"720KB",font_puhui_deepseek_20_4:"1.1MB",font_puhui_deepseek_30_4:"2.5MB"};g.value.push({id:"font",name:`${r.config.theme.font.preset}.bin`,description:"Tệp phông chữ preset",icon:S,iconColor:"text-yellow-500",size:I[r.config.theme.font.preset]||"500KB"})}else if(r.config.theme.font.custom.file){const I=r.config.theme.font.custom,E=Math.max(100,I.size*I.size*I.bpp*.1);g.value.push({id:"font",name:`font_custom_${I.size}_${I.bpp}.bin`,description:"Tệp phông chữ tùy chỉnh",icon:S,iconColor:"text-yellow-500",size:E>1024?`${(E/1024).toFixed(1)}MB`:`${Math.round(E)}KB`,estimated:!0})}if(r.config.theme.emoji.type==="preset"&&r.config.theme.emoji.preset){const I=["neutral","happy","laughing","funny","sad","angry","crying","loving","embarrassed","surprised","shocked","thinking","winking","cool","relaxed","delicious","kissy","confident","sleepy","silly","confused"],E=r.config.theme.emoji.preset==="twemoji64"?"3KB":"1KB";I.forEach(G=>{g.value.push({id:`emoji_${G}`,name:`${G}.png`,description:`Ảnh biểu cảm: ${G}`,icon:F,iconColor:"text-pink-500",size:E})})}else Object.entries(r.config.theme.emoji.custom.images).forEach(([I,E])=>{const G=Math.round(E.size/1024);g.value.push({id:`emoji_${I}`,name:E.name,description:`Ảnh biểu cảm: ${I}`,icon:F,iconColor:"text-pink-500",size:G>1024?`${(G/1024).toFixed(1)}MB`:`${G}KB`})});if(r.config.theme.skin.light.backgroundType==="image"&&r.config.theme.skin.light.backgroundImage){const{width:I,height:E}=r.config.chip.display,G=Math.round(I*E*2/1024);g.value.push({id:"bg_light",name:"background_light.raw",description:"Hình nền chế độ sáng",icon:F,iconColor:"text-indigo-500",size:G>1024?`${(G/1024).toFixed(1)}MB`:`${G}KB`,estimated:!0})}if(r.config.theme.skin.dark.backgroundType==="image"&&r.config.theme.skin.dark.backgroundImage){const{width:I,height:E}=r.config.chip.display,G=Math.round(I*E*2/1024);g.value.push({id:"bg_dark",name:"background_dark.raw",description:"Hình nền chế độ tối",icon:F,iconColor:"text-indigo-500",size:G>1024?`${(G/1024).toFixed(1)}MB`:`${G}KB`,estimated:!0})}},C=I=>{if(I===0)return"0 B";const E=1024,G=["B","KB","MB","GB"],K=Math.floor(Math.log(I)/Math.log(E));return`${parseFloat((I/Math.pow(E,K)).toFixed(2))} ${G[K]}`},V=I=>{if(I<1e3)return`${I}ms`;if(I<6e4)return`${(I/1e3).toFixed(1)}s`;{const E=Math.floor(I/6e4),G=Math.floor(I%6e4/1e3);return`${E}m ${G}s`}},j=async()=>{a.value=!0,i.value=0,f.value=Date.now();try{const I=new ga;I.setConfig(r.config);const E=await I.generateAssetsBin((J,Oe)=>{i.value=parseInt(J),o.value=Oe;const Pe=Math.floor(J/(100/m.value.length));m.value.forEach((ee,fe)=>{fe<Pe?ee.status="completed":fe===Pe?ee.status="processing":ee.status="pending"})});a.value=!1,s.value=!0,l.value=C(E.size);const K=Date.now()-f.value;c.value=V(K),u.value=E,m.value.forEach(J=>{J.status="completed"}),n("generate",g.value.map(J=>({id:J.id,name:J.name})))}catch(I){console.error("Tạo assets.bin thất bại:",I),a.value=!1,s.value=!1,alert(`Tạo thất bại: ${I.message}`)}},z=()=>{if(u.value){const I=URL.createObjectURL(u.value),E=document.createElement("a");E.href=I,E.download="assets.bin",E.style.display="none",document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(I)}else console.error("Không có tệp để tải xuống")},q=async()=>{try{const E=new URLSearchParams(window.location.search).get("token");if(!E){h.value=!1;return}const G=await fetch("/api/messaging/device/tools/list",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E}`}});h.value=G.ok}catch(I){console.error("Kiểm tra trạng thái thiết bị thất bại:",I),h.value=!1}},Y=async()=>{if(!u.value){b.value="Lỗi: không có tệp để ghi";return}if(!h.value){b.value="Lỗi: thiết bị không trực tuyến, không thể ghi";return}p.value=!0,y.value=0,b.value="Chuẩn bị bắt đầu ghi...";try{n("startFlash",{blob:u.value,onProgress:(I,E)=>{y.value=I,b.value=E},onComplete:()=>{p.value=!1,y.value=100,b.value="Ghi hoàn tất!"},onError:I=>{p.value=!1,b.value=`Ghi thất bại: ${I}`}})}catch(I){p.value=!1,console.error("Khởi động ghi thất bại:",I),b.value=`Khởi động ghi thất bại: ${I.message}`}},W=()=>{confirm("Bạn có chắc muốn hủy ghi không?")&&(p.value=!1,y.value=0,b.value="",n("cancelFlash"))};return ir(async()=>{x(),await q()}),(I,E)=>(U(),R("div",Kd,[d("div",Zd,[d("div",Jd,[E[4]||(E[4]=d("h3",{class:"text-lg font-medium text-gray-900"},"Tạo assets.bin",-1)),d("button",{onClick:E[0]||(E[0]=G=>I.$emit("close")),class:"text-gray-400 hover:text-gray-500"},[...E[3]||(E[3]=[d("svg",{class:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),d("div",Qd,[!a.value&&!s.value?(U(),R("div",ef,[d("div",null,[E[10]||(E[10]=d("h4",{class:"font-medium text-gray-900 mb-3"},"Vui lòng xác nhận cấu hình của bạn",-1)),d("div",tf,[d("div",rf,[E[5]||(E[5]=d("span",{class:"text-gray-600"},"Mã chip:",-1)),d("span",nf,M(t.config.chip.model.toUpperCase()),1)]),d("div",af,[E[6]||(E[6]=d("span",{class:"text-gray-600"},"Độ phân giải:",-1)),d("span",sf,M(t.config.chip.display.width)+"×"+M(t.config.chip.display.height),1)]),d("div",of,[E[7]||(E[7]=d("span",{class:"text-gray-600"},"Từ đánh thức:",-1)),d("span",lf,M(L()),1)]),d("div",uf,[E[8]||(E[8]=d("span",{class:"text-gray-600"},"Phông chữ:",-1)),d("span",cf,M(O()),1)]),d("div",hf,[E[9]||(E[9]=d("span",{class:"text-gray-600"},"Gói biểu cảm:",-1)),d("span",df,M(T()),1)])])]),d("div",null,[E[11]||(E[11]=d("h4",{class:"font-medium text-gray-900 mb-3"},"Danh sách tập tin bao gồm",-1)),d("div",ff,[(U(!0),R(be,null,xe(g.value,G=>(U(),R("div",{key:G.id,class:"flex items-center justify-between px-3 py-2 border border-gray-200 rounded bg-gray-50"},[d("div",pf,[(U(),Ee(ln(G.icon),{class:te(["w-4 h-4 mr-2",G.iconColor])},null,8,["class"])),d("span",gf,M(G.name),1)]),d("div",mf,[He(M(G.size)+" ",1),G.estimated?(U(),R("span",vf,"Ước tính")):X("",!0)])]))),128))])])])):X("",!0),a.value?(U(),R("div",yf,[E[14]||(E[14]=d("div",{class:"flex items-center justify-center"},[d("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-primary-500"})],-1)),d("div",bf,[E[12]||(E[12]=d("p",{class:"text-gray-600 mt-2"},"Đang tạo assets.bin",-1)),d("div",xf,[d("div",{class:"bg-primary-500 h-2 rounded-full transition-all duration-500 ease-out",style:re({width:i.value+"%"})},null,4)]),d("div",wf,[d("div",null,M(o.value),1),d("div",kf,M(i.value)+"% hoàn thành",1)])]),d("div",Sf,[(U(!0),R(be,null,xe(m.value,G=>(U(),R("div",{key:G.id,class:"flex items-center text-sm"},[d("div",Tf,[G.status==="completed"?(U(),R("div",Ff,[...E[13]||(E[13]=[d("svg",{class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})],-1)])])):G.status==="processing"?(U(),R("div",Cf)):(U(),R("div",_f))]),d("span",{class:te([G.status==="completed"?"text-green-700":G.status==="processing"?"text-primary-700":"text-gray-500"])},M(G.name),3)]))),128))])])):X("",!0),s.value&&!p.value?(U(),R("div",Ef,[E[18]||(E[18]=d("div",{class:"mx-auto flex items-center justify-center"},[d("svg",{class:"w-20 h-20 text-green-600",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])],-1)),E[19]||(E[19]=d("div",null,[d("p",{class:"text-gray-600 mt-2"},"Tệp assets.bin của bạn đã sẵn sàng")],-1)),d("div",Uf,[d("div",Lf,[E[15]||(E[15]=d("div",null,"Tên tệp: assets.bin",-1)),d("div",null,"Kích thước tệp: "+M(l.value),1),d("div",null,"Thời gian tạo: "+M(c.value),1)])]),d("div",Of,[d("button",{onClick:z,class:"w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center"},[...E[16]||(E[16]=[d("svg",{class:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1),He(" Tải xuống assets.bin ",-1)])]),d("button",{onClick:Y,disabled:!h.value,class:"w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center"},[...E[17]||(E[17]=[d("svg",{class:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1),He(" Ghi trực tuyến lên thiết bị ",-1)])],8,Bf)])])):X("",!0),p.value?(U(),R("div",Rf,[E[21]||(E[21]=d("div",{class:"flex items-center justify-center"},[d("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"})],-1)),d("div",Af,[E[20]||(E[20]=d("p",{class:"text-gray-600"},"Đang ghi vào thiết bị",-1)),d("div",If,[d("div",{class:"bg-blue-500 h-2 rounded-full transition-all duration-500 ease-out",style:re({width:y.value+"%"})},null,4)]),d("div",Df,[d("div",null,M(b.value),1),d("div",Mf,M(y.value)+"% hoàn thành",1)])]),d("button",{onClick:W,class:"px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition-colors"}," Hủy ghi ")])):X("",!0)]),d("div",Pf,[!a.value&&!s.value?(U(),R("button",{key:0,onClick:E[1]||(E[1]=G=>I.$emit("close")),class:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"}," Hủy ")):X("",!0),!a.value&&!s.value?(U(),R("button",{key:1,onClick:j,disabled:!B.value,class:"px-6 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 rounded-md transition-colors"}," Bắt đầu tạo ",8,Nf)):X("",!0),s.value?(U(),R("button",{key:2,onClick:E[2]||(E[2]=G=>I.$emit("close")),class:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"}," Đóng ")):X("",!0)])])]))}};class zf{constructor(e){this.token=e,this.ws=null,this.isConnected=!1,this.isCancelled=!1,this.chunkSize=64*1024,this.onProgress=null,this.onError=null,this.onComplete=null,this.onDownloadUrlReady=null,this.onTransferStarted=null,this.currentSession=null,this.totalBytesSent=0,this.isSendingChunk=!1}async connect(){return new Promise((e,r)=>{try{const n=`wss://api.tenclass.net/transfer/?token=${encodeURIComponent(this.token)}`;this.ws=new WebSocket(n),this.ws.onopen=()=>{this.isConnected=!0,console.log("WebSocket connected to transfer server"),e()},this.ws.onmessage=a=>{this.handleMessage(a)},this.ws.onerror=a=>{console.error("WebSocket error:",a),this.isConnected=!1,r(new Error("Kết nối WebSocket thất bại"))},this.ws.onclose=a=>{console.log("WebSocket closed:",a.code,a.reason),this.isConnected=!1},setTimeout(()=>{this.isConnected||(this.ws.close(),r(new Error("Kết nối WebSocket quá thời gian")))},1e4)}catch(n){r(new Error(`Tạo kết nối WebSocket thất bại: ${n.message}`))}})}handleMessage(e){try{if(typeof e.data=="string"){const r=JSON.parse(e.data);switch(r.type){case"file_created":this.currentSession&&(this.currentSession.url=r.url,this.onDownloadUrlReady&&this.onDownloadUrlReady(r.url));break;case"transfer_started":this.currentSession&&(this.currentSession.transferStarted=!0,this.onTransferStarted&&this.onTransferStarted(),this.currentSession.transferReady&&this.sendFileData());break;case"ack":if(this.currentSession){const{blob:n}=this.currentSession,a=n.size,s=r.bytesSent;if(s<0){console.error("Invalid server bytesSent (negative):",s),this.isSendingChunk=!1,this.onError&&this.onError(new Error("Máy chủ trả về số byte không hợp lệ"));return}if(s>a){console.error(`Server bytesSent (${s}) exceeds fileSize (${a})`),this.isSendingChunk=!1,this.onError&&this.onError(new Error("Số byte do máy chủ báo lớn hơn kích thước tệp"));return}this.isSendingChunk=!1,s>this.currentSession.bytesSent&&(this.currentSession.bytesSent=s),this.sendFileData()}break;case"transfer_completed":if(this.currentSession){const n=this.currentSession.blob.size;this.totalBytesSent!==n&&console.warn(`Kích thước truyền không khớp: đã gửi ${this.totalBytesSent} byte, dự kiến ${n} byte`)}this.onComplete&&this.onComplete();break;case"error":console.error("Transfer error:",r.message),this.onError&&this.onError(new Error(r.message));break}}}catch(r){console.error("Lỗi khi xử lý tin nhắn:",r),this.onError&&this.onError(r)}}async sendFileData(){if(this.isSendingChunk||!this.currentSession||this.isCancelled)return;const{blob:e}=this.currentSession,r=e.size;let n=this.currentSession.bytesSent;if(n>=r){this.onProgress&&this.onProgress(100,"Truyền xong, đang chờ thiết bị xác nhận...");return}if(this.isSendingChunk=!0,n>r){console.error(`Critical error: bytesSent (${n}) exceeds fileSize (${r})`),this.onError&&this.onError(new Error("Số byte truyền vượt quá kích thước tệp"));return}const a=Math.max(0,r-n),s=Math.min(this.chunkSize,a);if(s<=0)return;const i=e.slice(n,n+s);try{const o=await new Promise((f,h)=>{const p=new FileReader;p.onload=()=>f(p.result),p.onerror=()=>h(new Error("读取文件失败")),p.readAsArrayBuffer(i)});if(this.isCancelled)return;this.ws.send(o);const l=n+s;if(this.currentSession.bytesSent=l,this.totalBytesSent+=s,l>r){console.error(`Critical error: bytesSent (${l}) exceeds fileSize (${r})`),this.onError&&this.onError(new Error("Số byte truyền vượt quá kích thước tệp"));return}if(this.totalBytesSent>r){console.error(`Critical error: totalBytesSent (${this.totalBytesSent}) exceeds fileSize (${r})`),this.onError&&this.onError(new Error("Tổng số byte đã gửi vượt quá kích thước tệp"));return}const c=Math.round(l/r*60)+40,u=`Đang truyền... ${Math.round(l/1024)}KB / ${Math.round(r/1024)}KB`;this.onProgress&&this.onProgress(c,u)}catch(o){console.error("Lỗi khi gửi chunk tệp:",o),this.isSendingChunk=!1,this.onError&&this.onError(o)}}async initializeSession(e,r,n,a){return new Promise((s,i)=>{this.onProgress=r,this.onError=o=>{n&&n(o),i(o)},this.onDownloadUrlReady=o=>{a&&a(o),s(o)},this.isCancelled=!1;try{this.onProgress&&this.onProgress(5,"Đang kết nối tới server truyền..."),this.connect().then(()=>{this.onProgress&&this.onProgress(10,"Đang tạo phiên tệp...");const o={type:"create_file",fileName:"assets.bin",fileSize:e.size};this.ws.send(JSON.stringify(o)),this.currentSession={blob:e,bytesSent:0,fileSize:e.size,transferStarted:!1,transferReady:!0},this.totalBytesSent=0}).catch(o=>{console.error("Transfer initialization failed:",o),this.onError&&this.onError(o)})}catch(o){console.error("Transfer initialization failed:",o),this.onError&&this.onError(o)}})}async startTransfer(e,r,n){return new Promise((a,s)=>{if(this.onProgress=e,this.onError=i=>{this.isSendingChunk=!1,r&&r(i),s(i)},this.onComplete=()=>{this.isSendingChunk=!1,n&&n(),a()},!this.currentSession||!this.currentSession.blob){const i=new Error("Phiên truyền chưa được khởi tạo");this.onError&&this.onError(i),s(i);return}this.currentSession.transferReady=!0,this.currentSession.transferStarted&&this.sendFileData()})}async transferFile(e,r,n,a,s){if(s){await this.initializeSession(e,r,n,s);return}this.onProgress=r,this.onError=n,this.onComplete=a,this.isCancelled=!1;try{this.onProgress&&this.onProgress(5,"Đang kết nối tới server truyền..."),await this.connect(),this.onProgress&&this.onProgress(10,"Đang tạo phiên tệp...");const i={type:"create_file",fileName:"assets.bin",fileSize:e.size};this.ws.send(JSON.stringify(i)),this.currentSession={blob:e,bytesSent:0,fileSize:e.size,transferStarted:!1,transferReady:!0}}catch(i){console.error("Transfer initialization failed:",i),this.onError&&this.onError(i)}}cancel(){this.isCancelled=!0,this.isSendingChunk=!1,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close()}destroy(){this.cancel(),this.onProgress=null,this.onError=null,this.onComplete=null,this.onDownloadUrlReady=null,this.onTransferStarted=null,this.totalBytesSent=0,this.isSendingChunk=!1}}const Vf={class:"flex items-center justify-center mb-8"},$f={class:"flex flex-col items-center"},Hf={class:"text-sm mt-2 text-gray-600"},jf={key:0,class:"w-16 h-0.5 bg-gray-300 mx-4"},Wf={class:"bg-white rounded-lg shadow-sm border p-6"},qf={__name:"HomePage",setup(t){const e=Z(0),r=Z(!1),n=Z("wakeword"),a=Z(!1),s=Z(!1),i=Z(!1),o=Z(!0),l=new ga,c=Z(null),u=Z(null),f=[{title:"Cấu hình chip",key:"chip"},{title:"Thiết kế giao diện",key:"theme"},{title:"Xem trước hiệu ứng",key:"generate"}],h=Z({chip:{model:"",display:{width:320,height:240,color:"RGB565"},preset:""},theme:{wakeword:"",font:{type:"preset",preset:"font_puhui_deepseek_20_4",custom:{file:null,size:20,bpp:4,charset:"deepseek"}},emoji:{type:"",preset:"",custom:{size:{width:160,height:120},format:"png",images:{}}},skin:{light:{backgroundType:"color",backgroundColor:"#ffffff",textColor:"#000000",backgroundImage:null},dark:{backgroundType:"color",backgroundColor:"#121212",textColor:"#ffffff",backgroundImage:null}}}});he(()=>h.value.chip.model&&(h.value.theme.font.preset||h.value.theme.font.custom.file));const p=V=>V<e.value?"step-indicator completed":V===e.value?"step-indicator active":"step-indicator inactive",y=async()=>{e.value<f.length-1&&(e.value++,s.value||(s.value=!0,await O()))},b=()=>{e.value>0&&e.value--},m=()=>{r.value=!0},g=async V=>{},w=()=>new URLSearchParams(window.location.search).get("token"),v=async(V,j={})=>{try{const z=w();if(!z)throw new Error("Không tìm thấy token xác thực");const q=await fetch("/api/messaging/device/tools/call",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`},body:JSON.stringify({name:V,arguments:j})});if(q.ok)return await q.json();{const Y=await q.text();throw new Error(`Gọi ${V} thất bại: ${q.status} - ${Y}`)}}catch(z){throw console.error(`Gọi công cụ MCP ${V} thất bại:`,z.message),z}},S=async V=>{const{blob:j,onProgress:z,onComplete:q,onError:Y}=V;try{const W=w();if(!W)throw new Error("Không tìm thấy token xác thực");z(5,"Đang kiểm tra trạng thái thiết bị...");const I=await v("self.get_device_status");z(15,"Đang khởi tạo dịch vụ truyền..."),u.value=new zf(W);let E=null;const G=new Promise((ee,fe)=>{E=ee});let K=null;const J=new Promise((ee,fe)=>{K=ee});u.value.onTransferStarted=()=>{K&&(K(),K=null)},await u.value.initializeSession(j,(ee,fe)=>{z(15+ee*.75,fe)},ee=>{console.error("Khởi tạo WebSocket thất bại:",ee),Y("Khởi tạo dịch vụ truyền thất bại: "+ee.message)},ee=>{E(ee)});const Oe=await G;z(30,"Đang đặt URL tải xuống thiết bị..."),await v("self.assets.set_download_url",{url:Oe}),z(40,"Đang khởi động lại thiết bị..."),v("self.reboot").catch(ee=>{console.warn("Cảnh báo gọi lệnh reboot (thiết bị có thể đã khởi động lại):",ee)}),z(50,"Đang đợi thiết bị khởi động lại...");const Pe=new Promise((ee,fe)=>{setTimeout(()=>fe(new Error("Thời gian chờ thiết bị khởi động lại (60 giây)")),6e4)});await Promise.race([J,Pe]),z(60,"Đang bắt đầu truyền tệp..."),await u.value.startTransfer((ee,fe)=>{const vt=60+ee*.4;z(Math.round(vt),fe)},ee=>{Y(ee.message)},()=>{q()}),u.value.onTransferStarted=null}catch(W){console.error("Nạp trực tuyến thất bại:",W),Y(W.message)}},F=()=>{u.value&&(u.value.cancel(),u.value.destroy(),u.value=null)},B=V=>{n.value=V},L=async()=>{var V,j,z,q;try{o.value=!0;const Y=await de.loadConfig();if(Y){h.value=Y.config,e.value=Y.currentStep,n.value=Y.activeThemeTab,a.value=!0,s.value=!0,c.value&&clearTimeout(c.value),c.value=setTimeout(()=>{a.value=!1},5e3),l.setConfig(h.value,{strict:!1}),await l.restoreAllResourcesFromStorage(h.value);try{const W=((q=(z=(j=(V=h.value)==null?void 0:V.theme)==null?void 0:j.emoji)==null?void 0:z.custom)==null?void 0:q.images)||{};h.value={...h.value,theme:{...h.value.theme,emoji:{...h.value.theme.emoji,custom:{...h.value.theme.emoji.custom,images:{...W}}}}}}catch{}}else a.value=!1,s.value=!1}catch(Y){console.error("Tải cấu hình thất bại:",Y),a.value=!1,s.value=!1}finally{o.value=!1}},O=async()=>{try{await de.saveConfig(h.value,e.value,n.value)}catch(V){console.error("Lưu cấu hình thất bại:",V)}},T=async()=>{try{i.value=!0,await l.clearAllStoredData(),h.value={chip:{model:"",display:{width:320,height:240,color:"RGB565"},preset:""},theme:{wakeword:"",font:{type:"preset",preset:"font_puhui_deepseek_20_4",custom:{file:null,size:20,bpp:4,charset:"deepseek"}},emoji:{type:"",preset:"",custom:{size:{width:64,height:64},format:"png",images:{}}},skin:{light:{backgroundType:"color",backgroundColor:"#ffffff",textColor:"#000000",backgroundImage:null},dark:{backgroundType:"color",backgroundColor:"#121212",textColor:"#ffffff",backgroundImage:null}}}},e.value=0,n.value="wakeword",a.value=!1,s.value=!1}catch(V){console.error("Đặt lại cấu hình thất bại:",V),alert("Đặt lại thất bại, vui lòng làm mới trang và thử lại")}finally{i.value=!1}};Re(h,async V=>{!o.value&&s.value&&await O()},{deep:!0}),Re(e,async()=>{!o.value&&s.value&&await O()}),Re(n,async()=>{!o.value&&s.value&&await O()}),ir(async()=>{await de.initialize(),await L()}),un(()=>{c.value&&clearTimeout(c.value)});const x=()=>{a.value=!1,c.value&&clearTimeout(c.value)},C=()=>{c.value&&clearTimeout(c.value),c.value=setTimeout(()=>{a.value=!1},5e3)};return(V,j)=>(U(),R("div",null,[a.value?(U(),R("div",{key:0,class:"fixed bottom-4 right-4 z-50 bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-lg transition-opacity duration-300 min-w-[300px]",onMouseenter:C},[d("div",{class:"flex items-center justify-between mb-2"},[j[4]||(j[4]=d("div",{class:"flex items-center"},[d("svg",{class:"w-5 h-5 text-blue-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20"},[d("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})]),d("span",{class:"text-blue-800 font-medium"},"Phát hiện cấu hình đã lưu")],-1)),d("button",{onClick:x,class:"text-gray-500 hover:text-gray-700"},[...j[3]||(j[3]=[d("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),j[5]||(j[5]=d("p",{class:"text-blue-600 text-sm mb-3"}," Cấu hình đã được khôi phục tự động, bạn có thể tiếp tục tiến độ trước đó hoặc bắt đầu lại ",-1)),d("div",{class:"flex justify-end space-x-2"},[d("button",{onClick:T,class:"px-3 py-1 text-sm text-red-600 hover:text-red-800 font-medium"}," Bắt đầu lại ")])],32)):X("",!0),d("div",Vf,[(U(),R(be,null,xe(f,(z,q)=>d("div",{key:q,class:"flex items-center"},[d("div",$f,[d("div",{class:te(p(q))},M(q+1),3),d("span",Hf,M(z.title),1)]),q<f.length-1?(U(),R("div",jf)):X("",!0)])),64))]),d("div",Wf,[e.value===0?(U(),Ee(Da,{key:0,modelValue:h.value.chip,"onUpdate:modelValue":j[0]||(j[0]=z=>h.value.chip=z),onNext:y},null,8,["modelValue"])):X("",!0),e.value===1?(U(),Ee(Qi,{key:1,modelValue:h.value.theme,"onUpdate:modelValue":j[1]||(j[1]=z=>h.value.theme=z),chipModel:h.value.chip.model,activeTab:n.value,onNext:y,onPrev:b,onTabChange:B},null,8,["modelValue","chipModel","activeTab"])):X("",!0),e.value===2?(U(),Ee(Ro,{key:2,config:h.value,onGenerate:m,onPrev:b},null,8,["config"])):X("",!0)]),r.value?(U(),Ee(Gf,{key:1,config:h.value,onClose:j[2]||(j[2]=z=>r.value=!1),onGenerate:g,onStartFlash:S,onCancelFlash:F},null,8,["config"])):X("",!0)]))}};export{qf as default};
